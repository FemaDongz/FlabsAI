<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FlabsAI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
      // Synchronous script for immediate dark mode check for loading screen
      (function() {
        try {
          let useDarkMode = false;
          const storedDarkMode = localStorage.getItem('darkMode');
          if (storedDarkMode === 'true') {
            useDarkMode = true;
          } else if (storedDarkMode === null && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            useDarkMode = true;
          }
          if (useDarkMode) {
            document.documentElement.classList.add('dark-mode-loading-init');
            document.body.style.backgroundColor = '#18191a'; // Initial dark background for body
          } else {
            document.body.style.backgroundColor = 'white'; // Initial light background for body
          }
        } catch (e) { console.warn('Could not access localStorage for loading screen dark mode check.'); }
      })();
    </script>
    <style>
        /* Initial loading screen dark mode styles (if dark-mode-loading-init is on <html>) */
        html.dark-mode-loading-init #loading-overlay {
            background-color: #18191a !important;
        }
        html.dark-mode-loading-init #loading-text {
            color: #e4e6eb !important;
        }
        html.dark-mode-loading-init .shard {
            background-color: #b0b3b8 !important;
        }
        
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: var(--font-primary, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif); 
            background-color: var(--bg-color, white);
            color: var(--text-color, #050505); 
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white; 
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 1.2s cubic-bezier(0.55, 0.055, 0.675, 0.19), background-color 0.3s;
            box-shadow: 0 1px 4px 4px rgba(0,0,0,0.4);
        }
        #animation-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 450px;
            height: 120px;
            z-index: 100;
        }
        #loading-logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.3);
            width: 80px;
            opacity: 0;
            transition: opacity 0.8s cubic-bezier(0.25, 0.1, 0.25, 1),
                        transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1),
                        width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1),
                        left 0.667s cubic-bezier(0.42, 0, 0.58, 1);
            z-index: 5;
            border-radius: 50%;
            object-fit: cover;
        }
        #shards-container {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1px;
            height: 1px;
            transform: translate(-50%, -50%);
            z-index: 4;
        }
        .shard {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #333;
            border-radius: 1.5px;
            opacity: 0;
            transform-origin: center center;
        }
        #loading-text-container {
            position: absolute;
            opacity: 0;
            transform: translateY(-50%);
            top: 50%;
            transition: opacity 0.4s ease-in-out;
            z-index: 5;
            white-space: nowrap;
        }
        #loading-text {
            font-size: 2.5em;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
        }
        .char-animated {
            display: inline-block;
            opacity: 0;
            transform: translateY(12px);
            transition: opacity 0.33s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                        transform 0.33s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            margin-right: 0.5px;
        }
        .char-animated.visible {
            opacity: 1;
            transform: translateY(0px);
        }

        :root {
          --bg-color: #f0f2f5;
          --surface-color: #ffffff;
          --text-color: #050505;
          --secondary-text-color: #55585e;
          --input-bg-color: #e4e6eb;
          --input-text-color: #050505;
          --button-bg-color: #1877f2;
          --button-text-color: #ffffff;
          --user-message-bg: #1877f2;
          --user-message-text: #ffffff;
          --ai-message-bg: #e4e6eb;
          --ai-message-text: #050505;
          --border-color: #ced0d4;
          --grid-line-color: rgba(0, 0, 0, 0.05);
          --scrollbar-thumb-color: #bcc0c4;
          --scrollbar-track-color: #e4e6eb;
          --header-height: 60px;
          --input-area-default-height: 60px;
          --font-primary: 'Inter', Arial, sans-serif;
          --deepthink-active-color: #ffc107;
          --deepthink-active-bg: #fff8e1;
          --imageai-control-active-color: var(--button-bg-color);
          --imageai-control-active-bg: #e7f3ff;
          --stop-button-bg-color: #dc3545;
          --stop-button-hover-bg-color: #c82333;
          --stop-spinner-effective-color: #333333; 
          --download-button-bg-color: #28a745;
          --download-button-hover-bg-color: #218838;
          --system-info-bg: #e7f3ff;
          --system-info-text: #00529b;
          --system-info-border: #b8daff;
          --header-icon-button-bg: transparent;
          --dialog-overlay-bg: rgba(0,0,0,0.65);
          --dialog-button-primary-bg: var(--button-bg-color);
          --dialog-button-secondary-bg: #6c757d;
          --dialog-button-danger-bg: var(--stop-button-bg-color);
          --floating-btn-solid-bg: var(--surface-color);
          --floating-btn-shadow: 0 2px 8px rgba(0,0,0,0.2);
          --tools-panel-bg: var(--surface-color);
          --top-elements-height: 44px;
          --ai-generated-image-bg: var(--surface-color);
          --pollinations-image-container-bg: var(--surface-color);
          --model-switcher-bg: var(--input-bg-color);
          --model-switcher-hover-bg: #d8dadf;
          --model-switcher-dropdown-shadow: 0 2px 8px rgba(0,0,0,0.15);
          --icon-fill-color: var(--secondary-text-color);
          --ocr-preview-bg: var(--input-bg-color);
          --progress-bar-container-bg: #e9ecef;
          --progress-bar-fill-color: var(--button-bg-color);
          --artifact-header-btn-bg: rgba(0,0,0,0.05);
          --artifact-header-btn-hover-bg: rgba(0,0,0,0.1);
          --modal-header-bg: var(--surface-color);
          --modal-actions-bar-bg: var(--surface-color);


          --safe-area-inset-top: env(safe-area-inset-top, 0px);
          --safe-area-inset-right: env(safe-area-inset-right, 0px);
          --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
          --safe-area-inset-left: env(safe-area-inset-left, 0px);

          --solid-surface-light: #ffffff;
          --solid-hover-light: #f0f2f5;
          --solid-surface-dark: #242526;
          --solid-hover-dark: #3a3b3c;
        }

        body.dark-mode {
          --bg-color: #18191a;
          --surface-color: #242526;
          --text-color: #e4e6eb;
          --secondary-text-color: #b0b3b8;
          --input-bg-color: #3a3b3c;
          --input-text-color: #e4e6eb;
          --user-message-bg: #0084ff;
          --user-message-text: #ffffff;
          --ai-message-bg: #3a3b3c;
          --ai-message-text: #e4e6eb;
          --border-color: #393a3b;
          --grid-line-color: rgba(255, 255, 255, 0.05);
          --scrollbar-thumb-color: #55585e;
          --scrollbar-track-color: #3a3b3c;
          --deepthink-active-bg: #4a4128;
          --imageai-control-active-bg: #303d4f;
          --system-info-bg: #2c3e50;
          --system-info-text: #bdc3c7;
          --system-info-border: #34495e;
          --dialog-overlay-bg: rgba(0,0,0,0.75);
          --floating-btn-solid-bg: var(--surface-color);
          --tools-panel-bg: var(--surface-color);
          --ai-generated-image-bg: var(--surface-color);
          --pollinations-image-container-bg: var(--surface-color);
          --model-switcher-bg: #303132;
          --model-switcher-hover-bg: #3f4041;
          --model-switcher-dropdown-shadow: 0 2px 8px rgba(0,0,0,0.3);
          --icon-fill-color: var(--secondary-text-color);
          --progress-bar-container-bg: #3a3b3c;
          --artifact-header-btn-bg: rgba(255,255,255,0.08);
          --artifact-header-btn-hover-bg: rgba(255,255,255,0.15);
          --modal-header-bg: var(--surface-color);
          --modal-actions-bar-bg: var(--surface-color);
          --stop-spinner-effective-color: var(--button-text-color); 
        }

        * { box-sizing: border-box; }

        #app-layout-container {
            width:100%;
            height:100%;
            display:flex;
            flex-direction:column;
            overflow: hidden; 
            transition: filter 0.3s ease-in-out;
        }

        body.modal-open-blur > #app-layout-container { 
            filter: blur(4px);
            user-select: none;
            pointer-events: none; 
        }


        #sidebar {
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background-color: var(--solid-surface-light);
          backdrop-filter: blur(10px) saturate(180%);
          -webkit-backdrop-filter: blur(10px) saturate(180%);
          z-index: 3000; opacity: 0; visibility: hidden;
          transition: opacity 0.3s ease-in-out, visibility 0s linear 0.3s, background-color 0.3s;
          display: flex; flex-direction: column; color: var(--text-color);
          box-shadow: 0 1px 1px 1px rgba(0,0,0,0.1);
          padding-bottom: var(--safe-area-inset-bottom);
        }
        body.dark-mode #sidebar {
            background-color: var(--solid-surface-dark);
            box-shadow: 0 1px 1px 1px rgba(0,0,0,0.3);
        }
        #sidebar.open { opacity: 1; visibility: visible; transition: opacity 0.3s ease-in-out, visibility 0s linear 0s; } 
        .sidebar-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; height: var(--header-height); flex-shrink: 0;
            padding-top: var(--safe-area-inset-top);
        }
        .sidebar-logo-title { display: flex; align-items: center;}
        .sidebar-logo-title .logo { background-color: var(--text-color); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow:hidden; margin-right:12px;box-shadow: 0 1px 3px rgba(0,0,0,0.2);}
        .sidebar-logo-title .logo img{ width:100%; height:100%; object-fit:cover;}
        .sidebar-logo-title h2 { font-size: 1.1em; font-weight: 600;}
        #close-sidebar-btn { background: none; border: none; cursor: pointer; padding: 8px; }
        #close-sidebar-btn svg { width: 28px; height: 28px; fill: var(--text-color); }
        .sidebar-content { padding: 20px; flex-grow: 1; overflow-y: auto; }
        .sidebar-content ul { list-style: none; margin: 0; padding: 0; }
        .sidebar-content ul li a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px; margin-bottom: 8px; border-radius: 8px;
            color: var(--text-color); text-decoration: none; font-size: 1em; font-weight: 500;
            transition: background-color 0.2s;
        }
        .sidebar-content ul li a svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
            flex-shrink: 0;
        }
        .sidebar-content ul li a:hover {
            background-color: var(--solid-hover-light);
        }
        body.dark-mode .sidebar-content ul li a:hover {
            background-color: var(--solid-hover-dark);
        }
        .sidebar-content .category-title {
            font-size: 0.8em; text-transform: uppercase; color: var(--secondary-text-color);
            margin-top: 20px; margin-bottom: 10px; padding-left: 15px; font-weight: 600;
        }
        .sidebar-content .category-title:first-of-type { margin-top: 0;}
        .sidebar-footer {
            padding: 15px 20px; text-align: center; font-size: 0.8em;
            color: var(--secondary-text-color); border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }


        #app-title {
            position: fixed;
            top: calc(15px + var(--safe-area-inset-top));
            left: 50%;
            z-index: 1004;
            margin: 0;
            font-size: 1em;
            font-weight: 600;
            color: var(--text-color);
            background-color: var(--surface-color);
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 0 15px;
            height: var(--top-elements-height);
            line-height: var(--top-elements-height);
            white-space: nowrap;
            text-align: center;
            pointer-events: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateX(-50%) translateY(-150%);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0s linear 0.3s, background-color 0.3s, color 0.3s, box-shadow 0.3s;
        }
        #app-title.visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
            transition-delay: 0s;
        }

        .floating-control-btn {
            position: fixed;
            z-index: 1010;
            background-color: var(--floating-btn-solid-bg);
            border: 1px solid var(--border-color);
            box-shadow: var(--floating-btn-shadow);
            width: 44px; height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s, opacity 0.2s, border-color 0.2s;
            padding: 0;
            color: var(--secondary-text-color);
        }
        .floating-control-btn:hover {
            background-color: var(--input-bg-color);
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }
        .floating-control-btn:disabled {
             opacity: 0.5; cursor: not-allowed !important;
             background-color: var(--input-bg-color) !important;
             box-shadow: none !important;
             color: var(--secondary-text-color) !important;
        }
        .floating-control-btn svg {
            width: 24px; height: 24px; fill: currentColor;
        }
        #menu-toggle-floating {
            top: calc(15px + var(--safe-area-inset-top));
            left: calc(15px + var(--safe-area-inset-left));
        }
        #toggle-tools-panel-btn {
            top: calc(15px + var(--safe-area-inset-top));
            right: calc(15px + var(--safe-area-inset-right));
        }

        #tools-panel {
            position: fixed;
            top: calc(15px + var(--safe-area-inset-top));
            left: 50%;
            transform: translateX(-50%) translateY(-150%);
            background-color: var(--tools-panel-bg);
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 2px 10px;
            height: var(--top-elements-height);
            z-index: 1005;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0s linear 0.3s, background-color 0.3s, box-shadow 0.3s;
        }
        #tools-panel.visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
            transition-delay: 0s;
        }
        #tools-panel .header-icon-btn {
            color: var(--button-text-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            border: none;
            width: 38px; height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        #tools-panel .header-icon-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }
        #download-chat-btn { background-color: var(--download-button-bg-color); }
        #download-chat-btn:hover:not(:disabled) { background-color: var(--download-button-hover-bg-color); box-shadow: 0 2px 5px rgba(0,0,0,0.3);}
        #reset-role-btn { background-color: var(--stop-button-bg-color); }
        #reset-role-btn:hover:not(:disabled) { background-color: var(--stop-button-hover-bg-color); box-shadow: 0 2px 5px rgba(0,0,0,0.3);}
        #dark-mode-toggle-btn { background-color: #6c757d; }
        #dark-mode-toggle-btn:hover:not(:disabled) { background-color: #5a6268; box-shadow: 0 2px 5px rgba(0,0,0,0.3);}


        #chat-container {
          flex-grow: 1; width: 100%; max-width: 800px; margin: 0 auto;
          padding: calc(15px + var(--safe-area-inset-top) + var(--top-elements-height) + 15px) 15px 10px 15px;
          overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column;
          gap: 12px; will-change: scroll-position; background-color: transparent;
          mask-image: linear-gradient(to bottom, transparent 0%, black 150px);
          -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 150px);
          transition: padding-bottom 0.3s ease-out;
        }
        #chat-container::-webkit-scrollbar { width: 7px; }
        #chat-container::-webkit-scrollbar-track { background: var(--scrollbar-track-color); }
        #chat-container::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb-color); border-radius: 4px; }

        .message {
          display: flex; max-width: 100%; align-items: flex-end;
          position: relative; margin-bottom: 25px;
        }
        .message-content {
          padding: 10px 15px; border-radius: 20px; line-height: 1.5; font-size: 0.9rem;
          box-shadow: 0 1px 2px rgba(0,0,0,0.15);
          word-wrap: break-word; overflow-wrap: break-word; max-width: 100%;
          transition: background-color 0.3s, color 0.3s;
          color: var(--ai-message-text); 
        }
        .message-content p { margin: 0 0 8px 0; } .message-content p:last-child { margin-bottom: 0; }
        .message-content ul, .message-content ol { margin: 8px 0 8px 20px; padding-left: 15px; }
        .message-content li { margin-bottom: 4px; }
        .message-content b, .message-content strong { font-weight: 600; }
        .message-content a { color: var(--user-message-bg); text-decoration: none; font-weight: 500;}
        body.dark-mode .message-content a { color: var(--button-bg-color); }
        .message-content a:hover { text-decoration: underline; }
        .message-content small i, .message-content .stopped-text, .message-content .fetching-text {
            font-size: 0.85em; color: var(--secondary-text-color);
        }
        .image-process-progress-bar-container {
            width: 100%;
            background-color: var(--progress-bar-container-bg);
            border-radius: 6px;
            overflow: hidden;
            height: 18px;
            margin-top: 8px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .image-process-progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--progress-bar-fill-color);
            text-align: center;
            line-height: 18px;
            color: white;
            border-radius: 6px 0 0 6px;
            transition: width 0.25s ease-in-out;
            font-size: 0.75em;
        }
        .image-process-status-text {
            font-size: 0.8em;
            color: var(--secondary-text-color);
            margin-top: 4px;
            text-align: center;
        }
        .pollinations-image-display-container .thinking-loader { 
            padding: 20px 0;
            margin-top: 8px;
            margin-bottom: 8px;
        }


        .user-sent-attachment-display {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            background-color: rgba(0,0,0,0.05);
            padding: 6px 10px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.85em;
            max-width: 100%;
        }
        body.dark-mode .user-sent-attachment-display {
            background-color: rgba(255,255,255,0.05);
        }
        .user-sent-attachment-display .user-bubble-attachment-preview-container {
            width: 48px;
            height: 48px;
            flex-shrink: 0;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg-color);
        }
        .user-sent-attachment-display .user-bubble-attachment-preview-container img.attachment-image-preview,
        .user-sent-attachment-display .user-bubble-attachment-preview-container svg {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .user-sent-attachment-display .user-bubble-attachment-preview-container svg {
            padding: 4px;
            object-fit: contain;
            fill: var(--icon-fill-color);
        }
        .user-sent-attachment-display .attachment-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }


        .user-message { align-self: flex-end; margin-left: auto; }
        .user-message .message-content { background-color: var(--user-message-bg); color: var(--user-message-text); border-bottom-right-radius: 6px; }
        .ai-message { align-self: flex-start; margin-right: auto; }
        .ai-message .message-content { background-color: var(--ai-message-bg); color: var(--ai-message-text); border-bottom-left-radius: 6px; }
        .ai-message.error-message .message-content { background-color: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
        body.dark-mode .ai-message.error-message .message-content { background-color: #5e3333; color: #ff8a80; border-color: #c35050; }

        .pollinations-image-display-container {
            margin-top: 8px;
            max-width: 100%;
        }
        .pollinations-image-display-container img.pollinations-generated-image,
        .pollinations-image-display-container canvas.processed-image-canvas {
            display: block;
            max-width: 100%;
            max-height: 450px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--pollinations-image-container-bg);
            object-fit: contain;
        }
        .pollinations-image-display-container.loading-initial img.pollinations-generated-image,
        .pollinations-image-display-container.loading-initial canvas.processed-image-canvas {
            display: none;
        }
        .pollinations-image-display-container .image-prompt-display {
            font-size: 0.9em;
            font-style: italic;
            color: var(--secondary-text-color);
            margin-bottom: 8px;
            word-break: break-word;
        }
        .pollinations-image-display-container .image-meta-info {
            font-size: 0.75em;
            color: var(--secondary-text-color);
            margin-top: 6px;
            text-align: center;
        }
        .pollinations-support-text {
            font-size: 0.7em;
            color: var(--secondary-text-color);
            text-align: center;
            margin-top: 4px;
        }


        .system-info-message {
          align-self: center; width: fit-content; max-width: 80%;
          margin-left: auto; margin-right: auto;
        }
        .system-info-message .message-content {
          background-color: var(--system-info-bg); color: var(--system-info-text);
          border: 1px solid var(--system-info-border); font-size: 0.85em; text-align: center;
        }
        .message-actions-toolbar {
            position: absolute;
            bottom: -24px;
            display: flex;
            gap: 6px;
            z-index: 1;
        }
        .user-message .message-actions-toolbar { left: 0px; }
        .ai-message .message-actions-toolbar { right: 0px; }

        .message-action-btn {
            background: rgba(0,0,0,0.08); color: var(--secondary-text-color);
            border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;
            display: flex;
            align-items: center; justify-content: center;
            opacity: 0;
            transition: opacity 0.2s, background-color 0.2s, color 0.2s;
            padding:0;
            pointer-events: none;
        }
        .message:hover .message-action-btn,
        .message-action-btn.always-visible {
            opacity: 0.7;
            pointer-events: auto;
        }
        .message-action-btn:hover,
        .message-action-btn.always-visible:hover {
            opacity: 1;
        }
        body.dark-mode .message-action-btn { background: rgba(255,255,255,0.1); }
        .message-action-btn:hover { background: rgba(0,0,0,0.15); }
        body.dark-mode .message-action-btn:hover { background: rgba(255,255,255,0.2); }
        .message-action-btn svg { width: 14px; height: 14px; fill: currentColor; }

        /* Artifact Styles */
        .artifact-container {
          background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 10px;
          margin-top: 10px; margin-bottom: 8px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
          transition: background-color 0.3s, border-color 0.3s;
          color: var(--text-color); 
        }
        .artifact-header {
          display: flex; justify-content: space-between; align-items: center; padding: 6px 10px;
          background-color: var(--bg-color); border-bottom: 1px solid var(--border-color);
          font-size: 0.75em; font-weight: 600; color: var(--secondary-text-color);
          transition: background-color 0.3s, border-color 0.3s, color 0.3s;
          cursor: pointer; 
        }
        .artifact-header .artifact-title { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 8px; display: inline;}
        .artifact-click-hint {
            font-size: 0.9em; 
            color: var(--secondary-text-color);
            font-style: italic;
            font-weight: normal;
            margin-left: 4px;
            display: inline; 
        }
        #artifact-viewer-modal .artifact-click-hint { display: none; }

        .artifact-header-actions { display: flex; gap: 5px; }
        .artifact-header-btn {
          background-color: var(--artifact-header-btn-bg); color: var(--secondary-text-color); border: none;
          padding: 5px; font-size: 0.9em; border-radius: 4px; cursor: pointer;
          transition: background-color 0.2s, color 0.2s;
          display: flex; align-items: center; justify-content: center;
          line-height: 1;
        }
        .artifact-header-btn:hover { background-color: var(--artifact-header-btn-hover-bg); color: var(--text-color); }
        .artifact-header-btn svg { width: 14px; height: 14px; fill: currentColor; }

        .artifact-content { 
            padding: 10px 12px; font-size: 0.85em; line-height: 1.6; max-height: 250px; overflow-y: auto; 
            color: var(--text-color); 
        }
        .artifact-content::-webkit-scrollbar { width: 8px; }
        .artifact-content::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 10px; }
        body.dark-mode .artifact-content::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .artifact-content::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb-color); border-radius: 10px; }
        .artifact-content::-webkit-scrollbar-thumb:hover { background: #a0a4a8; }
        body.dark-mode .artifact-content::-webkit-scrollbar-thumb:hover { background: #777b7e; }
        .artifact-content { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb-color) rgba(0,0,0,0.05); }
        body.dark-mode .artifact-content { scrollbar-color: var(--scrollbar-thumb-color) rgba(255,255,255,0.05); }
        
        .code-artifact .artifact-content {
          background-color: #2d2d2d; color: #f0f0f0; font-family: 'Courier New', Courier, monospace;
        }
        body.dark-mode .code-artifact .artifact-content {
          background-color: #1e1e1e; 
        }
        .code-artifact .artifact-content pre { margin: 0; padding: 0; white-space: pre-wrap; word-break: break-all; }
        .code-artifact .artifact-content code { display: block; }

        .table-artifact .artifact-content { overflow-x: auto; }
        .table-artifact table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            font-size: 0.9em;
        }
        .table-artifact th, .table-artifact td {
            border: 1px solid var(--border-color);
            padding: 6px 8px;
            text-align: left;
            line-height: 1.4;
            vertical-align: top;
            color: var(--text-color); 
        }
        .table-artifact th {
            background-color: var(--input-bg-color);
            font-weight: 600;
        }


        .thinking-loader { display: flex; align-items: center; justify-content: center; padding: 10px 0; }
        .thinking-loader div {
            width: 8px; height: 8px; margin: 0 3px; background-color: var(--secondary-text-color);
            border-radius: 100%; display: inline-block; animation: sk-bouncedelay 1.4s infinite ease-in-out both;
            transition: background-color 0.3s;
        }
        .thinking-loader .bounce1 { animation-delay: -0.32s; } .thinking-loader .bounce2 { animation-delay: -0.16s; } .thinking-loader .bounce3 { animation-delay: 0s; }
        @keyframes sk-bouncedelay { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .typing-cursor {
            display: inline-block; width: 1.5px; height: 1em; background-color: currentColor;
            animation: blink-cursor 1s step-end infinite; margin-left: 2px; vertical-align: text-bottom;
        }
        @keyframes blink-cursor { from, to { background-color: transparent; } 50% { background-color: currentColor; } }

        #input-area-wrapper {
            width: 100%;
            background-color: var(--surface-color);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -1px 3px rgba(0,0,0,0.05);
            flex-shrink: 0;
            z-index: 100;
            padding: 10px 15px;
            padding-bottom: calc(10px + var(--safe-area-inset-bottom));
            position: relative;
            display: flex;
            flex-direction: column;
            transition: padding 0.3s ease-out, background-color 0.3s ease-out, border-top 0.3s ease-out, box-shadow 0.3s ease-out;
        }
        #input-area-wrapper.input-closed {
            background-color: transparent;
            border-top: none;
            box-shadow: none;
            padding: 0;
        }

        #attachment-preview-area {
            display: none;
            margin-bottom: 8px;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg-color);
            position: relative;
            max-width: 100%;
            color: var(--input-text-color);
            font-size: 0.85em;
            align-items: center;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        #attachment-preview-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
            overflow: hidden;
        }
        #attachment-preview-icon-container {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #attachment-preview-icon-container svg,
        #attachment-preview-icon-container img {
            width: 28px;
            height: 28px;
            fill: var(--icon-fill-color);
        }
        #attachment-preview-icon-container img {
            object-fit: cover;
            border-radius: 3px;
            border: 1px solid var(--border-color);
        }
        #attached-preview-info {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #remove-attachment-btn {
            background-color: var(--secondary-text-color); color: white;
            border: none; border-radius: 50%;
            width: 20px; height: 20px;
            font-size: 12px; line-height: 20px; text-align: center;
            cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            flex-shrink: 0;
            margin-left: 10px;
            transition: background-color 0.2s;
        }
         #remove-attachment-btn:hover { background-color: var(--stop-button-bg-color); }


        #open-input-area-btn {
            position: fixed;
            bottom: calc(15px + var(--safe-area-inset-bottom));
            left: 50%;
            z-index: 1010;
            width: auto;
            height: 38px;
            padding: 0 18px;
            border-radius: 19px;
            background-color: var(--text-color);
            color: var(--surface-color);
            border: none;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transform: translateX(-50%) scale(0.7);
            transition: background-color 0.2s, color 0.2s, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease-out, visibility 0s linear 0.3s, box-shadow 0.3s;
        }
        body.dark-mode #open-input-area-btn {
             background-color: var(--surface-color);
             color: var(--text-color);
        }
        #open-input-area-btn:hover:not(:disabled) { 
            background-color: #333;
            transform: translateX(-50%) scale(0.9);
        }
        body.dark-mode #open-input-area-btn:hover:not(:disabled) {
            background-color: #4a4b4c;
        }
        #open-input-area-btn:disabled {
            background-color: var(--input-bg-color) !important;
            color: var(--secondary-text-color) !important;
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            box-shadow: none !important;
            transform: translateX(-50%) scale(0.7) !important;
        }
        #open-input-area-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }


        #input-elements-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: opacity 0.3s ease-out, max-height 0.3s ease-out, visibility 0s linear 0.3s;
            opacity: 1;
            max-height: 500px;
            overflow: visible;
            visibility: visible;
            padding-bottom: 4px;
        }
        #input-area-wrapper.input-closed #input-elements-container {
             opacity: 0;
             max-height: 0;
             visibility: hidden;
             transition-delay: 0s, 0s, 0.3s;
             padding-bottom: 0;
        }

        .userInput-row {
            width: 100%;
        }
        #userInput {
          width: 100%;
          padding: 10px 15px; border: 1px solid var(--border-color);
          border-radius: 20px; background-color: var(--input-bg-color);
          color: var(--input-text-color); font-size: 0.9rem; font-family: var(--font-primary);
          outline: none; resize: none; max-height: 120px; overflow-y: auto; line-height: 1.4;
          scrollbar-width: none; -ms-overflow-style: none;
          transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        #userInput::-webkit-scrollbar { width: 0; height: 0; }
        #userInput:focus { border-color: var(--button-bg-color); }

        #input-actions-row {
          display: flex; align-items: center; gap: 8px;
          position: relative;
          width: 100%;
        }

        .input-area-btn {
            background: none; border: 1px solid var(--text-color); padding: 0; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: var(--secondary-text-color); width: 40px; height: 40px;
            border-radius: 50%; transition: background-color 0.2s, color 0.2s, opacity 0.2s, border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box; flex-shrink: 0;
            position: relative;
            z-index: 1;
        }
        .input-area-btn:hover:not(:disabled) {
            background-color: var(--solid-hover-light);
        }
        body.dark-mode .input-area-btn:hover:not(:disabled) {
            background-color: var(--solid-hover-dark);
        }

        .input-area-btn:disabled { opacity: 0.5; cursor: not-allowed !important; background-color: var(--input-bg-color) !important; color: var(--secondary-text-color) !important; border-color: var(--border-color) !important;}
        .input-area-btn svg { fill: currentColor; width: 20px; height: 20px;}


        #file-actions-btn-container {
            position: relative;
            z-index: 10;
        }
        #file-actions-menu {
            display: none; position: absolute;
            bottom: calc(100% + 10px); left: 0;
            background-color: var(--solid-surface-light);
            border-radius: 8px;
            box-shadow: var(--model-switcher-dropdown-shadow);
            padding: 8px;
            z-index: 105;
            width: max-content; border: 1px solid var(--border-color);
            transition: background-color 0.3s, box-shadow 0.3s, border-color 0.3s;
        }
        body.dark-mode #file-actions-menu {
            background-color: var(--solid-surface-dark);
        }
        #file-actions-menu button {
            display: block; width: 100%; padding: 10px 15px;
            background: none; border: none; text-align: left;
            cursor: pointer; font-size: 0.9em; color: var(--text-color);
            border-radius: 6px; transition: background-color 0.2s, color 0.2s;
            box-sizing: border-box;
        }
        #file-actions-menu button:hover {
            background-color: var(--solid-hover-light);
        }
        body.dark-mode #file-actions-menu button:hover {
            background-color: var(--solid-hover-dark);
        }
        #file-actions-menu button:not(:last-child) { margin-bottom: 4px; }
        #file-actions-menu button.active-option {
            font-weight: 600;
            background-color: var(--solid-hover-light);
        }
        body.dark-mode #file-actions-menu button.active-option {
            background-color: var(--solid-hover-dark);
        }


        #model-switcher-container {
            position: relative;
            z-index: 10;
            margin: 0 auto;
        }
        #model-switcher-btn {
            background-color: var(--model-switcher-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 0 12px;
            height: 40px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            min-width: 100px;
            text-align: center;
        }
        #model-switcher-btn:hover:not(:disabled) {
            background-color: var(--model-switcher-hover-bg);
        }
        #model-switcher-btn:disabled {
            opacity: 0.6; cursor: not-allowed !important;
        }
        #model-switcher-btn #current-model-name {
            margin-right: 6px;
        }
        #model-switcher-btn svg {
            width: 16px; height: 16px; fill: currentColor;
            transition: transform 0.2s;
        }
        #model-switcher-btn.open svg {
            transform: rotate(180deg);
        }
        #model-switcher-dropdown {
            display: none;
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--solid-surface-light);
            border-radius: 8px;
            box-shadow: var(--model-switcher-dropdown-shadow);
            padding: 8px;
            z-index: 105;
            width: max-content;
            min-width: 150px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, box-shadow 0.3s, border-color 0.3s;
        }
        body.dark-mode #model-switcher-dropdown {
            background-color: var(--solid-surface-dark);
        }
        #model-switcher-dropdown button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            font-size: 0.9em;
            color: var(--text-color);
            border-radius: 6px;
            transition: background-color 0.2s, color 0.2s;
        }
        #model-switcher-dropdown button:hover {
            background-color: var(--solid-hover-light);
        }
        body.dark-mode #model-switcher-dropdown button:hover {
            background-color: var(--solid-hover-dark);
        }
        #model-switcher-dropdown button.active-model {
            font-weight: 600;
            background-color: var(--solid-hover-light);
        }
        body.dark-mode #model-switcher-dropdown button.active-model {
            background-color: var(--solid-hover-dark);
        }
        #model-switcher-dropdown button:not(:last-child) {
            margin-bottom: 4px;
        }

        #deepthink-btn-container {
            position: relative;
            z-index: 10;
        }
        #deepthink-btn.active {
            color: var(--deepthink-active-color); background-color: var(--deepthink-active-bg);
            border-color: var(--deepthink-active-color);
            box-shadow: 0 0 0 1.5px var(--deepthink-active-color), 0 1px 2px rgba(0,0,0,0.1);
            z-index: 2;
        }
        #deepthink-btn.imageai-pollinations-model-selector #current-pollinations-model-name {
             display: none;
        }

        #imageai-pollinations-model-menu {
            display: none; position: absolute;
            bottom: calc(100% + 10px); right: 0;
            background-color: var(--solid-surface-light);
            border-radius: 8px;
            box-shadow: var(--model-switcher-dropdown-shadow);
            padding: 8px;
            z-index: 105;
            width: max-content; border: 1px solid var(--border-color);
            min-width: 120px;
            transition: background-color 0.3s, box-shadow 0.3s, border-color 0.3s;
        }
        body.dark-mode #imageai-pollinations-model-menu {
            background-color: var(--solid-surface-dark);
        }
        #imageai-pollinations-model-menu button {
            display: block; width: 100%; padding: 10px 15px;
            background: none; border: none; text-align: left;
            cursor: pointer; font-size: 0.9em; color: var(--text-color);
            border-radius: 6px; transition: background-color 0.2s, color 0.2s;
            box-sizing: border-box;
        }
        #imageai-pollinations-model-menu button:hover {
            background-color: var(--solid-hover-light);
        }
        body.dark-mode #imageai-pollinations-model-menu button:hover {
            background-color: var(--solid-hover-dark);
        }
        #imageai-pollinations-model-menu button:not(:last-child) { margin-bottom: 4px; }
        #imageai-pollinations-model-menu button.active-option {
            font-weight: 600;
            background-color: var(--solid-hover-light);
        }
        body.dark-mode #imageai-pollinations-model-menu button.active-option {
            background-color: var(--solid-hover-dark);
        }


        #sendBtn {
          padding: 0; background-color: var(--button-bg-color); color: var(--button-text-color);
          border: none;
          border-radius: 50%;
          box-shadow: 0 1px 3px rgba(0,0,0,0.2);
          cursor: pointer;
          display: flex; align-items: center; justify-content: center;
          width: 40px; height: 40px; flex-shrink: 0; transition: background-color 0.2s, box-shadow 0.2s, color 0.2s;
          box-sizing: border-box;
          position: relative;
          z-index: 1;
        }
        #sendBtn svg { width: 18px; height: 18px; fill: currentColor; }
        #sendBtn.stop-mode { background-color: var(--stop-button-bg-color); }
        #sendBtn.stop-mode:hover:not(:disabled) { background-color: var(--stop-button-hover-bg-color); }
        #sendBtn:hover:not(:disabled):not(.stop-mode) { background-color: #166fe5; box-shadow: 0 2px 5px rgba(0,0,0,0.25); }
        #sendBtn:disabled { background-color: #aabbcc; opacity: 0.7; cursor: not-allowed; box-shadow: none;}
        body.dark-mode #sendBtn:disabled { background-color: #4a4b4c; }

        #sendBtn.stop-mode::before {
            content: '';
            position: absolute;
            top: -3px; left: -3px; right: -3px; bottom: -3px;
            border-radius: 50%;
            border: 2px solid transparent; 
            border-top-color: var(--stop-spinner-effective-color); 
            border-right-color: var(--stop-spinner-effective-color); 
            animation: sendBtnSpinner 0.7s linear infinite;
            z-index: 0; 
        }
        @keyframes sendBtnSpinner {
            to {
                transform: rotate(360deg);
            }
        }


        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--dialog-overlay-bg); display: flex; align-items: center; justify-content: center;
            z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s ease 0.3s, background-color 0.3s;
            padding: var(--safe-area-inset-top) var(--safe-area-inset-right) var(--safe-area-inset-bottom) var(--safe-area-inset-left);
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s linear 0s;} 
        .modal-content {
            background-color: var(--solid-surface-light);
            padding: 0; 
            border-radius: 8px;
            width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); position: relative;
            display: flex; flex-direction: column;
            max-height: calc(100vh - var(--safe-area-inset-top) - var(--safe-area-inset-bottom) - 40px);
            transition: background-color 0.3s, box-shadow 0.3s, color 0.3s;
            color: var(--text-color);
        }
        body.dark-mode .modal-content {
            background-color: var(--solid-surface-dark);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            background-color: var(--modal-header-bg);
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .modal-header h2 { margin: 0; font-size: 1.3em; color: var(--text-color); transition: color 0.3s; flex-grow: 1;}
        .modal-header .modal-close-btn {
            font-size: 1.8em; font-weight: bold; cursor: pointer; color: var(--secondary-text-color);
            transition: color 0.2s; background: none; border: none; padding: 0 5px; line-height: 1;
            flex-shrink: 0; margin-left:15px;
        }
        .modal-header .modal-close-btn:hover { color: var(--text-color); }
        
        .modal-body {
            overflow-y: auto; padding: 20px 25px;
            flex-grow: 1;
            color: var(--text-color); 
        }
        .modal-body::-webkit-scrollbar { width: 7px; }
        .modal-body::-webkit-scrollbar-track { background: var(--scrollbar-track-color); }
        .modal-body::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb-color); border-radius: 4px; }
        
        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-shrink: 0;
        }
        .modal-content button:not(.modal-close-btn):not(.modal-header-action-btn),
        .modal-footer button {
            padding: 10px 18px; border: none; border-radius: 6px; font-size: 0.9em; font-weight: 500; cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s, color 0.2s; font-family: var(--font-primary);
            width: auto; margin-bottom: 0px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
         .modal-content button:disabled:not(.modal-close-btn) { opacity: 0.6; cursor: not-allowed; }


        #ocr-image-preview-container {
            max-height: 30vh; overflow-y: auto; margin-bottom: 15px;
            border: 1px dashed var(--border-color); display:none;
            background-color: var(--ocr-preview-bg);
            text-align: center;
            transition: background-color 0.3s, border-color 0.3s;
        }
        #ocr-image-preview { display: inline-block; max-width: 100%; height: auto; }
        #ocr-status-area { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 100px; margin-bottom: 15px; }
        #ocr-status-area .thinking-loader { transform: scale(1.2); }
        #ocr-progress-status-text { margin-top: 10px; color: var(--secondary-text-color); font-size: 0.9em; transition: color 0.3s;}

        #ocr-modal .modal-body > button:first-of-type { width: 100%; margin-bottom:10px; } 

        #ocr-scan-btn { background-color: var(--button-bg-color); color: var(--button-text-color); }
        #ocr-scan-btn:not(:disabled):hover { background-color: #166fe5; }
        body.dark-mode #ocr-scan-btn:not(:disabled):hover { background-color: #267feb; }
        
        #ocr-copy-btn { background-color: #6c757d; color: white; }
        #ocr-copy-btn:not(:disabled):hover { background-color: #5a6268; }
        #ocr-send-to-chat-btn { background-color: #28a745; color: white; }
        #ocr-send-to-chat-btn:not(:disabled):hover { background-color: #218838; }
        
        .modal-file-input-label {
            display: block; width: 100%; padding: 10px 18px; cursor: pointer;
            border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--input-bg-color); margin-bottom: 10px;
            text-align: center; font-size: 0.9em; font-weight: 500; color: var(--text-color);
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .modal-file-input-label:hover { background-color: var(--model-switcher-hover-bg); }
        .modal-hidden-file-input { display: none; }
        .modal-selected-filename {
            font-size: 0.8em; color: var(--secondary-text-color); margin-top: -5px; margin-bottom: 15px;
            word-break: break-all; text-align: center; padding: 0 5px; transition: color 0.3s;
        }
        .modal-textarea-result {
            width: 100%; font-family: var(--font-primary); font-size: 0.9em; padding: 8px 12px;
            border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--input-bg-color);
            color: var(--input-text-color); resize: vertical; min-height: 80px; margin-bottom: 15px;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        
        #artifact-viewer-modal .modal-content {
            max-width: 90vw; 
            width: auto;
            max-height: calc(100vh - var(--safe-area-inset-top) - var(--safe-area-inset-bottom) - 40px); 
            display: flex;
            flex-direction: column;
        }
        #artifact-viewer-modal .modal-header {
            position: relative; 
             background-color: var(--modal-header-bg); 
        }
        #artifact-viewer-modal .modal-header h2 {
            font-size: 1.1em; 
            font-weight: 600;
            display: block; 
            width: 100%;
            padding-right: 30px; 
            color: var(--text-color); 
        }
        #artifact-viewer-modal .modal-header .modal-close-btn {
            position: absolute;
            top: 50%;
            right: 25px; 
            transform: translateY(-50%);
        }

        .modal-actions-bar { 
            padding: 10px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: center; 
            gap: 10px;
            flex-shrink: 0;
            background-color: var(--modal-actions-bar-bg);
        }
        .modal-actions-bar .modal-header-action-btn {
            padding: 8px 15px; 
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s, color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--button-text-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        #artifact-viewer-download-btn.modal-header-action-btn { background-color: var(--download-button-bg-color); }
        #artifact-viewer-download-btn.modal-header-action-btn:hover { background-color: var(--download-button-hover-bg-color); }
        #artifact-viewer-copy-btn.modal-header-action-btn { background-color: var(--dialog-button-secondary-bg); } 
        #artifact-viewer-copy-btn.modal-header-action-btn:hover { background-color: #5a6268; }
        
        .modal-actions-bar .modal-header-action-btn svg {
            width: 16px; height: 16px; fill: currentColor;
        }


        #artifact-viewer-modal-body {
            font-size: 0.9em; 
            line-height: 1.5;
            flex-grow: 1; 
            overflow-y: auto; 
            color: var(--text-color); 
        }
        #artifact-viewer-modal-body::-webkit-scrollbar { width: 8px; }
        #artifact-viewer-modal-body::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 10px; }
        body.dark-mode #artifact-viewer-modal-body::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        #artifact-viewer-modal-body::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb-color); border-radius: 10px; }
        #artifact-viewer-modal-body { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb-color) rgba(0,0,0,0.05); }
        body.dark-mode #artifact-viewer-modal-body { scrollbar-color: var(--scrollbar-thumb-color) rgba(255,255,255,0.05); }


        #artifact-viewer-modal-body pre {
            white-space: pre-wrap;
            word-break: break-all;
            margin: 0; 
        }
        #artifact-viewer-modal-body .code-artifact-viewer-content {
            background-color: #2d2d2d; color: #f0f0f0; font-family: 'Courier New', Courier, monospace; 
            padding: 15px; border-radius: 6px;
        }
        body.dark-mode #artifact-viewer-modal-body .code-artifact-viewer-content {
            background-color: #1e1e1e; 
        }
        #artifact-viewer-modal-body .table-artifact-viewer-content { overflow-x: auto; }
        #artifact-viewer-modal-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            font-size: 0.95em;
        }
        #artifact-viewer-modal-body th, #artifact-viewer-modal-body td {
            border: 1px solid var(--border-color);
            padding: 8px 10px;
            text-align: left;
            vertical-align: top;
            color: var(--text-color); 
        }
        #artifact-viewer-modal-body th {
            background-color: var(--input-bg-color);
            font-weight: 600;
        }
        


        .custom-dialog-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--dialog-overlay-bg);
            display: flex; align-items: center; justify-content: center;
            z-index: 4000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.2s ease-out, visibility 0s linear 0.2s, background-color 0.3s;
            padding: 20px;
        }
        .custom-dialog-overlay.visible { opacity: 1; visibility: visible; transition-delay: 0s; }
        .custom-dialog {
            background-color: var(--solid-surface-light);
            padding: 25px; border-radius: 12px;
            width: 100%; max-width: 400px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
            transform: scale(0.95); opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, background-color 0.3s, box-shadow 0.3s, color 0.3s;
            color: var(--text-color);
        }
        body.dark-mode .custom-dialog {
            background-color: var(--solid-surface-dark);
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
        }
        .custom-dialog-overlay.visible .custom-dialog { transform: scale(1); opacity: 1; }
        .custom-dialog h3 {
            font-size: 1.25em; color: var(--text-color);
            margin-top: 0; margin-bottom: 15px; font-weight: 600; transition: color 0.3s;
        }
        .custom-dialog p {
            font-size: 0.95em; color: var(--secondary-text-color);
            line-height: 1.6; margin-bottom: 25px; transition: color 0.3s;
        }
        .custom-dialog-actions { display: flex; justify-content: center; gap: 12px; }
        .custom-dialog-actions button {
            padding: 10px 20px; border: none; border-radius: 8px;
            font-size: 0.9em; font-weight: 500; cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s, color 0.2s;
            min-width: 100px;
        }
        .custom-dialog-actions button.primary { background-color: var(--dialog-button-primary-bg); color: var(--button-text-color); }
        .custom-dialog-actions button.primary:hover { background-color: #166ee5; }
        body.dark-mode .custom-dialog-actions button.primary:hover { background-color: #267feb; }
        .custom-dialog-actions button.secondary { background-color: var(--dialog-button-secondary-bg); color: var(--button-text-color); }
        .custom-dialog-actions button.secondary:hover { background-color: #5a6268; }
        .custom-dialog-actions button.danger { background-color: var(--dialog-button-danger-bg); color: var(--button-text-color); }
        .custom-dialog-actions button.danger:hover { background-color: var(--stop-button-hover-bg-color); }

    </style>
</head>
<body>

    <div id="loading-overlay">
        <div id="animation-container">
            <img src="images/logo001.webp" alt="FlabsAI Logo" id="loading-logo">
            <div id="shards-container"></div>
            <div id="loading-text-container">
                <div id="loading-text"></div>
            </div>
        </div>
    </div>

    <div id="app-layout-container" style="display: none;">
        <h1 id="app-title">ChatAI</h1>

        <button id="menu-toggle-floating" class="floating-control-btn" aria-label="Toggle Menu">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
        </button>
        <button id="toggle-tools-panel-btn" class="floating-control-btn" title="Tampilkan Alat">
            <svg class="icon-tools-down" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"></path></svg>
            <svg class="icon-tools-up" viewBox="0 0 24 24" style="display:none;"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg>
        </button>

        <div id="tools-panel">
             <button id="dark-mode-toggle-btn" class="header-icon-btn" title="Toggle Dark Mode">
                <svg class="icon-dark-mode" viewBox="0 0 24 24">
                    <path d="M10 2c-1.82 0-3.53.5-5 1.35 2.99 1.73 5 4.95 5 8.65s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z"></path>
                </svg>
                 <svg class="icon-light-mode" viewBox="0 0 24 24" style="display:none;">
                    <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM12 9c1.65 0 3 1.35 3 3s-1.35 3-3 3-3-1.35-3-3 1.35-3 3-3zm0-7C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path>
                </svg>
            </button>
            <button id="download-chat-btn" class="header-icon-btn" title="Unduh Riwayat Chat">
                <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>
            </button>
            <button id="reset-role-btn" class="header-icon-btn" title="Reset Peran AI">
                <svg viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"></path></svg>
            </button>
        </div>

        <div id="chat-container"></div>

        <div id="input-area-wrapper">
            <div id="attachment-preview-area">
                <div id="attachment-preview-content">
                    <div id="attachment-preview-icon-container">
                    </div>
                    <span id="attached-preview-info"></span>
                </div>
                <button id="remove-attachment-btn" title="Hapus Lampiran"></button>
            </div>
            <div id="input-elements-container">
                <div class="userInput-row">
                    <textarea id="userInput" placeholder="Ketik pesan..." rows="1"></textarea>
                </div>
                <div id="input-actions-row">
                    <button id="toggle-input-elements-btn" class="input-area-btn" title="Sembunyikan Area Input">
                        <svg class="icon-input-collapse" viewBox="0 0 24 24"><path d="M12 16l-6-6 1.41-1.41L12 13.17l4.59-4.58L18 10l-6 6z"></path></svg>
                    </button>

                    <div id="file-actions-btn-container">
                        <button id="file-actions-btn" class="input-area-btn" title="Tambah Lampiran/Aksi">
                        </button>
                        <div id="file-actions-menu">
                        </div>
                    </div>
                    <input type="file" id="image-attachment-input" class="modal-hidden-file-input" accept="image/*">
                    <input type="file" id="document-attachment-input" class="modal-hidden-file-input" accept=".pdf,.js,.py,.txt,.html,.css,.md,.csv,.xml,.rtf,.java,.json,.xlsx,.xls">

                    <div id="model-switcher-container">
                        <button id="model-switcher-btn" title="Ganti Mode AI">
                            <span id="current-model-name">ChatAI</span>
                            <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"></path></svg>
                        </button>
                        <div id="model-switcher-dropdown">
                            <button data-model="chatai" class="active-model">ChatAI</button>
                            <button data-model="imageai">ImageAI</button>
                        </div>
                    </div>

                    <div id="deepthink-btn-container">
                        <button id="deepthink-btn" class="input-area-btn" title="Mode Berpikir Mendalam">
                        </button>
                        <div id="imageai-pollinations-model-menu">
                        </div>
                    </div>

                    <button id="sendBtn" title="Kirim">
                    </button>
                </div>
            </div>
        </div>

        <button id="open-input-area-btn" title="Buka Area Input">
             <svg viewBox="0 0 24 24"><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14l-6-6z"></path></svg>
        </button>
    </div>


    <div id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo-title">
                <div class="logo"><img src="images/logo001.webp" alt="FemzLabs Logo"></div>
                <h2>FlabsAI</h2>
            </div>
            <button id="close-sidebar-btn" aria-label="Tutup Menu" class="header-icon-btn">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
        </div>
        <div class="sidebar-content">
            <div class="category-title">Utama</div>
            <ul>
                <li><a href="error.html">
                    <svg viewBox="0 0 24 24"><path d="M12 5.69l5 4.5V18h-2v-6H9v6H7v-7.81l5-4.5M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"></path></svg>
                    Dashboard
                </a></li>
                <li><a href="error.html">
                    <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42.12-.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69.98l2.49 1c.23.08.49 0-.61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg>
                    Pengaturan Chat
                </a></li>
                <li><a href="error.html">
                    <svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.25 2.52.77-1.28-3.52-2.09V8z"></path></svg>
                    Riwayat Percakapan
                </a></li>
            </ul>
            <div class="category-title">Alat AI & Utilitas</div>
            <ul>
                <li><a href="/flashcard" target="_blank"> <!-- User said ImageAI icon (which is a palette) is good, applying similar to FlashCard -->
                    <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5.67 1.5 1.5S12.83 24 12 24s-1.5-.67-1.5-1.5c0-4.97-4.03-9-9-9s-9-4.03-9-9 4.03-9 9-9c.83 0 1.5.67 1.5 1.5S12.83 3 12 3zm0 2c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.14-7-7 3.14-7 7-7zm0 3c-.83 0-1.5.67-1.5 1.5S11.17 11 12 11s1.5-.67 1.5-1.5S12.83 8 12 8zm-3 3c-.83 0-1.5.67-1.5 1.5S8.17 14 9 14s1.5-.67 1.5-1.5S9.83 11 9 11zm6 0c-.83 0-1.5.67-1.5 1.5S14.17 14 15 14s1.5-.67 1.5-1.5S15.83 11 15 11zm-3 3c-.83 0-1.5.67-1.5 1.5S11.17 17 12 17s1.5-.67 1.5-1.5S12.83 14 12 14z"></path></svg>
                    FlashCard AI
                </a></li>
                <li><a href="error.html" id="file-converter-link">
                    <svg viewBox="0 0 24 24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"></path></svg>
                    Convert File
                </a></li>
                <li><a href="error.html">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"></path></svg>
                    Fitur Lain (Segera Hadir)
                </a></li>
            </ul>
             <div class="category-title">Lainnya</div>
            <ul>
                <li><a href="error.html">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path></svg>
                    Tentang FlabsAI
                </a></li>
                <li><a href="error.html">
                    <svg viewBox="0 0 24 24"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14a4 4 0 0 0-4 4h2a2 2 0 1 1 2 2c0 .55-.22 1.05-.59 1.41L10 14.83V16h2v-1.79l1.79-1.79C14.58 11.66 15 10.88 15 10a3 3 0 0 0-3-3z"></path></svg>
                    Pusat Bantuan
                </a></li>
            </ul>
        </div>
        <div class="sidebar-footer"> Copyright FlabsAI  <span id="current-year">2025</span></div>
    </div>

    <!-- OCR Modal -->
    <div id="ocr-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Salin Teks dari Gambar</h2>
                <button class="modal-close-btn" id="ocr-modal-close-btn" aria-label="Tutup Salin Teks dari Gambar"></button>
            </div>
            <div class="modal-body">
                <label for="ocr-image-input" class="modal-file-input-label">Pilih Gambar...</label>
                <input type="file" id="ocr-image-input" class="modal-hidden-file-input" accept="image/*">
                <p id="ocr-selected-filename" class="modal-selected-filename" style="display:none;"></p>
                <div id="ocr-image-preview-container"><img id="ocr-image-preview" src="#" alt="Preview Gambar OCR" /></div>
                <div id="ocr-status-area">
                    <div class="thinking-loader"><div class="bounce1"></div> <div class="bounce2"></div> <div class="bounce3"></div></div>
                    <p id="ocr-progress-status-text">Memproses gambar...</p>
                </div>
                <button id="ocr-scan-btn" disabled>Scan Teks Gambar</button>
                <textarea id="ocr-result-text" class="modal-textarea-result" rows="6" readonly placeholder="Teks hasil scan akan muncul di sini..."></textarea>
            </div>
            <div class="modal-footer">
                <button id="ocr-copy-btn" disabled>Salin Teks</button>
                <button id="ocr-send-to-chat-btn" disabled>Kirim ke Chat</button>
            </div>
        </div>
    </div>

    <!-- Artifact Viewer Modal -->
    <div id="artifact-viewer-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="artifact-viewer-title">Lihat Artifact</h2>
                <button class="modal-close-btn" id="artifact-viewer-close-btn" aria-label="Tutup Pelihat Artifact"></button>
            </div>
            <div class="modal-actions-bar">
                <button id="artifact-viewer-download-btn" class="modal-header-action-btn" title="Unduh Artifact">
                    <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>
                    Unduh
                </button>
                <button id="artifact-viewer-copy-btn" class="modal-header-action-btn" title="Salin Konten">
                    <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
                    Salin
                </button>
            </div>
            <div class="modal-body" id="artifact-viewer-modal-body">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>


    <div id="custom-dialog-overlay" class="custom-dialog-overlay">
        <div class="custom-dialog">
            <h3 id="custom-dialog-title">Pemberitahuan</h3>
            <p id="custom-dialog-message">Ini adalah pesan dialog.</p>
            <div class="custom-dialog-actions">
                <button id="custom-dialog-btn-confirm" class="primary">OK</button>
                <button id="custom-dialog-btn-cancel" class="secondary" style="display:none;">Batal</button>
            </div>
        </div>
    </div>


    <script id="imageProcessorWorkerScript" type="javascript/worker">
        // --- Start of Embedded Worker Code (imageProcessorFlabs.js) ---
        // Helper Functions
        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }

        function gaussian(x, sigma) {
            return Math.exp(-(x * x) / (2 * sigma * sigma));
        }

        // SIMPLIFIED BILATERAL FILTER (Denoise)
        async function applySimplifiedBilateralFilter(imageData, spatialSigma, intensitySigma, progressCallback, baseProgress, stageWeight) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            const newData = new Uint8ClampedArray(data.length);
            const kernelRadius = Math.ceil(spatialSigma * 2.5);
            let lastProgressUpdate = 0;

            for (let y = 0; y < height; y++) {
                const currentStepProgress = Math.round((y / height) * 100);
                if (currentStepProgress > lastProgressUpdate || y === height - 1) {
                    if (progressCallback) progressCallback(baseProgress + (currentStepProgress * stageWeight), `Denoising... ${currentStepProgress}%`);
                    await new Promise(resolve => setTimeout(resolve, 0)); 
                    lastProgressUpdate = currentStepProgress;
                }

                for (let x = 0; x < width; x++) {
                    let totalWeight = 0;
                    let sumR = 0, sumG = 0, sumB = 0;
                    const centerIndex = (y * width + x) * 4;
                    const centerR = data[centerIndex];
                    const centerG = data[centerIndex + 1];
                    const centerB = data[centerIndex + 2];

                    for (let ky = -kernelRadius; ky <= kernelRadius; ky++) {
                        for (let kx = -kernelRadius; kx <= kernelRadius; kx++) {
                            const nX = x + kx;
                            const nY = y + ky;
                            if (nX >= 0 && nX < width && nY >= 0 && nY < height) {
                                const dX = kx; const dY = ky;
                                const spatialDistSq = dX * dX + dY * dY;
                                if (spatialDistSq > kernelRadius * kernelRadius) continue;
                                const spatialWeight = gaussian(Math.sqrt(spatialDistSq), spatialSigma);
                                
                                const neighborIndex = (nY * width + nX) * 4;
                                const dR = data[neighborIndex] - centerR;
                                const dG = data[neighborIndex + 1] - centerG;
                                const dB = data[neighborIndex + 2] - centerB;
                                const intensityDistSq = dR * dR + dG * dG + dB * dB;
                                const intensityWeight = gaussian(Math.sqrt(intensityDistSq), intensitySigma);
                                
                                const weight = spatialWeight * intensityWeight;
                                sumR += data[neighborIndex] * weight;
                                sumG += data[neighborIndex + 1] * weight;
                                sumB += data[neighborIndex + 2] * weight;
                                totalWeight += weight;
                            }
                        }
                    }
                    newData[centerIndex]     = totalWeight > 0.00001 ? clamp(sumR / totalWeight, 0, 255) : centerR;
                    newData[centerIndex + 1] = totalWeight > 0.00001 ? clamp(sumG / totalWeight, 0, 255) : centerG;
                    newData[centerIndex + 2] = totalWeight > 0.00001 ? clamp(sumB / totalWeight, 0, 255) : centerB;
                    newData[centerIndex + 3] = data[centerIndex + 3]; // Alpha
                }
            }
            return new ImageData(newData, width, height);
        }
                
        // BOX BLUR (Helper for Unsharp Mask)
        function applyBoxBlur(imageData, kernelSize) {
            const data = imageData.data; const width = imageData.width; const height = imageData.height;
            const newData = new Uint8ClampedArray(data.length); const halfKernel = Math.floor(kernelSize / 2);
            if (halfKernel <=0) return imageData;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    let rSum = 0, gSum = 0, bSum = 0, aSum = 0, count = 0;
                    for (let ky = -halfKernel; ky <= halfKernel; ky++) {
                        for (let kx = -halfKernel; kx <= halfKernel; kx++) {
                            const nX = x + kx; const nY = y + ky;
                            if (nX >= 0 && nX < width && nY >= 0 && nY < height) {
                                const index = (nY * width + nX) * 4;
                                rSum += data[index]; gSum += data[index + 1]; bSum += data[index + 2]; aSum += data[index + 3]; count++;
                            }
                        }
                    }
                    const currentIndex = (y * width + x) * 4;
                    newData[currentIndex] = count > 0 ? rSum / count : data[currentIndex];
                    newData[currentIndex + 1] = count > 0 ? gSum / count : data[currentIndex+1];
                    newData[currentIndex + 2] = count > 0 ? bSum / count : data[currentIndex+2];
                    newData[currentIndex + 3] = count > 0 ? aSum / count : data[currentIndex+3];
                }
            }
            return new ImageData(newData, width, height);
        }

        // UNSHARP MASK
        async function applyUnsharpMask(imageData, amount, radiusForBlur, progressCallback, baseProgress, stageWeight) {
            const width = imageData.width; const height = imageData.height;
            const blurKernelSize = Math.max(1, Math.floor(radiusForBlur * 2 + 1));
            const blurredImageData = applyBoxBlur(imageData, blurKernelSize); 
            const originalData = imageData.data; const blurredData = blurredImageData.data;
            const sharpenedDataArray = new Uint8ClampedArray(originalData.length);
            let lastProgressUpdate = 0;

            for (let i = 0; i < originalData.length; i += 4) {
                const currentPixel = i / 4; const totalPixels = originalData.length / 4;
                const currentStepProgress = Math.round((currentPixel / totalPixels) * 100);
                if (currentStepProgress > lastProgressUpdate || i === originalData.length - 4) {
                     if (progressCallback) progressCallback(baseProgress + (currentStepProgress * stageWeight), `Sharpening... ${currentStepProgress}%`);
                     await new Promise(resolve => setTimeout(resolve, 0)); 
                     lastProgressUpdate = currentStepProgress;
                }
                const detailR = originalData[i] - blurredData[i];
                const detailG = originalData[i + 1] - blurredData[i + 1];
                const detailB = originalData[i + 2] - blurredData[i + 2];
                sharpenedDataArray[i]     = clamp(originalData[i]     + detailR * amount, 0, 255);
                sharpenedDataArray[i + 1] = clamp(originalData[i + 1] + detailG * amount, 0, 255);
                sharpenedDataArray[i + 2] = clamp(originalData[i + 2] + detailB * amount, 0, 255);
                sharpenedDataArray[i + 3] = originalData[i + 3]; // Alpha
            }
            return new ImageData(sharpenedDataArray, width, height);
        }

        // UPSCALE (Bilinear Interpolation)
        async function upscaleImageDataBilinear(imageData, newWidth, newHeight, progressCallback, baseProgress, stageWeight) {
            const oldWidth = imageData.width; const oldHeight = imageData.height; const oldData = imageData.data;
            const newData = new Uint8ClampedArray(newWidth * newHeight * 4);
            const xRatio = oldWidth / newWidth; const yRatio = oldHeight / newHeight;
            let lastProgressUpdate = 0;

            for (let y = 0; y < newHeight; y++) {
                 const currentStepProgress = Math.round((y / newHeight) * 100);
                 if (currentStepProgress > lastProgressUpdate || y === newHeight - 1) {
                    if (progressCallback) progressCallback(baseProgress + (currentStepProgress * stageWeight), `Upscaling... ${currentStepProgress}%`);
                    await new Promise(resolve => setTimeout(resolve, 0));
                    lastProgressUpdate = currentStepProgress;
                }
                for (let x = 0; x < newWidth; x++) {
                    const targetIndex = (y * newWidth + x) * 4;
                    const srcX = x * xRatio; const srcY = y * yRatio;
                    const x1 = Math.floor(srcX); const y1 = Math.floor(srcY);
                    const x2 = Math.min(x1 + 1, oldWidth - 1); const y2 = Math.min(y1 + 1, oldHeight - 1);
                    const fx = srcX - x1; const fy = srcY - y1; const fx1 = 1 - fx; const fy1 = 1 - fy;
                    const p1Index = (y1 * oldWidth + x1) * 4; const p2Index = (y1 * oldWidth + x2) * 4;
                    const p3Index = (y2 * oldWidth + x1) * 4; const p4Index = (y2 * oldWidth + x2) * 4;
                    for (let c = 0; c < 4; c++) { // RGBA
                        const p1 = oldData[p1Index + c]; const p2 = oldData[p2Index + c];
                        const p3 = oldData[p3Index + c]; const p4 = oldData[p4Index + c];
                        newData[targetIndex + c] = clamp(p1 * fx1 * fy1 + p2 * fx * fy1 + p3 * fx1 * fy  + p4 * fx * fy, 0, 255);
                    }
                }
            }
            return new ImageData(newData, newWidth, newHeight);
        }
        
        // CROP IMAGE DATA
        function cropImageData(imageData, cropPercent) {
            const originalWidth = imageData.width;
            const originalHeight = imageData.height;

            const cropXAmount = originalWidth * cropPercent;
            const cropYAmount = originalHeight * cropPercent;

            const sourceX = Math.floor(cropXAmount);
            const sourceY = Math.floor(cropYAmount);
            const sourceWidth = Math.floor(originalWidth - (2 * cropXAmount));
            const sourceHeight = Math.floor(originalHeight - (2 * cropYAmount));

            if (sourceWidth <= 0 || sourceHeight <= 0) {
                console.warn('Crop percentage too large, results in zero-dimension image. Returning original.');
                return imageData; 
            }

            const croppedData = new Uint8ClampedArray(sourceWidth * sourceHeight * 4);
            const originalData = imageData.data;

            for (let y = 0; y < sourceHeight; y++) {
                for (let x = 0; x < sourceWidth; x++) {
                    const srcIdx = ((sourceY + y) * originalWidth + (sourceX + x)) * 4;
                    const destIdx = (y * sourceWidth + x) * 4;
                    croppedData[destIdx] = originalData[srcIdx];         // R
                    croppedData[destIdx + 1] = originalData[srcIdx + 1]; // G
                    croppedData[destIdx + 2] = originalData[srcIdx + 2]; // B
                    croppedData[destIdx + 3] = originalData[srcIdx + 3]; // A
                }
            }
            return new ImageData(croppedData, sourceWidth, sourceHeight);
        }


        // Worker Message Handler
        self.onmessage = async function(e) {
            const { imageData, params, newWidth, newHeight } = e.data; 

            try {
                let currentImageData = imageData;
                const DENOISE_STAGE_WEIGHT = 0.30; 
                const SHARPEN_STAGE_WEIGHT = 0.30;
                const UPSCALE_STAGE_WEIGHT = 0.30; 
                const CROP_STAGE_WEIGHT    = 0.10; 
                
                let overallProgress = 0;

                self.postMessage({ status: 'progress', percentage: 5, message: 'Memulai proses enhancement...' });

                if (params.denoiseStrength > 0 && params.denoiseSpatialSigma > 0) {
                    currentImageData = await applySimplifiedBilateralFilter(
                        currentImageData,
                        params.denoiseSpatialSigma,
                        params.denoiseStrength,
                        (p, m) => self.postMessage({ status: 'progress', percentage: p, message: m }), 
                        0,
                        DENOISE_STAGE_WEIGHT 
                    );
                }
                overallProgress = 100 * DENOISE_STAGE_WEIGHT;
                self.postMessage({ status: 'progress', percentage: overallProgress, message: 'Denoise selesai. Memulai Sharpening...' });

                if (params.sharpenAmount > 0 && params.sharpenRadius > 0) {
                    currentImageData = await applyUnsharpMask(
                        currentImageData,
                        params.sharpenAmount,
                        params.sharpenRadius,
                        (p, m) => self.postMessage({ status: 'progress', percentage: p, message: m }), 
                        overallProgress,
                        SHARPEN_STAGE_WEIGHT 
                    );
                }
                overallProgress += 100 * SHARPEN_STAGE_WEIGHT;
                self.postMessage({ status: 'progress', percentage: overallProgress, message: 'Sharpening selesai. Memulai Upscaling...' });
                
                if (newWidth && newHeight && (newWidth > currentImageData.width || newHeight > currentImageData.height)) {
                     currentImageData = await upscaleImageDataBilinear(
                        currentImageData,
                        newWidth, 
                        newHeight, 
                        (p, m) => self.postMessage({ status: 'progress', percentage: p, message: m }),
                        overallProgress,
                        UPSCALE_STAGE_WEIGHT 
                     );
                }
                overallProgress += 100 * UPSCALE_STAGE_WEIGHT;
                self.postMessage({ status: 'progress', percentage: overallProgress, message: 'Upscaling selesai. Memulai Crop...' });


                if (params.cropPercent > 0) {
                     await new Promise(resolve => setTimeout(resolve, 50)); 
                    currentImageData = cropImageData(currentImageData, params.cropPercent);
                     self.postMessage({ status: 'progress', percentage: overallProgress + (50 * CROP_STAGE_WEIGHT), message: `Cropping... 50%`}); 
                     await new Promise(resolve => setTimeout(resolve, 50)); 
                }
                overallProgress += 100 * CROP_STAGE_WEIGHT; 
                overallProgress = Math.min(overallProgress, 99); 

                self.postMessage({ status: 'progress', percentage: overallProgress, message: 'Cropping selesai.' });
                
                await new Promise(resolve => setTimeout(resolve, 50));
                self.postMessage({ status: 'complete', imageData: currentImageData, message: 'Pemrosesan gambar selesai!' });

            } catch (error) {
                console.error('Error in imageProcessorWorker:', error);
                self.postMessage({ status: 'error', message: error.message + (error.stack ? "\nStack: " + error.stack : "") });
            }
        };
        // --- End of Embedded Worker Code ---
    </script>


    <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai",
        "dompurify": "https://esm.run/dompurify",
        "tesseract.js": "https://esm.run/tesseract.js@5",
        "pdfjs-dist": "https://esm.run/pdfjs-dist@4.0.379/build/pdf.mjs",
        "xlsx": "https://esm.run/xlsx@0.18.5"
      }
    }
    </script>

    <script type="module">
        import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from "@google/generative-ai";
        import DOMPurify from 'dompurify';
        import Tesseract from 'tesseract.js';
        import * as pdfjsLib from "pdfjs-dist";
        import * as XLSX from "xlsx";

        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://esm.run/pdfjs-dist@4.0.379/build/pdf.worker.mjs";

        let loading_textToType_val;
        let loading_NUM_SHARDS_val;
        let loading_SHARD_SPREAD_MIN_val;
        let loading_SHARD_SPREAD_MAX_val;
        let loading_speedFactor_val;
        let loading_D_LOGO_APPEAR_GROW_val;
        let loading_D_LOGO_SHRINK_SLIGHTLY_val;
        let loading_D_SHARDS_BURST_val;
        let loading_D_SHARDS_FADE_val;
        let loading_D_LOGO_MOVE_LEFT_val;
        let loading_D_TEXT_CONTAINER_APPEAR_val;
        let loading_D_TEXT_CHAR_TRANSITION_val;
        let loading_D_TEXT_CHAR_STAGGER_DELAY_val;
        let loading_D_OVERLAY_SLIDE_DOWN_val;
        let loading_DELAY_START_val;
        let loading_DELAY_LOGO_GROW_TO_SHRINK_val;
        let loading_DELAY_SHARDS_START_OFFSET_val;
        let loading_D_TOTAL_SHARD_LIFESPAN_val;
        let loading_DELAY_LOGO_SHRINK_TO_MOVE_val;
        let loading_DELAY_AFTER_LOGO_MOVED_AND_SHARDS_STARTED_FADING_val;
        let loading_DELAY_TEXT_CONTAINER_TO_CHARS_ANIM_val;
        let loading_TOTAL_TEXT_ANIMATION_DURATION_val;
        let loading_DELAY_AFTER_TEXT_END_val;
        let loading_targetLogoLeftPx_val;

        const ACTUAL_API_KEY = "AIzaSyCABGEFl5t2vimo69p6JrJr0kHVI5HujmE"; 
        const SCRAPER_PHP_URL = "https://femzlabs.unaux.com/scraper.php"; 

        const CHATAI_MODEL_NAME = "gemini-2.5-flash-preview-05-20"; 

        const POLLINATIONS_BASE_URL = "https://image.pollinations.ai/prompt/";
        let currentImageAI_AspectRatio = "1:1"; 
        const imageAI_AspectRatios_WithCrop = { 
            "1:1":  { width: 2048, height: 2048, cropPercent: 0.058 }, 
            "3:4":  { width: 1536,  height: 2048, cropPercent: 0.05  },
            "4:3":  { width: 2048, height: 1536,  cropPercent: 0.074  },
            "9:16": { width: 1152,  height: 2048, cropPercent: 0.05  },
            "16:9": { width: 2048, height: 1152,  cropPercent: 0.1 }
        };

        const imageEnhancementParams = {
            denoiseStrength: 30,        
            denoiseSpatialSigma: 1.5,
            sharpenAmount: 1.0,         
            sharpenRadius: 1.0, 
        };


        let currentImageAI_PollinationsModel = "flux"; 
        const imageAI_PollinationsModels = ["flux", "sdxl", "dreamshaper", "dall-e-3", "playgroundai"];

        const forbiddenKeywords = [
            "uy", 
        ];


        let currentGeminiModelName = CHATAI_MODEL_NAME;
        let currentAppMode = 'chatai';

        const TYPING_SPEED_MS_PER_CHAR = 5;
        const TYPING_BATCH_CHARS = 20;
        const MAX_CHAT_HISTORY = 20;
        const MIN_IMAGE_LOADING_DISPLAY_MS = 800; 
        const MIN_IMAGE_PROCESSING_DISPLAY_MS = 800; 

        const sendIconSVG = `<svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>`;
        const stopIconSVG = `<svg viewBox="0 0 24 24"><path d="M6 6h12v12H6z"></path></svg>`;
        const openIconSVG = `<svg viewBox="0 0 24 24"><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14l-6-6z"></path></svg>`;
        const collapseIconSVG = `<svg class="icon-input-collapse" viewBox="0 0 24 24"><path d="M12 16l-6-6 1.41-1.41L12 13.17l4.59-4.58L18 10l-6 6z"></path></svg>`;
        const addAttachmentIconSVG = `<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>`;
        const aspectRatioIconSVG = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"></path></svg>`; // Aspect ratio
        const deepThinkIconSVG = `<svg viewBox="0 0 24 24"> <path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16H10v-2.3l-.85-.6C7.96 12.49 7 10.86 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.86-.96 3.49-2.15 4.1z"></path> </svg>`;
        const imageModelIconSVG = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 18.54l-7.37-5.73L3 14.07l9 7 9-7-1.63-1.27-7.38 5.74zM12 16l7.36-5.73L21 9l-9-7-9 7 1.63 1.27L12 16z"></path></svg>`; // Image Model
        const copyIconSVG = `<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>`;
        const checkIconSVG = `<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></svg>`;
        const downloadIconSVG = `<svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>`;
        const expandIconSVG = `<svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"></path></svg>`;


        const fileIcons = {
            pdf: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"></path></svg>`,
            txt: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"></path></svg>`,
            js: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"></path><text x="6" y="19" font-family="Arial" font-size="5" fill="currentColor">JS</text></svg>`,
            py: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"></path><text x="6" y="19" font-family="Arial" font-size="5" fill="currentColor">PY</text></svg>`,
            generic: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M6 2c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6H6zm7 7V3.5L18.5 9H13z"></path></svg>`
        };


        const MAX_FILE_SIZE_BYTES = 20 * 1024 * 1024;
        const GEMINI_SUPPORTED_MIME_MAP = {
            '.pdf': 'application/pdf', '.js': 'text/javascript', '.py': 'text/x-python',
            '.txt': 'text/plain', '.html': 'text/html', '.css': 'text/css', '.md': 'text/markdown',
            '.csv': 'text/csv', '.xml': 'application/xml', '.rtf': 'application/rtf',
            '.java': 'text/plain', '.json': 'application/json',
        };
        const EXCEL_EXTENSIONS = ['.xlsx', '.xls'];

        let currentOcrFile = null;
        let currentTesseractWorker = null;
        let attachedFile = { fileObject: null, type: null, dataUrl: null, name: null, extractedText: null, base64Data: null, fileMimeType: null, previewHTML: null };
        let genAI;
        let userHasInteractedWithScroll = false;
        let currentAiMessageBubble = null;
        let temporaryThinkingBubble = null;


        let chatHistory = [];
        let isTypingAnimationActive = false;
        let isGeneratingImage = false; 
        let isProcessingImageClientSide = false; 
        let abortGenerationRequested = false;
        let isDeepThinking = false;

        let currentTurnUserIntent = {
            text: null,
            attachmentInfo: null
        };

        let isRoleResettedForNextInteraction = false;
        let confirmCallback = null;
        let cancelCallback = null;

        let isToolsPanelVisible = false;
        let isInputElementsVisible = true;

        let chatContainer, userInput, sendBtn,
            downloadChatBtn, resetRoleBtn, darkModeToggleBtn,
            closeSidebarBtn, sidebar, deepThinkBtnContainer, deepThinkBtn, imageAIPollinationsModelMenu,
            fileActionsBtn, fileActionsMenu,
            imageAttachmentInput, documentAttachmentInput, attachmentPreviewArea, attachmentPreviewContent, attachmentPreviewIconContainer, attachedPreviewInfo,
            removeAttachmentBtn, ocrModal, ocrModalCloseBtn, ocrImageInput, ocrImageInputLabel,
            ocrSelectedFilename, ocrImagePreviewContainer, ocrImagePreview, ocrScanBtn, ocrStatusArea,
            ocrProgressStatusText, ocrResultText, ocrCopyBtn, ocrSendToChatBtn,
            customDialogOverlay, customDialogTitle, customDialogMessage, customDialogBtnConfirm,
            customDialogBtnCancel, currentYearSpan, appLayoutContainer, appTitle,
            artifactViewerModal, artifactViewerTitle, artifactViewerModalBody, artifactViewerCopyBtn, artifactViewerDownloadBtn, artifactViewerCloseBtn,
            modalActionsBar, 
            menuToggleFloating, toggleToolsPanelBtn, toolsPanel,
            toggleInputElementsBtn, inputElementsContainer, inputActionsRow, openInputAreaBtn, inputAreaWrapper,
            modelSwitcherBtn, modelSwitcherDropdown, currentModelNameSpan;

        let imageProcessorWorker;

        
        function createAndAnimateShards_loading() {
            const loadingLogoEl = document.getElementById('loading-logo');
            const shardsContainerEl = document.getElementById('shards-container');
            if (!loadingLogoEl || !shardsContainerEl) return;
            const logoCurrentWidth = parseFloat(window.getComputedStyle(loadingLogoEl).width) || 80;
            const baseRadius = logoCurrentWidth * 0.4;
            for (let i = 0; i < loading_NUM_SHARDS_val; i++) {
                const shard = document.createElement('div');
                shard.classList.add('shard');
                shard.style.transform = `translate(0px, 0px) scale(0.2) rotate(${Math.random() * 90 - 45}deg)`;
                shard.style.opacity = '0';
                shardsContainerEl.appendChild(shard);
                const angle = Math.random() * 2 * Math.PI;
                const radius = baseRadius + loading_SHARD_SPREAD_MIN_val + Math.random() * (loading_SHARD_SPREAD_MAX_val - loading_SHARD_SPREAD_MIN_val);
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);
                const rotation = Math.random() * 360 - 180;
                const finalScale = 0.4 + Math.random() * 0.7;
                const burstDelay = Math.random() * (200 / loading_speedFactor_val);
                shard.style.transition = `transform ${loading_D_SHARDS_BURST_val/1000}s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity ${(loading_D_SHARDS_BURST_val * 0.5)/1000}s ease-out`;
                setTimeout(() => { shard.style.opacity = '0.85'; shard.style.transform = `translate(${x}px, ${y}px) rotate(${rotation}deg) scale(${finalScale})`; }, burstDelay);
                const fadeOutStartDelay = burstDelay + loading_D_SHARDS_BURST_val - (loading_D_SHARDS_FADE_val * 0.3);
                setTimeout(() => {
                    shard.style.opacity = '0';
                    shard.style.transform = `translate(${x * 1.1}px, ${y * 1.1}px) rotate(${rotation + 20}deg) scale(${finalScale * 0.15})`;
                    shard.style.transition = `transform ${loading_D_SHARDS_FADE_val/1000}s cubic-bezier(0.755, 0.05, 0.855, 0.06), opacity ${loading_D_SHARDS_FADE_val/1000}s ease-in`;
                }, fadeOutStartDelay);
            }
            const cleanupDelay = loading_D_TOTAL_SHARD_LIFESPAN_val + (200 / loading_speedFactor_val);
            setTimeout(() => { if (shardsContainerEl) shardsContainerEl.innerHTML = ''; }, cleanupDelay);
        }

        function animateTextCharacters_loading() {
            const loadingTextEl = document.getElementById('loading-text');
            if (!loadingTextEl) return;
            loadingTextEl.innerHTML = '';
            const chars = loading_textToType_val.split('');
            chars.forEach((char, index) => {
                const span = document.createElement('span');
                span.textContent = char === ' ' ? '\u00A0' : char;
                span.classList.add('char-animated');
                loadingTextEl.appendChild(span);
                setTimeout(() => { span.classList.add('visible'); }, index * loading_D_TEXT_CHAR_STAGGER_DELAY_val);
            });
        }
        
        function updateInputAreaVisibility() {
            if (!inputElementsContainer || !userInput || !inputAreaWrapper) return;

            const anyModalCurrentlyOpen = isAnyModalOpen();

            if (isInputElementsVisible) {
                inputElementsContainer.style.display = 'flex';
                inputAreaWrapper.classList.remove('input-closed');
                userInput.disabled = anyModalCurrentlyOpen;

                if (toggleInputElementsBtn) {
                    toggleInputElementsBtn.innerHTML = collapseIconSVG;
                    toggleInputElementsBtn.title = "Sembunyikan Area Input";
                }

                if (!userInput.disabled) {
                    requestAnimationFrame(() => {
                        if (userInput && !userInput.disabled && document.activeElement !== userInput) {
                            userInput.focus();
                        }
                    });
                }

                setTimeout(() => {
                    if (isInputElementsVisible) adjustLayout();
                }, 310);

            } else { 
                inputAreaWrapper.classList.add('input-closed');
                userInput.disabled = true; 
                if (document.activeElement === userInput) {
                    userInput.blur();
                }
                setTimeout(() => {
                    if (!isInputElementsVisible) inputElementsContainer.style.display = 'none';
                    adjustLayout();
                }, 310);
            }
            updateBodyBlur_HandleStatesOnly(); 
        }


        function updateBodyBlur_HandleStatesOnly() {
            const anyModalOpen = isAnyModalOpen();
            document.body.classList.toggle('modal-open-blur', anyModalOpen);
            setButtonStateForProcessing(isTypingAnimationActive || isGeneratingImage || isProcessingImageClientSide);
        }


        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlayEl = document.getElementById('loading-overlay');
            const animationContainerEl = document.getElementById('animation-container');
            const loadingLogoEl = document.getElementById('loading-logo');
            const loadingTextContainerEl = document.getElementById('loading-text-container');
            appLayoutContainer = document.getElementById('app-layout-container');

            loading_textToType_val = "FlabsAI";
            loading_NUM_SHARDS_val = 22;
            loading_SHARD_SPREAD_MIN_val = 45;
            loading_SHARD_SPREAD_MAX_val = 110;
            loading_speedFactor_val = 1.5;
            loading_D_LOGO_APPEAR_GROW_val = 1200 / loading_speedFactor_val;
            loading_D_LOGO_SHRINK_SLIGHTLY_val = 600 / loading_speedFactor_val;
            loading_D_SHARDS_BURST_val = 800 / loading_speedFactor_val;
            loading_D_SHARDS_FADE_val = 700 / loading_speedFactor_val;
            loading_D_LOGO_MOVE_LEFT_val = 1000 / loading_speedFactor_val;
            loading_D_TEXT_CONTAINER_APPEAR_val = 400 / loading_speedFactor_val;
            loading_D_TEXT_CHAR_TRANSITION_val = 500 / loading_speedFactor_val;
            loading_D_TEXT_CHAR_STAGGER_DELAY_val = 100 / loading_speedFactor_val;
            loading_D_OVERLAY_SLIDE_DOWN_val = 1200;
            loading_DELAY_START_val = 300 / loading_speedFactor_val;
            loading_DELAY_LOGO_GROW_TO_SHRINK_val = 150 / loading_speedFactor_val;
            loading_DELAY_SHARDS_START_OFFSET_val = 150 / loading_speedFactor_val;
            loading_D_TOTAL_SHARD_LIFESPAN_val = loading_D_SHARDS_BURST_val + loading_D_SHARDS_FADE_val + (100 / loading_speedFactor_val);
            loading_DELAY_LOGO_SHRINK_TO_MOVE_val = 200 / loading_speedFactor_val;
            loading_DELAY_AFTER_LOGO_MOVED_AND_SHARDS_STARTED_FADING_val = 50 / loading_speedFactor_val;
            loading_DELAY_TEXT_CONTAINER_TO_CHARS_ANIM_val = 50 / loading_speedFactor_val;
            loading_TOTAL_TEXT_ANIMATION_DURATION_val = (loading_textToType_val.length - 1) * loading_D_TEXT_CHAR_STAGGER_DELAY_val + loading_D_TEXT_CHAR_TRANSITION_val;
            loading_DELAY_AFTER_TEXT_END_val = 500;

            let currentTime = loading_DELAY_START_val;
            const logoAppearStartTime = currentTime;
            setTimeout(() => {
                loadingLogoEl.style.opacity = '1';
                loadingLogoEl.style.transform = 'translate(-50%, -50%) scale(1.15)';
                loadingLogoEl.style.width = '92px';
                setTimeout(createAndAnimateShards_loading, loading_DELAY_SHARDS_START_OFFSET_val);
            }, logoAppearStartTime);
            const shardsActualStartTime = logoAppearStartTime + loading_DELAY_SHARDS_START_OFFSET_val;
            const shardsBurstEndTime = shardsActualStartTime + loading_D_SHARDS_BURST_val;
            const logoAppearEndTime = logoAppearStartTime + loading_D_LOGO_APPEAR_GROW_val;
            currentTime = logoAppearEndTime + loading_DELAY_LOGO_GROW_TO_SHRINK_val;
            const logoShrinkStartTime = currentTime;
            setTimeout(() => {
                loadingLogoEl.style.transform = 'translate(-50%, -50%) scale(1)';
                loadingLogoEl.style.width = '80px';
            }, logoShrinkStartTime);
            const logoShrinkEndTime = logoShrinkStartTime + loading_D_LOGO_SHRINK_SLIGHTLY_val;
            currentTime = logoShrinkEndTime + loading_DELAY_LOGO_SHRINK_TO_MOVE_val;
            const logoMoveStartTime = currentTime;
            const logoFinalWidth = 80;
            const logoTargetLeftPercent = 0.235;
            setTimeout(() => {
                const animContainerWidth = animationContainerEl.offsetWidth;
                loading_targetLogoLeftPx_val = animContainerWidth * logoTargetLeftPercent;
                loadingLogoEl.style.left = `${loading_targetLogoLeftPx_val}px`;
                loadingLogoEl.style.transform = `translate(0, -50%) scale(1)`;
            }, logoMoveStartTime);
            const logoMoveEndTime = logoMoveStartTime + loading_D_LOGO_MOVE_LEFT_val;
            currentTime = Math.max(logoMoveEndTime, shardsBurstEndTime) + loading_DELAY_AFTER_LOGO_MOVED_AND_SHARDS_STARTED_FADING_val;
            const textContainerAppearStartTime = currentTime;
            setTimeout(() => {
                const textGap = 12;
                const textContainerLeftPx = loading_targetLogoLeftPx_val + logoFinalWidth + textGap;
                loadingTextContainerEl.style.left = `${textContainerLeftPx}px`;
                loadingTextContainerEl.style.opacity = '1';
            }, textContainerAppearStartTime);
            currentTime = textContainerAppearStartTime + loading_D_TEXT_CONTAINER_APPEAR_val + loading_DELAY_TEXT_CONTAINER_TO_CHARS_ANIM_val;
            const textCharsAnimateStartTime = currentTime;
            setTimeout(animateTextCharacters_loading, textCharsAnimateStartTime);
            currentTime = textCharsAnimateStartTime + loading_TOTAL_TEXT_ANIMATION_DURATION_val + loading_DELAY_AFTER_TEXT_END_val;
            const overlaySlideDownStartTime = currentTime;

            setTimeout(() => {
                if (appLayoutContainer) appLayoutContainer.style.display = 'flex';
                initAndStartChatApp();
                setTimeout(() => {
                    if (loadingOverlayEl) loadingOverlayEl.style.transform = 'translateY(100%)';
                    setTimeout(() => {
                        if (loadingOverlayEl) loadingOverlayEl.style.display = 'none';
                        document.documentElement.classList.remove('dark-mode-loading-init');
                    }, loading_D_OVERLAY_SLIDE_DOWN_val);
                }, 50);
            }, overlaySlideDownStartTime);
        });

        function initImageProcessorWorker() {
            try {
                const workerScriptElement = document.getElementById('imageProcessorWorkerScript');
                if (!workerScriptElement) throw new Error("Image processor worker script element not found.");
                const workerCode = workerScriptElement.textContent;
                const blob = new Blob([workerCode], { type: 'application/javascript' });
                imageProcessorWorker = new Worker(URL.createObjectURL(blob));

                imageProcessorWorker.onmessage = function(e) {
                    const data = e.data;
                    const currentBubble = temporaryThinkingBubble; 

                    if (data.status === 'progress') {
                        if (currentBubble && currentBubble.closest('.message')) { 
                            const progressBarEl = currentBubble.querySelector('.image-process-progress-bar');
                            const statusTextEl = currentBubble.querySelector('.image-process-status-text');
                            if (progressBarEl) {
                                progressBarEl.style.width = data.percentage + '%';
                                progressBarEl.textContent = Math.round(data.percentage) + '%';
                            }
                            if (statusTextEl) statusTextEl.textContent = data.message || `Memproses... ${Math.round(data.percentage)}%`;
                        }
                    } else if (data.status === 'complete') {
                        if (currentBubble && currentBubble.closest('.message')) { 
                             const parentMessageDiv = currentBubble.closest('.message');
                             if (parentMessageDiv) {
                                const imageAIData = JSON.parse(parentMessageDiv.dataset.imageaidata || '{}');
                                
                                const canvas = document.createElement('canvas');
                                canvas.width = data.imageData.width;
                                canvas.height = data.imageData.height;
                                const ctx = canvas.getContext('2d');
                                ctx.putImageData(data.imageData, 0, 0);

                                imageAIData.processedCanvasDataUrl = canvas.toDataURL('image/png');
                                parentMessageDiv.dataset.imageaidata = JSON.stringify(imageAIData); 

                                const existingImagePlaceholder = currentBubble.querySelector('.image-placeholder');
                                const existingThinkingLoader = currentBubble.querySelector('.image-placeholder .thinking-loader');
                                const existingImgElement = currentBubble.querySelector('.pollinations-generated-image');
                                const existingCanvasElement = currentBubble.querySelector('.processed-image-canvas');
                                const existingStatusText = currentBubble.querySelector('.image-process-status-text');
                                const existingProgressBarContainer = currentBubble.querySelector('.image-process-progress-bar-container');
                                const existingMetaInfo = currentBubble.querySelector('.image-meta-info');
                                const existingSupportText = currentBubble.querySelector('.pollinations-support-text');

                                if (existingThinkingLoader) existingThinkingLoader.style.display = 'none';
                                if (existingImgElement) existingImgElement.style.display = 'none'; 
                                if (existingStatusText) existingStatusText.style.display = 'none';
                                if (existingProgressBarContainer) existingProgressBarContainer.style.display = 'none';

                                if (existingCanvasElement) {
                                    existingCanvasElement.width = canvas.width;
                                    existingCanvasElement.height = canvas.height;
                                    existingCanvasElement.getContext('2d').drawImage(canvas, 0, 0);
                                    existingCanvasElement.style.display = 'block';
                                }
                                if (existingMetaInfo) existingMetaInfo.textContent = `Model: ${DOMPurify.sanitize(imageAIData.model)} | Rasio: ${DOMPurify.sanitize(imageAIData.aspectRatio)} | Diproses (2x Upscaled)`;
                                if (existingSupportText) existingSupportText.textContent = `FlabsAI didukung Pollinations & ImageProcessor`;
                                
                                currentBubble.querySelector('.pollinations-image-display-container').classList.remove('loading-initial');


                                addMessageActions(parentMessageDiv, `[Gambar (2x upscaled) diproses untuk: ${imageAIData.prompt}]`, imageAIData, true);
                                addMessageToChatHistory("model", [{ text: `Image (2x upscaled) processed for: ${imageAIData.prompt}` }], null, `Processed (2x Upscaled) - Model: ${imageAIData.model}, Ratio: ${imageAIData.aspectRatio}`, true);
                             }
                        } else if (currentBubble && !currentBubble.closest('.message')) {
                            console.warn("Worker completed, but its target bubble (temporaryThinkingBubble) was removed from DOM, likely due to user abort.");
                        }
                        isProcessingImageClientSide = false;
                        setButtonStateForProcessing(false);
                        currentTurnUserIntent = { text: null, attachmentInfo: null }; 
                        temporaryThinkingBubble = null;
                    } else if (data.status === 'error') {
                         handleImageProcessingError('Error dari image processor: ' + data.message);
                    }
                };
                imageProcessorWorker.onerror = function(error) {
                    handleImageProcessingError("Gagal menjalankan image processor worker: " + error.message);
                };
                console.log("Image Processor Worker initialized.");
            } catch (error) {
                 handleImageProcessingError("Gagal inisialisasi Image Processor Worker: " + error.message + ". Pemrosesan gambar ImageAI tidak akan berfungsi.");
                 isProcessingImageClientSide = false; 
                 setButtonStateForProcessing(false);
            }
        }

        function handleImageProcessingError(errorMessage) {
            console.error(errorMessage);
            if (temporaryThinkingBubble && temporaryThinkingBubble.closest('.message')) {
                temporaryThinkingBubble.innerHTML = DOMPurify.sanitize(`<p><i>${errorMessage}</i></p>`, domPurifyConfig);
                if (temporaryThinkingBubble.closest('.message')) {
                    temporaryThinkingBubble.closest('.message').classList.add("error-message");
                    addMessageActions(temporaryThinkingBubble.closest('.message'), errorMessage);
                }
            }
            isProcessingImageClientSide = false;
            isGeneratingImage = false; 
            setButtonStateForProcessing(false);
            temporaryThinkingBubble = null;
        }


        function initAndStartChatApp() {
            chatContainer = document.getElementById("chat-container");
            userInput = document.getElementById("userInput");
            sendBtn = document.getElementById("sendBtn");
            downloadChatBtn = document.getElementById("download-chat-btn");
            resetRoleBtn = document.getElementById("reset-role-btn");
            darkModeToggleBtn = document.getElementById("dark-mode-toggle-btn");
            closeSidebarBtn = document.getElementById("close-sidebar-btn");
            sidebar = document.getElementById("sidebar");

            deepThinkBtnContainer = document.getElementById('deepthink-btn-container');
            deepThinkBtn = document.getElementById('deepthink-btn');
            imageAIPollinationsModelMenu = document.getElementById('imageai-pollinations-model-menu');

            fileActionsBtn = document.getElementById('file-actions-btn');
            fileActionsMenu = document.getElementById('file-actions-menu');

            imageAttachmentInput = document.getElementById('image-attachment-input');
            documentAttachmentInput = document.getElementById('document-attachment-input');
            attachmentPreviewArea = document.getElementById('attachment-preview-area');
            attachmentPreviewContent = document.getElementById('attachment-preview-content');
            attachmentPreviewIconContainer = document.getElementById('attachment-preview-icon-container');
            attachedPreviewInfo = document.getElementById('attached-preview-info');
            removeAttachmentBtn = document.getElementById('remove-attachment-btn');
            
            ocrModal = document.getElementById('ocr-modal');
            ocrModalCloseBtn = document.getElementById('ocr-modal-close-btn');
            ocrImageInput = document.getElementById('ocr-image-input');
            ocrImageInputLabel = document.querySelector('label[for="ocr-image-input"]');
            ocrSelectedFilename = document.getElementById('ocr-selected-filename');
            ocrImagePreviewContainer = document.getElementById('ocr-image-preview-container');
            ocrImagePreview = document.getElementById('ocr-image-preview');
            ocrScanBtn = document.getElementById('ocr-scan-btn');
            ocrStatusArea = document.getElementById('ocr-status-area');
            ocrProgressStatusText = document.getElementById('ocr-progress-status-text');
            ocrResultText = document.getElementById('ocr-result-text');
            ocrCopyBtn = document.getElementById('ocr-copy-btn');
            ocrSendToChatBtn = document.getElementById('ocr-send-to-chat-btn');
            
            artifactViewerModal = document.getElementById('artifact-viewer-modal');
            artifactViewerTitle = document.getElementById('artifact-viewer-title');
            artifactViewerModalBody = document.getElementById('artifact-viewer-modal-body');
            artifactViewerCopyBtn = document.getElementById('artifact-viewer-copy-btn');
            artifactViewerDownloadBtn = document.getElementById('artifact-viewer-download-btn');
            artifactViewerCloseBtn = document.getElementById('artifact-viewer-close-btn');
            modalActionsBar = artifactViewerModal.querySelector('.modal-actions-bar');
            
            customDialogOverlay = document.getElementById('custom-dialog-overlay');
            customDialogTitle = document.getElementById('custom-dialog-title');
            customDialogMessage = document.getElementById('custom-dialog-message');
            customDialogBtnConfirm = document.getElementById('custom-dialog-btn-confirm');
            customDialogBtnCancel = document.getElementById('custom-dialog-btn-cancel');
            currentYearSpan = document.getElementById('current-year');
            inputAreaWrapper = document.getElementById('input-area-wrapper');
            appTitle = document.getElementById('app-title');

            menuToggleFloating = document.getElementById('menu-toggle-floating');
            toggleToolsPanelBtn = document.getElementById('toggle-tools-panel-btn');
            toolsPanel = document.getElementById('tools-panel');
            toggleInputElementsBtn = document.getElementById('toggle-input-elements-btn');
            inputElementsContainer = document.getElementById('input-elements-container');
            inputActionsRow = document.getElementById('input-actions-row');
            openInputAreaBtn = document.getElementById('open-input-area-btn');

            modelSwitcherBtn = document.getElementById('model-switcher-btn');
            modelSwitcherDropdown = document.getElementById('model-switcher-dropdown');
            currentModelNameSpan = document.getElementById('current-model-name');

            initImageProcessorWorker(); 

            loadDarkModePreference();

            appTitle.textContent = currentAppMode === 'chatai' ? "ChatAI" : "ImageAI";

            if(toggleInputElementsBtn) toggleInputElementsBtn.innerHTML = collapseIconSVG;
            if(openInputAreaBtn) openInputAreaBtn.innerHTML = openIconSVG;


            if(currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();
            if(userInput) {
                userInput.addEventListener('input', () => { adjustLayout(); updateSendButtonState(); });
                userInput.addEventListener('focus', () => { 
                    adjustLayout();
                });
            }
            window.addEventListener('resize', adjustLayout);


            if(customDialogBtnConfirm) customDialogBtnConfirm.addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                closeModal(customDialogOverlay);
                confirmCallback = null; cancelCallback = null;
            });
            if(customDialogBtnCancel) customDialogBtnCancel.addEventListener('click', () => {
                if (cancelCallback) cancelCallback();
                closeModal(customDialogOverlay);
                confirmCallback = null; cancelCallback = null;
            });

            if(menuToggleFloating) menuToggleFloating.addEventListener('click', toggleSidebar);
            if(closeSidebarBtn) closeSidebarBtn.addEventListener('click', toggleSidebar);
            if(darkModeToggleBtn) darkModeToggleBtn.addEventListener('click', toggleDarkMode);

            if(toggleToolsPanelBtn && toolsPanel && appTitle) {
                appTitle.classList.add('visible');
                toolsPanel.classList.remove('visible');
                isToolsPanelVisible = false;

                toggleToolsPanelBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    isToolsPanelVisible = !isToolsPanelVisible;
                    toolsPanel.classList.toggle('visible', isToolsPanelVisible);
                    appTitle.classList.toggle('visible', !isToolsPanelVisible);

                    const iconDown = toggleToolsPanelBtn.querySelector('.icon-tools-down');
                    const iconUp = toggleToolsPanelBtn.querySelector('.icon-tools-up');
                    if (iconDown && iconUp) {
                        iconDown.style.display = isToolsPanelVisible ? 'none' : 'inline-block';
                        iconUp.style.display = isToolsPanelVisible ? 'inline-block' : 'none';
                    }
                    toggleToolsPanelBtn.title = isToolsPanelVisible ? "Sembunyikan Alat" : "Tampilkan Alat";
                });
                document.addEventListener('click', (event) => {
                    if (isToolsPanelVisible && toolsPanel && !toolsPanel.contains(event.target) && !toggleToolsPanelBtn.contains(event.target)) {
                        isToolsPanelVisible = false;
                        toolsPanel.classList.remove('visible');
                        appTitle.classList.add('visible');
                        const iconDown = toggleToolsPanelBtn.querySelector('.icon-tools-down');
                        const iconUp = toggleToolsPanelBtn.querySelector('.icon-tools-up');
                        if (iconDown && iconUp) { iconDown.style.display = 'inline-block'; iconUp.style.display = 'none';}
                        toggleToolsPanelBtn.title = "Tampilkan Alat";
                    }
                });
            }

            if(toggleInputElementsBtn) {
                toggleInputElementsBtn.addEventListener('click', () => {
                    isInputElementsVisible = false;
                    updateInputAreaVisibility(); 
                });
            }

            if(openInputAreaBtn) {
                 openInputAreaBtn.addEventListener('click', () => {
                    if (!isInputElementsVisible) {
                        isInputElementsVisible = true;
                        updateInputAreaVisibility();
                    }
                });
            }

            isInputElementsVisible = true; 


            if(downloadChatBtn) downloadChatBtn.addEventListener('click', () => {
                if (isTypingAnimationActive || isGeneratingImage || isProcessingImageClientSide) { showCustomDialog("Peringatan", "Harap tunggu proses AI selesai.", "alert"); return; }
                if (chatHistory.length === 0) { showCustomDialog("Informasi", "Tidak ada riwayat chat.", "alert"); return; }
                let historyText = `Riwayat Percakapan FlabsAI (${currentAppMode.toUpperCase()}) - ${new Date().toLocaleString()}\n\n`;
                chatHistory.forEach(entry => {
                    const role = entry.role === 'user' ? 'Pengguna' : (currentAppMode === 'imageai' ? 'ImageAI' : 'FlabsAI');
                    let textContent = "";
                    if (entry.parts && entry.parts.length > 0) {
                        const textPart = entry.parts.find(p => p.text);
                        if (textPart) textContent = textPart.text;

                        const imagePart = entry.parts.find(p => (p.inlineData && p.inlineData.mimeType.startsWith('image/')) || p.imageUrl || p.processedCanvasDataUrl);
                        if (imagePart && role !== 'Pengguna') { 
                            textContent += (textContent ? "\n" : "") + `[Gambar ${entry.isProcessedImage ? "diproses (2x upscaled)" : "dihasilkan"} oleh AI${entry.imageMeta ? ` (${entry.imageMeta})` : ''}]`;
                        }
                    }

                    if (entry.role === 'user' && entry.attachment) {
                        let attachmentDesc = `[Lampiran ${entry.attachment.type === 'image' ? 'gambar' : 'dokumen'}: ${entry.attachment.name || 'file'}]`;
                        textContent += (textContent ? "\n" : "") + attachmentDesc;
                    }
                    historyText += `${role}:\n${textContent || "(Konten tidak ada atau hanya gambar)"}\n\n--------------------\n\n`;
                });
                const blob = new Blob([historyText], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `FlabsAI_${currentAppMode.toUpperCase()}_History_${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href);
                showCustomDialog("Sukses", "Riwayat chat telah diunduh!", "alert");
            });
            if(resetRoleBtn) resetRoleBtn.addEventListener('click', () => {
                if (isTypingAnimationActive || isGeneratingImage || isProcessingImageClientSide) { showCustomDialog("Peringatan", "Harap tunggu proses AI selesai.", "alert"); return; }
                showCustomDialog("Konfirmasi Reset Peran", "Yakin ingin mereset peran AI? Riwayat chat saat ini akan tetap ada, namun AI akan memulai konteks baru.", "confirm", () => {
                    isRoleResettedForNextInteraction = true;
                    addMessageToUI("system-info", "<p><i>Peran AI telah direset untuk interaksi berikutnya.</i></p>");
                });
            });
            let scrollTimeout;
            if(chatContainer) chatContainer.addEventListener('scroll', () => {
                if (chatContainer.scrollTop + chatContainer.clientHeight < chatContainer.scrollHeight - 50) userHasInteractedWithScroll = true;
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => { if (chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - 15) userHasInteractedWithScroll = false; }, 300);
            });

            if(deepThinkBtn) deepThinkBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                if (isTypingAnimationActive || isGeneratingImage || isProcessingImageClientSide) return;

                if (currentAppMode === 'chatai') {
                    isDeepThinking = !isDeepThinking;
                    deepThinkBtn.classList.toggle('active', isDeepThinking);
                    deepThinkBtn.title = isDeepThinking ? "Mode Berpikir Mendalam (Aktif)" : "Mode Berpikir Mendalam";
                } else {
                    closeOtherDropdowns(imageAIPollinationsModelMenu);
                    const isOpen = imageAIPollinationsModelMenu.style.display === 'block';
                    imageAIPollinationsModelMenu.style.display = isOpen ? 'none' : 'block';
                    deepThinkBtn.classList.toggle('open', !isOpen);
                }
            });


            if(fileActionsBtn) fileActionsBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                if (isTypingAnimationActive || isGeneratingImage || isProcessingImageClientSide) return;
                closeOtherDropdowns(fileActionsMenu);
                const isOpen = fileActionsMenu.style.display === 'block';
                fileActionsMenu.style.display = isOpen ? 'none' : 'block';
                fileActionsBtn.classList.toggle('open', !isOpen);
            });

            document.addEventListener('click', (event) => {
                const target = event.target;
                if (fileActionsMenu && fileActionsMenu.style.display === 'block' && !fileActionsBtn.contains(target) && !fileActionsMenu.contains(target)) {
                    fileActionsMenu.style.display = 'none';
                    fileActionsBtn.classList.remove('open');
                }
                if (modelSwitcherDropdown && modelSwitcherDropdown.style.display === 'block' && !modelSwitcherBtn.contains(target) && !modelSwitcherDropdown.contains(target)) {
                    modelSwitcherDropdown.style.display = 'none';
                    modelSwitcherBtn.classList.remove('open');
                }
                if (imageAIPollinationsModelMenu && imageAIPollinationsModelMenu.style.display === 'block' && !deepThinkBtn.contains(target) && !imageAIPollinationsModelMenu.contains(target)) {
                    imageAIPollinationsModelMenu.style.display = 'none';
                    deepThinkBtn.classList.remove('open');
                }
            });


            if(modelSwitcherBtn) modelSwitcherBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                if (isTypingAnimationActive || isGeneratingImage || isProcessingImageClientSide) return;
                closeOtherDropdowns(modelSwitcherDropdown);
                const isOpen = modelSwitcherDropdown.style.display === 'block';
                modelSwitcherDropdown.style.display = isOpen ? 'none' : 'block';
                modelSwitcherBtn.classList.toggle('open', !isOpen);
            });

            if(modelSwitcherDropdown) {
                modelSwitcherDropdown.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', () => {
                        const newMode = button.dataset.model;
                        if (newMode !== currentAppMode) {
                            switchAppMode(newMode);
                        }
                        modelSwitcherDropdown.style.display = 'none';
                        modelSwitcherBtn.classList.remove('open');
                    });
                });
            }


            if(removeAttachmentBtn) removeAttachmentBtn.addEventListener('click', clearAttachment);

            function getFileIcon(fileName) {
                const extension = (fileName.split('.').pop() || '').toLowerCase();
                if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'bmp', 'svg'].includes(extension)) return 'image'; 
                if (fileIcons[extension]) return fileIcons[extension];
                return fileIcons.generic;
            }

            if(imageAttachmentInput) imageAttachmentInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) { 
                    if (!file.type.startsWith('image/')) {
                        showCustomDialog("Tipe File Salah", "Hanya file gambar yang diizinkan untuk lampiran ini.", "alert");
                        clearAttachment(); 
                        imageAttachmentInput.value = null;
                        return;
                    }
                    if (file.size > MAX_FILE_SIZE_BYTES) { 
                        showCustomDialog("File Terlalu Besar", `Gambar melebihi 20MB.`, "alert"); 
                        clearAttachment(); 
                        imageAttachmentInput.value = null;
                        return; 
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const previewImageHTML = `<img src="${e.target.result}" alt="Preview">`;
                        attachedFile = { fileObject: file, type: 'image', dataUrl: e.target.result, name: file.name, extractedText: null, base64Data: e.target.result.split(',')[1], fileMimeType: file.type, previewHTML: previewImageHTML };
                        if(attachmentPreviewIconContainer) attachmentPreviewIconContainer.innerHTML = previewImageHTML;
                        if(attachedPreviewInfo) attachedPreviewInfo.textContent = file.name;
                        if(attachmentPreviewArea) attachmentPreviewArea.style.display = 'flex'; 
                        adjustLayout(); updateSendButtonState();
                    }; 
                    reader.readAsDataURL(file);
                }
                imageAttachmentInput.value = null; 
            });

            if(documentAttachmentInput) documentAttachmentInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > MAX_FILE_SIZE_BYTES) { 
                        showCustomDialog("File Terlalu Besar", `File melebihi 20MB.`, "alert"); 
                        clearAttachment(); documentAttachmentInput.value = null; return; 
                    }
                    if (file.type.startsWith('image/')) {
                        showCustomDialog(
                            "Tipe File Salah", 
                            `Untuk melampirkan gambar, silakan gunakan opsi "Lampirkan Gambar". Opsi "Lampirkan Dokumen" hanya untuk file non-gambar.`, 
                            "alert"
                        );
                        clearAttachment(); 
                        documentAttachmentInput.value = null; 
                        return;
                    }

                    const fileNameLower = file.name.toLowerCase(); const fileExtension = '.' + fileNameLower.split('.').pop();
                    const isGeminiNative = GEMINI_SUPPORTED_MIME_MAP[fileExtension] !== undefined; 
                    const isExcel = EXCEL_EXTENSIONS.includes(fileExtension);

                    if (isGeminiNative || isExcel) {
                        const iconHTML = getFileIcon(file.name); 
                        attachedFile = {
                            fileObject: file, type: 'document', dataUrl: null, name: file.name,
                            extractedText: null, base64Data: null,
                            fileMimeType: file.type || GEMINI_SUPPORTED_MIME_MAP[fileExtension] || (isExcel ? (fileExtension === '.xlsx' ? 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' : 'application/vnd.ms-excel') : 'application/octet-stream'),
                            previewHTML: iconHTML
                        };
                        if(attachmentPreviewIconContainer) attachmentPreviewIconContainer.innerHTML = iconHTML;
                        if(attachedPreviewInfo) attachedPreviewInfo.textContent = file.name;
                        if(attachmentPreviewArea) attachmentPreviewArea.style.display = 'flex'; 
                        adjustLayout(); updateSendButtonState();
                    } else { 
                        showCustomDialog("Tipe File Tidak Didukung", `Tipe file "${file.name}" tidak didukung untuk lampiran dokumen. Daftar yang didukung: PDF, JS, PY, TXT, HTML, CSS, MD, CSV, XML, RTF, JAVA, JSON, XLSX, XLS.`, "alert"); 
                        clearAttachment(); 
                    }
                }
                documentAttachmentInput.value = null; 
            });

            if(ocrModalCloseBtn) ocrModalCloseBtn.addEventListener('click', () => closeModal(ocrModal, terminateCurrentOcrWorker));
            if(ocrModal) ocrModal.addEventListener('click', (event) => { if (event.target === ocrModal) closeModal(ocrModal, terminateCurrentOcrWorker); });
            if(artifactViewerCloseBtn) artifactViewerCloseBtn.addEventListener('click', () => closeModal(artifactViewerModal));
            if(artifactViewerModal) artifactViewerModal.addEventListener('click', (event) => { if(event.target === artifactViewerModal) closeModal(artifactViewerModal); });
            
            if(ocrImageInput) ocrImageInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) { 
                    if (!file.type.startsWith('image/')) {
                         showCustomDialog("Tipe File Salah", "Hanya file gambar yang diizinkan untuk OCR.", "alert");
                         currentOcrFile = null; 
                         if(ocrScanBtn) ocrScanBtn.disabled = true; 
                         if(ocrImagePreviewContainer) ocrImagePreviewContainer.style.display = 'none'; 
                         if(ocrSelectedFilename) ocrSelectedFilename.style.display = 'none';
                         ocrImageInput.value = null; 
                         return;
                    }
                    currentOcrFile = file; 
                    if(ocrSelectedFilename) { ocrSelectedFilename.textContent = `File: ${file.name}`; ocrSelectedFilename.style.display = 'block'; }
                    const reader = new FileReader();
                    reader.onload = (e) => { 
                        if(ocrImagePreview) ocrImagePreview.src = e.target.result; 
                        if(ocrImagePreviewContainer) ocrImagePreviewContainer.style.display = 'block'; 
                        if(ocrScanBtn) ocrScanBtn.disabled = false; 
                        if(ocrResultText) ocrResultText.style.display = 'none'; 
                        if(ocrModal.querySelector('.modal-footer')) ocrModal.querySelector('.modal-footer').style.display = 'none'; 
                        if(ocrStatusArea) ocrStatusArea.style.display = 'none'; 
                    };
                    reader.readAsDataURL(file);
                } else { 
                    currentOcrFile = null; 
                    if(ocrScanBtn) ocrScanBtn.disabled = true; 
                    if(ocrImagePreviewContainer) ocrImagePreviewContainer.style.display = 'none'; 
                    if(ocrSelectedFilename) ocrSelectedFilename.style.display = 'none'; 
                }
                 ocrImageInput.value = null;
            });
            if(ocrScanBtn) ocrScanBtn.addEventListener('click', async () => {
                if (!currentOcrFile) { showCustomDialog("Peringatan", "Pilih gambar.", "alert"); return; }
                ocrScanBtn.style.display = 'none'; if(ocrImagePreviewContainer) ocrImagePreviewContainer.style.display = 'none'; if(ocrResultText) ocrResultText.style.display = 'none'; if(ocrModal.querySelector('.modal-footer')) ocrModal.querySelector('.modal-footer').style.display = 'none'; if(ocrStatusArea) ocrStatusArea.style.display = 'flex'; if(ocrProgressStatusText) ocrProgressStatusText.textContent = 'Mempersiapkan...';
                try {
                    currentTesseractWorker = await Tesseract.createWorker('ind+eng', 1, { logger: m => { if(ocrProgressStatusText) ocrProgressStatusText.textContent = m.status === 'recognizing text' ? `Mengenali teks... (${Math.round(m.progress * 100)}%)` : (m.status.charAt(0).toUpperCase() + m.status.slice(1) + '...'); } });
                    const { data: { text } } = await currentTesseractWorker.recognize(currentOcrFile);
                    if(ocrResultText) { ocrResultText.value = text; ocrResultText.style.display = 'block'; }
                    if(ocrModal.querySelector('.modal-footer')) ocrModal.querySelector('.modal-footer').style.display = 'flex'; if(ocrCopyBtn) ocrCopyBtn.disabled = text.trim() === ''; if(ocrSendToChatBtn) ocrSendToChatBtn.disabled = text.trim() === '';
                } catch (err) { console.error("Error OCR:", err); if(ocrResultText) { ocrResultText.value = `Error OCR: ${err.message}.`; ocrResultText.style.display = 'block'; } if(ocrScanBtn) ocrScanBtn.style.display = 'block'; if(ocrImagePreviewContainer) ocrImagePreviewContainer.style.display = 'block'; }
                finally { if(ocrStatusArea) ocrStatusArea.style.display = 'none'; }
            });
            if(ocrResultText) ocrResultText.addEventListener('input', () => { const text = ocrResultText.value.trim(); if(ocrCopyBtn) ocrCopyBtn.disabled = text === ''; if(ocrSendToChatBtn) ocrSendToChatBtn.disabled = text === ''; });
            if(ocrCopyBtn) ocrCopyBtn.addEventListener('click', () => {
                if (!ocrResultText || !ocrResultText.value) return;
                navigator.clipboard.writeText(ocrResultText.value).then(() => { const originalText = ocrCopyBtn.textContent; ocrCopyBtn.textContent = "Tersalin!"; setTimeout(() => { ocrCopyBtn.textContent = originalText; }, 1500); }).catch(err => showCustomDialog("Error", "Gagal menyalin teks.", "alert"));
            });
            if(ocrSendToChatBtn) ocrSendToChatBtn.addEventListener('click', async () => {
                const textToSent = ocrResultText ? ocrResultText.value : "";
                if (textToSent.trim() && !(isTypingAnimationActive || isGeneratingImage || isProcessingImageClientSide)) {
                    const originalMode = currentAppMode;
                    if (currentAppMode === 'imageai') {
                        switchAppMode('chatai', false);
                    }
                    const messageFromOCR = `--- Teks dari Gambar (OCR) ---\n${textToSent}\n--- Akhir Teks dari Gambar ---`;
                    addMessageToUI("user", messageFromOCR);
                    currentTurnUserIntent = { text: messageFromOCR, attachmentInfo: null };
                    if(userInput) userInput.value = ''; 
                    await closeModal(ocrModal, terminateCurrentOcrWorker); 
                    await getAIResponseAndHandleCommands([{ text: currentTurnUserIntent.text }]);
                    if (originalMode === 'imageai' && currentAppMode === 'chatai') {
                         switchAppMode('imageai', false);
                    }
                }
            });
            if(sendBtn) sendBtn.addEventListener("click", async () => {
                if (isTypingAnimationActive || isGeneratingImage || isProcessingImageClientSide) {
                    handleStopProcessingClick();
                } else if ((userInput && userInput.value.trim() !== '') || (attachedFile.fileObject && currentAppMode === 'chatai') ) {
                    await prepareAndSendMessage(true);
                } else if (userInput && userInput.value.trim() !== '' && currentAppMode === 'imageai') {
                    await prepareAndSendMessage(true);
                }
            });

             chatContainer.addEventListener('click', function(event) {
                let target = event.target;
                
                while (target && target !== chatContainer) {
                    if (target.classList && target.classList.contains('artifact-header-btn')) {
                        const artifactContainer = target.closest('.artifact-container');
                        const action = target.dataset.action;
                        if (artifactContainer && action) {
                            handleArtifactAction(action, artifactContainer, target);
                            event.preventDefault(); event.stopPropagation(); return;
                        }
                    } else if (target.classList && target.classList.contains('artifact-header')) { 
                         const artifactContainer = target.closest('.artifact-container');
                         if (artifactContainer && !event.target.closest('.artifact-header-actions')) { 
                             handleArtifactAction('expand', artifactContainer, target);
                             event.preventDefault(); event.stopPropagation(); return;
                         }
                    } else if (target.classList && target.classList.contains('message-action-btn-download')) {
                        event.preventDefault();
                        const parentMessageDiv = target.closest('.message');
                        const storedImageAIData = parentMessageDiv ? JSON.parse(parentMessageDiv.dataset.imageaidata || '{}') : {};
                        const promptForFilename = storedImageAIData.prompt || "generated_image";

                        if (storedImageAIData.processedCanvasDataUrl) {
                            downloadImageWithFetch(storedImageAIData.processedCanvasDataUrl, promptForFilename, true);
                        } else if (storedImageAIData.imageUrl) {
                            downloadImageWithFetch(storedImageAIData.imageUrl, promptForFilename, false);
                        }
                        event.stopPropagation();
                        return;
                    }
                    target = target.parentElement;
                }
            });


            updateAppModeUI();
            updateInputAreaVisibility(); 
            updateSendButtonState();
            startApp();
        }

        function closeOtherDropdowns(currentDropdownToKeepOpen) {
            const dropdowns = [fileActionsMenu, modelSwitcherDropdown, imageAIPollinationsModelMenu];
            dropdowns.forEach(dropdown => {
                if (dropdown && dropdown !== currentDropdownToKeepOpen && dropdown.style.display === 'block') {
                    dropdown.style.display = 'none';
                    if (dropdown === fileActionsMenu && fileActionsBtn) fileActionsBtn.classList.remove('open');
                    if (dropdown === modelSwitcherDropdown && modelSwitcherBtn) modelSwitcherBtn.classList.remove('open');
                    if (dropdown === imageAIPollinationsModelMenu && deepThinkBtn) deepThinkBtn.classList.remove('open');
                }
            });
        }

        function openModal(modalElement) {
            if(modalElement) {
                if (modalElement.id === 'sidebar') { // Sidebar uses 'open' class
                    sidebar.classList.add('open');
                } else {
                    modalElement.classList.add('visible');
                }
            }
            updateBodyBlur_HandleStatesOnly();
            adjustLayout();
        }
        
        async function closeModal(modalElement, onBeforeCloseAsyncCallback = null) {
            if (onBeforeCloseAsyncCallback) {
                try { await onBeforeCloseAsyncCallback(); } catch (e) { console.warn("Error in modal pre-close callback:", e); }
            }
            if(modalElement) {
                 if (modalElement.id === 'sidebar') {
                    modalElement.classList.remove('open');
                 } else {
                    modalElement.classList.remove('visible');
                 }
            }
            updateBodyBlur_HandleStatesOnly();
            adjustLayout();
            if (isInputElementsVisible && userInput && !userInput.disabled) {
                requestAnimationFrame(() => { 
                    if (userInput && !userInput.disabled && document.activeElement !== userInput) {
                         userInput.focus();
                    }
                });
            }
        }


        function switchAppMode(newMode, showSystemMessage = true) {
            if (newMode === currentAppMode) return;

            currentAppMode = newMode;
            isDeepThinking = false;
            isGeneratingImage = false; 
            isProcessingImageClientSide = false;
            abortGenerationRequested = false; 

            if (currentAppMode === 'chatai') {
                currentGeminiModelName = CHATAI_MODEL_NAME;
                if(showSystemMessage) addMessageToUI("system-info", "<p><i>Mode diganti ke ChatAI. Anda dapat mengirim teks dan file.</i></p>");
            } else if (currentAppMode === 'imageai') {
                 if(showSystemMessage) addMessageToUI("system-info", `<p><i>Mode diganti ke ImageAI (Pollinations). Masukkan prompt untuk menghasilkan gambar.<br>Model: ${currentImageAI_PollinationsModel}, Rasio: ${currentImageAI_AspectRatio}. Gambar akan di-upscale 2x.</i></p>`);
                clearAttachment();
            }

            isRoleResettedForNextInteraction = true;

            updateAppModeUI();
            updateInputAreaVisibility(); 
        }

        function updateAppModeUI() {
            if (!appTitle || !currentModelNameSpan || !userInput || !fileActionsBtn || !fileActionsMenu || !deepThinkBtn || !imageAIPollinationsModelMenu || !modelSwitcherDropdown) return;

            const isActiveChatAI = currentAppMode === 'chatai';
            appTitle.textContent = isActiveChatAI ? "ChatAI" : "ImageAI";
            currentModelNameSpan.textContent = isActiveChatAI ? "ChatAI" : "ImageAI";
            userInput.placeholder = isActiveChatAI ? "Ketik pesan atau lampirkan file..." : "Masukkan prompt gambar";

            fileActionsBtn.innerHTML = isActiveChatAI ? addAttachmentIconSVG : aspectRatioIconSVG;
            fileActionsBtn.title = isActiveChatAI ? "Tambah Lampiran/Aksi" : `Pilih Rasio (${currentImageAI_AspectRatio})`;
            fileActionsMenu.innerHTML = '';

            if (isActiveChatAI) {
                const attachImage = document.createElement('button'); attachImage.textContent = 'Lampirkan Gambar';
                attachImage.onclick = () => { if (attachedFile.fileObject) clearAttachment(); if(imageAttachmentInput) imageAttachmentInput.click(); closeOtherDropdowns(null); fileActionsBtn.classList.remove('open'); };
                fileActionsMenu.appendChild(attachImage);

                const ocr = document.createElement('button'); ocr.textContent = 'Salin Teks Gambar (OCR)';
                ocr.onclick = () => { openModal(ocrModal); resetOcrModal(); closeOtherDropdowns(null); fileActionsBtn.classList.remove('open'); };
                fileActionsMenu.appendChild(ocr);

                const attachDoc = document.createElement('button'); attachDoc.textContent = 'Lampirkan Dokumen';
                attachDoc.onclick = () => { if (attachedFile.fileObject) clearAttachment(); if(documentAttachmentInput) documentAttachmentInput.click(); closeOtherDropdowns(null); fileActionsBtn.classList.remove('open');};
                fileActionsMenu.appendChild(attachDoc);
            } else {
                Object.keys(imageAI_AspectRatios_WithCrop).forEach(ratio => {
                    const ratioBtn = document.createElement('button');
                    ratioBtn.dataset.ratio = ratio;
                    ratioBtn.textContent = ratio;
                    if (ratio === currentImageAI_AspectRatio) ratioBtn.classList.add('active-option');
                    ratioBtn.onclick = () => {
                        currentImageAI_AspectRatio = ratio;
                        fileActionsBtn.title = `Pilih Rasio (${currentImageAI_AspectRatio})`;
                        fileActionsMenu.querySelectorAll('button').forEach(btn => btn.classList.remove('active-option'));
                        ratioBtn.classList.add('active-option');
                        closeOtherDropdowns(null);
                        fileActionsBtn.classList.remove('open');
                         addMessageToUI("system-info", `<p><i>Rasio gambar diubah menjadi ${currentImageAI_AspectRatio}.</i></p>`);
                    };
                    fileActionsMenu.appendChild(ratioBtn);
                });
            }

            deepThinkBtn.classList.remove('active', 'imageai-pollinations-model-selector', 'open');
            imageAIPollinationsModelMenu.innerHTML = '';

            if (isActiveChatAI) {
                deepThinkBtn.innerHTML = deepThinkIconSVG;
                deepThinkBtn.title = isDeepThinking ? "Mode Berpikir Mendalam (Aktif)" : "Mode Berpikir Mendalam";
                if (isDeepThinking) deepThinkBtn.classList.add('active');
                imageAIPollinationsModelMenu.style.display = 'none';
                deepThinkBtn.style.width = '40px';
                deepThinkBtn.style.padding = '0';
            } else { 
                deepThinkBtn.classList.add('imageai-pollinations-model-selector');
                deepThinkBtn.innerHTML = imageModelIconSVG; 
                deepThinkBtn.title = `Pilih Model Pollinations (${currentImageAI_PollinationsModel})`;
                deepThinkBtn.style.width = '40px';
                deepThinkBtn.style.padding = '0';

                imageAI_PollinationsModels.forEach(modelName => {
                    const modelBtn = document.createElement('button');
                    modelBtn.dataset.model = modelName;
                    modelBtn.textContent = modelName.charAt(0).toUpperCase() + modelName.slice(1);
                    if (modelName === currentImageAI_PollinationsModel) modelBtn.classList.add('active-option');
                    modelBtn.onclick = () => {
                        currentImageAI_PollinationsModel = modelName;
                        deepThinkBtn.title = `Pilih Model Pollinations (${currentImageAI_PollinationsModel})`;
                        imageAIPollinationsModelMenu.querySelectorAll('button').forEach(btn => btn.classList.remove('active-option'));
                        modelBtn.classList.add('active-option');
                        closeOtherDropdowns(null);
                        deepThinkBtn.classList.remove('open');
                         addMessageToUI("system-info", `<p><i>Model gambar diubah menjadi ${currentImageAI_PollinationsModel}.</i></p>`);
                    };
                    imageAIPollinationsModelMenu.appendChild(modelBtn);
                });
            }

            modelSwitcherDropdown.querySelectorAll('button').forEach(btn => {
                btn.classList.toggle('active-model', btn.dataset.model === currentAppMode);
            });
        }


        function showCustomDialog(title, message, type = 'alert', onConfirm, onCancel) {
            if(!customDialogTitle || !customDialogMessage || !customDialogBtnConfirm || !customDialogBtnCancel || !customDialogOverlay) return;
            customDialogTitle.textContent = title; customDialogMessage.innerHTML = DOMPurify.sanitize(message);
            confirmCallback = onConfirm; cancelCallback = onCancel;
            if (type === 'confirm') { customDialogBtnConfirm.textContent = 'Ya'; customDialogBtnConfirm.className = 'danger'; customDialogBtnCancel.textContent = 'Batal'; customDialogBtnCancel.style.display = 'inline-block'; }
            else { customDialogBtnConfirm.textContent = 'OK'; customDialogBtnConfirm.className = 'primary'; customDialogBtnCancel.style.display = 'none'; }
            openModal(customDialogOverlay);
        }
        
        function isAnyModalOpen() { 
            return (ocrModal && ocrModal.classList.contains('visible')) || 
                   (customDialogOverlay && customDialogOverlay.classList.contains('visible')) || 
                   (sidebar && sidebar.classList.contains('open')) || 
                   (artifactViewerModal && artifactViewerModal.classList.contains('visible')); 
        }

        function updateBodyBlur() { 
            updateBodyBlur_HandleStatesOnly();
            adjustLayout();
        }


        function setButtonStateForProcessing(isProcessingGlobal) {
            isTypingAnimationActive = (currentAppMode === 'chatai' && isProcessingGlobal && !isProcessingImageClientSide);
            isGeneratingImage = (currentAppMode === 'imageai' && isProcessingGlobal && !isProcessingImageClientSide && !abortGenerationRequested); 
            
            const trulyProcessing = isTypingAnimationActive || isGeneratingImage || isProcessingImageClientSide;
            const anyNonArtifactModalOpen = isAnyModalOpen();


            [modelSwitcherBtn, downloadChatBtn, resetRoleBtn, darkModeToggleBtn,
             menuToggleFloating, toggleToolsPanelBtn, 
            ].forEach(btn => { if (btn) btn.disabled = trulyProcessing || anyNonArtifactModalOpen; });

            if (toggleInputElementsBtn) toggleInputElementsBtn.disabled = anyNonArtifactModalOpen; 

            if (fileActionsBtn) fileActionsBtn.disabled = trulyProcessing || anyNonArtifactModalOpen;
            if (deepThinkBtn) deepThinkBtn.disabled = trulyProcessing || anyNonArtifactModalOpen;

            if (sendBtn) {
                if (trulyProcessing) {
                    sendBtn.innerHTML = stopIconSVG;
                    sendBtn.title = "Stop";
                    sendBtn.classList.add('stop-mode');
                    sendBtn.disabled = false; 
                } else {
                    sendBtn.innerHTML = sendIconSVG;
                    sendBtn.title = "Kirim";
                    sendBtn.classList.remove('stop-mode');
                    sendBtn.disabled = anyNonArtifactModalOpen || !isInputElementsVisible; 
                    if (!sendBtn.classList.contains('stop-mode')) {
                        updateSendButtonState(); 
                    }
                }
            }

            if (openInputAreaBtn) {
                openInputAreaBtn.innerHTML = openIconSVG;
                openInputAreaBtn.title = "Buka Area Input";
                openInputAreaBtn.classList.remove('stop-mode-global'); 

                const showOpenBtn = !isInputElementsVisible && !anyNonArtifactModalOpen;
                openInputAreaBtn.style.opacity = showOpenBtn ? '1' : '0';
                openInputAreaBtn.style.visibility = showOpenBtn ? 'visible' : 'hidden';
                openInputAreaBtn.style.transform = showOpenBtn ? 'translateX(-50%) scale(1)' : 'translateX(-50%) scale(0.7)';
                openInputAreaBtn.style.pointerEvents = showOpenBtn ? 'auto' : 'none';
                
                openInputAreaBtn.disabled = isInputElementsVisible || anyNonArtifactModalOpen || (trulyProcessing && isInputElementsVisible);
            }
        }


        function adjustLayout() {
            if (userInput && isInputElementsVisible) {
                userInput.style.height = 'auto';
                const newScrollHeight = userInput.scrollHeight;
                const maxHeight = 120;
                userInput.style.height = `${Math.min(newScrollHeight, maxHeight)}px`;
                userInput.style.overflowY = newScrollHeight > maxHeight ? 'auto' : 'hidden';
            }

            if (chatContainer && inputAreaWrapper && openInputAreaBtn) {
                const basePaddingBottom = 10; 
                let newBottomPadding = basePaddingBottom;

                if (inputAreaWrapper.classList.contains('input-closed')) {
                    const anyModalOpen = isAnyModalOpen();

                    if (!anyModalOpen) {
                        const openBtnHeight = openInputAreaBtn.offsetHeight || 38; 
                        newBottomPadding = openBtnHeight + 15 + 15; 
                    }
                }
                chatContainer.style.paddingBottom = `${newBottomPadding}px`;
            }

            if (!userHasInteractedWithScroll && chatContainer) {
                requestAnimationFrame(() => scrollToBottom(true));
            }
        }

        function updateSendButtonState() {
            if (sendBtn && userInput) {
                if (sendBtn.classList.contains('stop-mode')) {
                    sendBtn.disabled = false; 
                } else {
                    const anyNonArtifactModalOpen = isAnyModalOpen();

                    if (anyNonArtifactModalOpen || !isInputElementsVisible) {
                         sendBtn.disabled = true;
                    } else {
                        if (currentAppMode === 'chatai') {
                            sendBtn.disabled = (userInput.value.trim() === '') && !attachedFile.fileObject;
                        } else { 
                            sendBtn.disabled = userInput.value.trim() === '';
                        }
                    }
                }
            }
        }

        function toggleSidebar() {
            if (sidebar) {
                sidebar.classList.toggle('open');
                updateBodyBlur_HandleStatesOnly(); 
                adjustLayout();
            }
        }

        function scrollToBottom(force = false) { if (chatContainer && (force || !userHasInteractedWithScroll)) { requestAnimationFrame(() => chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' })); } }

        function clearAttachment() {
            attachedFile = { fileObject: null, type: null, dataUrl: null, name: null, extractedText: null, base64Data: null, fileMimeType: null, previewHTML: null };
            if(attachmentPreviewIconContainer) attachmentPreviewIconContainer.innerHTML = '';
            if(attachedPreviewInfo) attachedPreviewInfo.textContent = '';
            if(attachmentPreviewArea) attachmentPreviewArea.style.display = 'none';
            if(imageAttachmentInput) imageAttachmentInput.value = null;
            if(documentAttachmentInput) documentAttachmentInput.value = null;
            adjustLayout(); updateSendButtonState();
        }

        function arrayBufferToBase64(buffer) { let binary = ''; const bytes = new Uint8Array(buffer); const len = bytes.byteLength; for (let i = 0; i < len; i++) { binary += String.fromCharCode(bytes[i]); } return window.btoa(binary); }

        async function fetchUrlContent(url) {
            console.log("fetchUrlContent called for:", url);
            if (!SCRAPER_PHP_URL || SCRAPER_PHP_URL === "YOUR_SCRAPERWEB_PHP_URL_HERE" || SCRAPER_PHP_URL.endsWith("scraperweb.php")) {
                 if (SCRAPER_PHP_URL.endsWith("scraperweb.php") && SCRAPER_PHP_URL.includes("femzlabs.unaux.com")) {
                    let warningMsg = "Layanan scraper (femzlabs.unaux.com) adalah contoh. Ganti `SCRAPER_PHP_URL` di JavaScript dengan URL skrip scraper.php Anda yang sebenarnya untuk fungsi yang andal.";
                     if (url.toLowerCase().startsWith("http://localhost")) {
                        warningMsg = "Layanan scraper di femzlabs.unaux.com tidak dapat mengakses URL localhost. Harap gunakan URL publik dan konfigurasikan SCRAPER_PHP_URL Anda sendiri.";
                    }
                    console.warn(warningMsg);
                    return { success: false, error: warningMsg };
                 } else if (SCRAPER_PHP_URL === "YOUR_SCRAPERWEB_PHP_URL_HERE") {
                     const warningMsg = "Konfigurasi `SCRAPER_PHP_URL` di JavaScript belum diubah dari placeholder. Fitur pengambilan konten URL tidak akan berfungsi dengan benar.";
                     console.warn(warningMsg);
                     return { success: false, error: warningMsg };
                 }
            }

            try {
                let fullUrl = url;
                if (!/^https?:\/\//i.test(url)) {
                    fullUrl = 'https://' + url;
                }
                console.log("Attempting to fetch via PHP Scraper:", `${SCRAPER_PHP_URL}?scrape_url=${encodeURIComponent(fullUrl)}`);

                const response = await fetch(`${SCRAPER_PHP_URL}?scrape_url=${encodeURIComponent(fullUrl)}`, {
                    method: 'GET',
                    headers: { 'Accept': 'text/plain, */*' }
                });
                console.log("Scraper Response Status:", response.status);

                const responseText = await response.text();

                if (!response.ok) {
                    console.error(`Scraping failed for ${fullUrl}: HTTP ${response.status}`, responseText);
                    if (responseText.toLowerCase().includes("error:")) {
                         return { success: false, error: responseText.substring(0,200) };
                    }
                    return { success: false, error: `Gagal mengambil URL (HTTP ${response.status}). ${responseText.substring(0,150)}` };
                }

                if (responseText.toLowerCase().startsWith("error:") || responseText.toLowerCase().startsWith("scraping error:") || responseText.toLowerCase().startsWith("scraping service error:")) {
                     console.error(`Scraper service returned an error for ${fullUrl}:`, responseText);
                     return { success: false, error: `Layanan scraper mengembalikan error: ${responseText.substring(0,200)}`};
                }
                if (responseText.trim() === "") {
                    return { success: false, error: `Konten kosong diterima dari URL: ${fullUrl}` };
                }

                return { success: true, content: responseText };
            } catch (error) {
                console.error(`Error fetching URL content for ${url} via JavaScript fetch:`, error);
                return { success: false, error: `Kesalahan jaringan saat menghubungi scraper: ${error.message}` };
            }
        }

        async function prepareFileDataForGemini(file) {
            if (!file) return null; if (file.size > MAX_FILE_SIZE_BYTES) { throw new Error(`File ${file.name} is too large.`); }
            const fileNameLower = file.name.toLowerCase(); const reader = new FileReader(); const fileExtension = '.' + fileNameLower.split('.').pop();
            
            if (file.type.startsWith('image/')) {
                throw new Error(`Tipe file gambar (${file.name}) tidak seharusnya diproses sebagai dokumen.`);
            }

            if (GEMINI_SUPPORTED_MIME_MAP[fileExtension]) {
                return new Promise((resolve, reject) => {
                    reader.onload = (e) => { const base64Data = arrayBufferToBase64(e.target.result); resolve({ base64Data, mimeType: GEMINI_SUPPORTED_MIME_MAP[fileExtension], extractedText: null, name: file.name }); };
                    reader.onerror = () => reject(new Error(`Gagal membaca file ${file.name}.`)); reader.readAsArrayBuffer(file);
                });
            } else if (EXCEL_EXTENSIONS.includes(fileExtension)) {
                return new Promise((resolve, reject) => {
                    reader.onload = (e) => {
                        try { const workbook = XLSX.read(e.target.result, { type: 'array' }); let fullText = '';
                            workbook.SheetNames.forEach(sheetName => { fullText += `--- Lembar: ${sheetName} ---\n`; const worksheet = workbook.Sheets[sheetName]; const csvData = XLSX.utils.sheet_to_csv(worksheet); fullText += csvData + '\n\n'; });
                            resolve({ base64Data: null, mimeType: (fileExtension === '.xlsx' ? 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' : 'application/vnd.ms-excel'), extractedText: fullText, name: file.name });
                        } catch (err) { console.error("Error parsing Excel:", err); reject(new Error("Gagal memproses file Excel."));}
                    };
                    reader.onerror = () => reject(new Error(`Gagal membaca file Excel ${file.name}.`)); reader.readAsArrayBuffer(file);
                });
            } else { 
                reject(new Error(`Tipe file tidak didukung untuk pemrosesan data langsung: ${file.name}`)); 
            }
        }

        function getSystemInstructionForChatAI() {
             let baseInstruction = `Anda adalah FlabsAI, asisten AI percakapan yang sangat adaptif, dibuat oleh Fema Andara Haqi, Seorang Siswa Laki Berumur 16 Tahun.
            Tujuan utama Anda adalah memberikan pengalaman percakapan yang imersif dan memuaskan.
            Follow Ig @femaandara_ github dia FemaDongz dan kalo mau bertanya DM saja Ig nya.

            PERAN: Selalu berusaha mendalami peran yang diminta pengguna. Sesuaikan gaya bahasa, sikap, dan konsistensi. Jika tidak ada peran, jadilah asisten AI ramah & profesional.

            PENTING - PENANGANAN INPUT & KONTEN WEB (URL):
            1.  LAMPIRAN FILE: Jika input pengguna berisi data file (misalnya, \`inlineData\`), analisis konten file tersebut. Kaitkan dengan teks prompt pengguna jika ada. Jika tidak ada teks prompt, deskripsikan atau respons file secara relevan. Untuk Excel, Anda akan menerima teks yang diekstrak.
            2.  KONTEN WEB (URL) - PERMINTAAN SCRAPING:
                a. Jika pengguna memberikan URL dan meminta tugas yang memerlukan konten dari URL tersebut (misal, meringkas), JANGAN menjawab hanya berdasarkan URL atau pengetahuan umum Anda SAAT ITU JUGA.
                b. Anda HARUS merespons dengan format JSON *khusus* berikut DALAM TAG <p> TUNGGAL:
                   <p>ACTION_SCRAPE_URL: {"url": "URL_YANG_PERLU_DIAMBIL", "original_user_query": "PERTANYAAN_LENGKAP_PENGGUNA_TERMASUK_TEKS_DAN_INFO_LAMPIRAN_JIKA_ADA"}</p>
                c. "URL_YANG_PERLU_DIAMBIL" adalah URL valid. "original_user_query" HARUS berisi SELURUH teks prompt pengguna yang relevan dengan URL, termasuk deskripsi singkat lampiran file jika ada.
                d. Aplikasi akan mengambil konten URL. Anda akan menerima konten atau pesan kegagalan di giliran berikutnya. Baru setelah itu Anda jawab pertanyaan pengguna.
                e. Jika tidak yakin scraping diperlukan, klarifikasi atau jawab berdasarkan pengetahuan umum TANPA "ACTION_SCRAPE_URL".
                f. Jangan tampilkan format "ACTION_SCRAPE_URL" ke pengguna. Ini instruksi internal.
            3.  KONTEN WEB YANG SUDAH DI-SCRAPE: Jika input pengguna mengandung teks seperti "[Scraped content from URL: NAMA_URL]:\\n...KONTEN_HTML_WEB...\n\n[User's original query ...]:...", analisis TEKS UTAMA dari KONTEN_HTML_WEB.

            ATURAN FORMAT HTML TEGAS (WAJIB DIPATUHI SELALU):
            1.  Gunakan HANYA tag HTML: <p>, <b>, <i>, <ul>, <ol>, <li>, <br> (dalam <p>/<li>), <small>, <button>, <table>, <thead>, <tbody>, <tr>, <th>, <td>.
            2.  Setiap respons HARUS dibungkus <p> atau struktur daftar/tabel. TIDAK ADA teks mentah.
            3.  JANGAN PERNAH pakai Markdown. SELALU pakai <b> dan <i>.
            4.  Semua tag HTML HARUS dibuka dan ditutup dengan benar.
            5.  PENGGUNAAN ARTIFACT WAJIB OTOMATIS:
                Untuk KODE PEMROGRAMAN (misal, Python, JavaScript, HTML, CSS): Anda HARUS menggunakan format ARTIFACT KODE. Judul artifact HARUS menyertakan bahasa pemrograman jika diketahui (misal, "Blok Kode: Python").
                Untuk DATA TABULAR: Anda HARUS menggunakan format ARTIFACT TABEL (menggunakan tag <table> HTML di dalam artifact-content). Judul bisa "Tabel Data" atau lebih spesifik.
                Untuk PUISI, DAFTAR PANJANG, KUTIPAN ARTIKEL, atau TEKS TERSTRUKTUR PANJANG lainnya: Gunakan ARTIFACT UMUM.
                Format Artifact Umum:
                <div class="artifact-container"> <!-- Tambahkan 'code-artifact' atau 'table-artifact' jika sesuai -->
                  <div class="artifact-header">
                    <span class="artifact-title">Judul Artifact (Mis: Blok Kode: Python, Tabel Penjualan, Kutipan Artikel)</span>
                    <!-- Tombol Expand, Salin, Unduh akan ditambahkan oleh aplikasi -->
                  </div>
                  <div class="artifact-content scrollable-content">
                    <!-- Jika code-artifact, bungkus kode dalam <pre><code>...</code></pre> -->
                    <!-- Jika table-artifact, gunakan <table>, <thead>, <tbody>, <tr>, <th>, <td> -->
                    Isi artifact di sini...
                  </div>
                </div>
                Pastikan judul relevan. Untuk kode, gunakan <pre><code>...</code></pre> di dalam .artifact-content. Untuk tabel, gunakan struktur HTML table.

            LARANGAN: JANGAN buat kode bahasa pemrograman KECUALI disajikan dalam format ARTIFACT KODE yang benar. Hindari konten berbahaya/ilegal.

            LAINNYA: Jaga Batasan Etika. Tolak permintaan berbahaya. Info Akurat. Gunakan riwayat untuk konteks (KECUALI peran baru direset). Akui jika tidak tahu.

            Prioritas: Kepuasan pengguna, interaksi imersif, format respons HTML SEMPURNA dan penggunaan ARTIFACT yang benar.`;
            if (isDeepThinking) { baseInstruction += `\n<p><b>SAAT INI MODE BERPIKIR MENDALAM (DEEPTHINK) AKTIF:</b> Berikan analisis yang lebih mendalam, pertimbangkan berbagai perspektif, dan eksplorasi ide-ide terkait secara lebih luas. Jika dalam peran, gunakan mode ini untuk memberikan respons yang lebih kaya dan detail sesuai peran tersebut, tetap dengan format HTML dasar dan artifact yang ketat. Luangkan waktu lebih untuk merumuskan jawaban yang sangat komprehensif.</p>`; }
            return { parts: [{ text: baseInstruction }] };
        }
        
        function resetOcrModal() {
             if(ocrImageInput) ocrImageInput.value = null; 
             if(ocrImagePreview) ocrImagePreview.src = "#"; 
             if(ocrImagePreviewContainer) ocrImagePreviewContainer.style.display = 'none';
             if(ocrScanBtn) { ocrScanBtn.style.display = 'block'; ocrScanBtn.disabled = true; }
             if(ocrStatusArea) ocrStatusArea.style.display = 'none'; 
             if(ocrResultText) { ocrResultText.style.display = 'none'; ocrResultText.value = '';}
             if(ocrModal.querySelector('.modal-footer')) ocrModal.querySelector('.modal-footer').style.display = 'none'; 
             currentOcrFile = null; 
             if(ocrImageInputLabel) { ocrImageInputLabel.style.display = 'block'; ocrImageInputLabel.textContent = 'Pilih Gambar...';}
             if(ocrSelectedFilename) { ocrSelectedFilename.style.display = 'none'; ocrSelectedFilename.textContent = '';}
        }

        async function terminateCurrentOcrWorker() { if (currentTesseractWorker) { try { await currentTesseractWorker.terminate(); } catch (e) { console.warn("Tesseract terminate error:", e); } finally { currentTesseractWorker = null; } } }


        async function initializeAI() {
            if (currentAppMode === 'chatai' && !genAI) {
                 try {
                    if (!ACTUAL_API_KEY || ACTUAL_API_KEY === "GANTI_DENGAN_API_KEY_ANDA" || ACTUAL_API_KEY.length < 30) {
                        console.warn("Gemini API Key not configured.");
                        showCustomDialog("Error Konfigurasi", "Layanan AI (ChatAI) tidak dapat diinisialisasi. Pastikan API Key valid.", "alert");
                        return false;
                    }
                    genAI = new GoogleGenerativeAI(ACTUAL_API_KEY);
                    console.log("AI Service (GoogleGenerativeAI for ChatAI) initialized.");
                    return true;
                } catch (error) {
                    console.error("Gemini Init Error (Raw):", error);
                    showCustomDialog("Error Inisialisasi Gemini", `Tidak dapat terhubung ke layanan Gemini: ${error.message}. ChatAI mungkin tidak berfungsi.`, "alert");
                    return false;
                }
            } else if (genAI && currentAppMode === 'chatai') {
                 return true;
            } else if (currentAppMode === 'imageai') {
                console.log("ImageAI mode (Pollinations) does not require Gemini initialization here.");
                return true;
            }
            return true;
        }

        function disableChat() {
            setButtonStateForProcessing(true); 
            if(userInput) userInput.placeholder = "Chat dinonaktifkan.";
            console.warn("Chat functionality has been disabled due to initialization issues.");
        }

        function addMessageToChatHistory(role, partsOrText, attachmentInfo = null, imageMeta = null, isProcessedImage = false) {
            let finalParts;
            if (typeof partsOrText === 'string') {
                finalParts = partsOrText ? [{ text: partsOrText.trim() }] : [];
            } else if (Array.isArray(partsOrText)) {
                finalParts = partsOrText;
            } else {
                finalParts = [];
            }

            const hasText = finalParts.some(p => p.text && p.text.trim() !== "");
            const hasImageData = finalParts.some(p => (p.inlineData && p.inlineData.mimeType && p.inlineData.mimeType.startsWith('image/')) || p.imageUrl || p.processedCanvasDataUrl);


            if (hasText || hasImageData || (role === 'user' && attachmentInfo && attachmentInfo.name)) {
                const entry = { role, parts: finalParts };
                if (role === 'user' && attachmentInfo) {
                    entry.attachment = { name: attachmentInfo.name, type: attachmentInfo.type, previewHTML: attachmentInfo.previewHTML, dataUrl: attachmentInfo.dataUrl };
                }
                if (role === 'model' && imageMeta && hasImageData) {
                    entry.imageMeta = imageMeta;
                }
                 if (role === 'model' && (isProcessedImage || finalParts.find(p => p.processedCanvasDataUrl))) { 
                    entry.isProcessedImage = true;
                }
                chatHistory.push(entry);
                if (chatHistory.length > MAX_CHAT_HISTORY * 2) chatHistory.splice(0, chatHistory.length - (MAX_CHAT_HISTORY * 2));
            }
        }

        const domPurifyConfig = { USE_PROFILES: { html: true }, ADD_TAGS: ["span", "div", "small", "i", "pre", "code", "button", "img", "svg", "path", "text", "a", "circle", "table", "thead", "tbody", "tr", "th", "td", "canvas"], ADD_ATTR: ["class", "style", "src", "alt", "title", "viewBox", "fill", "d", "x", "y", "font-family", "font-size", "href", "download", "target", "data-url", "data-prompt", "onerror", "rel", "id", "cx", "cy", "r", "width", "height", "data-action", "data-filename", "data-contenttype", "data-iscanvas"] };


        function addMessageActions(messageElement, textContentToCopy, imageAIData = null) { 
            if (!messageElement) return;
            let toolbar = messageElement.querySelector('.message-actions-toolbar');
            if (!toolbar) {
                toolbar = document.createElement('div');
                toolbar.className = 'message-actions-toolbar';
                messageElement.appendChild(toolbar);
            } else {
                toolbar.innerHTML = '';
            }

            let hasActions = false;
            const isProcessedImage = imageAIData && imageAIData.processedCanvasDataUrl;

            if (imageAIData && (imageAIData.imageUrl || imageAIData.processedCanvasDataUrl)) {
                 let targetImageElement;
                 let isCanvasSource = false;
                 if (imageAIData.processedCanvasDataUrl) {
                     targetImageElement = messageElement.querySelector('.processed-image-canvas');
                     isCanvasSource = true;
                 } else {
                     targetImageElement = messageElement.querySelector('.pollinations-generated-image');
                 }
                 
                 const imageAvailableForDownload = (isCanvasSource && targetImageElement) || (targetImageElement && targetImageElement.complete && targetImageElement.naturalWidth > 0 && targetImageElement.src && !targetImageElement.src.startsWith('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')); 

                if (imageAvailableForDownload) {
                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = 'message-action-btn message-action-btn-download always-visible';
                    downloadBtn.title = 'Unduh Gambar';
                    downloadBtn.innerHTML = downloadIconSVG;
                    downloadBtn.style.opacity = '0.7';
                    
                    toolbar.appendChild(downloadBtn); 
                    hasActions = true;
                }
            }


            if (textContentToCopy && textContentToCopy.trim() !== "") { 
                const copyBtn = document.createElement('button');
                copyBtn.className = 'message-action-btn copy-message-btn always-visible';
                copyBtn.title = 'Salin Pesan';
                copyBtn.innerHTML = copyIconSVG;
                copyBtn.style.opacity = '0.7';
                copyBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    navigator.clipboard.writeText(textContentToCopy).then(() => { 
                        copyBtn.innerHTML = checkIconSVG;
                        setTimeout(() => { copyBtn.innerHTML = copyIconSVG; }, 1500);
                    }).catch(err => showCustomDialog("Error", "Gagal menyalin pesan.", "alert"));
                });
                toolbar.appendChild(copyBtn); 
                hasActions = true;
            }


            if (!hasActions && toolbar.parentNode) {
                toolbar.parentNode.removeChild(toolbar);
            }
        }


        function addMessageToUI(role, contentOrParts, isError = false, userAttachmentDisplayInfo = null, imageAIData = null) {
            if(!chatContainer) return null;
            const messageDiv = document.createElement("div"); messageDiv.classList.add("message");
            if (role === "user") messageDiv.classList.add("user-message");
            else if (role === "ai" || role === "model") { messageDiv.classList.add("ai-message"); role = "ai"; } 
            else if (role === "system-info") messageDiv.classList.add("system-info-message");
            if (isError && role === "ai") messageDiv.classList.add("error-message");

            const contentDiv = document.createElement("div"); contentDiv.classList.add("message-content");
            let textForCopyFromContent = ""; 
            let mainContentHTML = "";

            if (imageAIData) { 
                 messageDiv.dataset.imageaidata = JSON.stringify(imageAIData);
            }


            if (role === 'user') {
                if (typeof contentOrParts === 'string' && contentOrParts.trim() !== "") {
                    const tempDiv = document.createElement('div'); tempDiv.textContent = contentOrParts;
                    mainContentHTML += DOMPurify.sanitize(tempDiv.innerHTML.replace(/\n/g, '<br>'), domPurifyConfig);
                    textForCopyFromContent += contentOrParts;
                }
                if (userAttachmentDisplayInfo && userAttachmentDisplayInfo.previewHTML && userAttachmentDisplayInfo.name) {
                    let attachmentIconOrImageHTML = "";
                    const previewContainerClass = "user-bubble-attachment-preview-container";
                    if (userAttachmentDisplayInfo.type === 'image' && userAttachmentDisplayInfo.dataUrl) {
                        attachmentIconOrImageHTML = `<div class="${previewContainerClass}"><img src="${userAttachmentDisplayInfo.dataUrl}" alt="Preview" class="attachment-image-preview"></div>`;
                    } else {
                        attachmentIconOrImageHTML = `<div class="${previewContainerClass}">${userAttachmentDisplayInfo.previewHTML}</div>`;
                    }

                    const attachmentHTML = `
                        <div class="user-sent-attachment-display">
                            ${attachmentIconOrImageHTML}
                            <span class="attachment-name">${DOMPurify.sanitize(userAttachmentDisplayInfo.name)}</span>
                        </div>`;
                    mainContentHTML += attachmentHTML;
                    if (textForCopyFromContent) textForCopyFromContent += " ";
                    textForCopyFromContent += `[Lampiran ${userAttachmentDisplayInfo.type === 'image' ? 'gambar' : 'dokumen'}: ${userAttachmentDisplayInfo.name}]`;
                }
                contentDiv.innerHTML = mainContentHTML || "<p><i>(Pesan kosong)</i></p>";
            } else if (role === 'ai') {
                 let isProcessedImg = false; 
                if (imageAIData && imageAIData.processedCanvasDataUrl) isProcessedImg = true;

                // Logic for ImageAI bubble content
                if (imageAIData) { // This covers initial empty bubble for ImageAI and final image
                    mainContentHTML = `
                        <div class="pollinations-image-display-container ${ (imageAIData.imageUrl || imageAIData.processedCanvasDataUrl) ? '' : 'loading-initial'}"> 
                            <p class="image-prompt-display"><strong>Prompt:</strong> ${DOMPurify.sanitize(imageAIData.prompt || '')}</p>
                            <div class="image-placeholder">
                                <div class="thinking-loader" style="display:${ (imageAIData.imageUrl || imageAIData.processedCanvasDataUrl) ? 'none' : 'flex'};"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div>
                                <img src="${imageAIData.imageUrl || ''}" alt="Generated image for: ${DOMPurify.sanitize(imageAIData.prompt || '')}" class="pollinations-generated-image" style="display:${imageAIData.imageUrl && !imageAIData.processedCanvasDataUrl ? 'block' : 'none'};"
                                    onerror="this.alt='Gagal memuat gambar dari Pollinations.'; this.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; this.style.display='block';">
                                <canvas class="processed-image-canvas" width="100" height="100" style="display:${imageAIData.processedCanvasDataUrl ? 'block' : 'none'};"></canvas>
                            </div>
                            <div class="image-process-progress-bar-container" style="display: none;">
                                <div class="image-process-progress-bar">0%</div>
                            </div>
                            <p class="image-process-status-text" style="display: ${(imageAIData.imageUrl || imageAIData.processedCanvasDataUrl) && !isProcessingImageClientSide ? 'none' : 'block'}; text-align:center;">
                                ${isProcessingImageClientSide ? "Memproses gambar..." : (imageAIData.imageUrl ? "Gambar dimuat..." : "Menyiapkan...")}
                            </p>
                            <div class="image-meta-info">Model: ${DOMPurify.sanitize(imageAIData.model || '')} | Rasio: ${DOMPurify.sanitize(imageAIData.aspectRatio || '')} ${isProcessedImg ? "| Diproses (2x Upscaled)" : ""}</div>
                            <div class="pollinations-support-text">FlabsAI didukung ${isProcessedImg ? "Pollinations & ImageProcessor" : "Pollinations AI"}</div>
                        </div>`;
                    textForCopyFromContent = `[Gambar ${isProcessedImg ? "diproses (2x upscaled)" : "dihasilkan"} oleh ImageAI]\nPrompt: ${imageAIData.prompt || ''}\nModel: ${imageAIData.model || ''}, Rasio: ${imageAIData.aspectRatio || ''}`;
                    contentDiv.innerHTML = DOMPurify.sanitize(mainContentHTML, domPurifyConfig);
                    
                    if (imageAIData.processedCanvasDataUrl) { 
                        const canvasElement = contentDiv.querySelector('.processed-image-canvas');
                        const thinkingLoader = contentDiv.querySelector('.image-placeholder .thinking-loader');
                        const statusText = contentDiv.querySelector('.image-process-status-text');

                        if(thinkingLoader) thinkingLoader.style.display = 'none';
                        if(statusText) statusText.style.display = 'none';

                        if (canvasElement) {
                             const tempImg = new Image();
                             tempImg.onload = () => {
                                 canvasElement.width = tempImg.width;
                                 canvasElement.height = tempImg.height;
                                 canvasElement.getContext('2d').drawImage(tempImg, 0, 0);
                                 canvasElement.style.display = 'block';
                                 contentDiv.querySelector('.pollinations-image-display-container').classList.remove('loading-initial');
                             }
                             tempImg.src = imageAIData.processedCanvasDataUrl;
                        }
                    } else if (imageAIData.imageUrl && !isProcessingImageClientSide) { // Image loaded but not yet processed
                        const imgElement = contentDiv.querySelector('.pollinations-generated-image');
                        const thinkingLoader = contentDiv.querySelector('.image-placeholder .thinking-loader');
                        const statusText = contentDiv.querySelector('.image-process-status-text');
                        if (imgElement) imgElement.style.display = 'block';
                        if (thinkingLoader) thinkingLoader.style.display = 'none';
                        if (statusText) statusText.style.display = 'none';
                        contentDiv.querySelector('.pollinations-image-display-container').classList.remove('loading-initial');
                    }

                } else if (typeof contentOrParts === 'string') { // For ChatAI or non-image AI messages
                    const sanitizedContent = DOMPurify.sanitize(contentOrParts, domPurifyConfig);
                    contentDiv.innerHTML = sanitizedContent;
                    extractTextAndArtifactsForCopy(sanitizedContent, contentDiv); 
                } else if (Array.isArray(contentOrParts)) { 
                    let htmlOutput = "";
                    contentOrParts.forEach(part => {
                        if (part.text) htmlOutput += DOMPurify.sanitize(part.text, domPurifyConfig);
                    });
                    contentDiv.innerHTML = htmlOutput || "<p><i>Respons AI tidak valid.</i></p>";
                    extractTextAndArtifactsForCopy(htmlOutput, contentDiv);
                }
            } else if (role === 'system-info') {
                const sanitizedContent = DOMPurify.sanitize(contentOrParts, domPurifyConfig);
                contentDiv.innerHTML = sanitizedContent;
            }

            messageDiv.appendChild(contentDiv);

            const artifactDiv = contentDiv.querySelector('.artifact-container');
            if (artifactDiv) {
                if (contentDiv.querySelector('.code-artifact') || (artifactDiv.classList.contains('code-artifact'))) { 
                    artifactDiv.classList.add('code-artifact');
                } else if (contentDiv.querySelector('table') || (artifactDiv.classList.contains('table-artifact'))) {
                    artifactDiv.classList.add('table-artifact');
                }
                const artifactHeaderTitle = artifactDiv.querySelector('.artifact-header .artifact-title');
                if (artifactHeaderTitle) {
                    const clickHint = document.createElement('span');
                    clickHint.className = 'artifact-click-hint';
                    clickHint.textContent = '(klik untuk Melihat)';
                    artifactHeaderTitle.appendChild(clickHint);
                }
            }

             if (role === 'ai' && !(imageAIData && (imageAIData.imageUrl || imageAIData.processedCanvasDataUrl))) {
                 textForCopyFromContent = contentDiv.dataset.textForCopy || "";
             }


            const isThinkingLoader = role === 'ai' && typeof contentOrParts === 'string' && contentOrParts.includes('thinking-loader');
            const isImageProgressBubble = role === 'ai' && imageAIData && currentAppMode === 'imageai' && !imageAIData.processedCanvasDataUrl && !imageAIData.imageUrl; // Added check for no image URL yet


            const tempSanitizedDiv = document.createElement('div');
            if(typeof contentOrParts === 'string') tempSanitizedDiv.innerHTML = DOMPurify.sanitize(contentOrParts, domPurifyConfig);
            const isTypingCursorOnly = role === 'ai' && typeof contentOrParts === 'string' && tempSanitizedDiv.innerHTML.trim() === '<span class="typing-cursor"></span>';
            const isFetchingTextOnly = role === 'ai' && typeof contentOrParts === 'string' && contentOrParts.includes('fetching-text');

            if (!isError && !isThinkingLoader && !isImageProgressBubble && !isTypingCursorOnly && !isFetchingTextOnly && role !== 'system-info') {
                if (role === 'ai' && imageAIData && (imageAIData.imageUrl || imageAIData.processedCanvasDataUrl) ) {
                     let targetImageElement;
                     let isCanvas = false;
                     if (imageAIData.processedCanvasDataUrl) {
                         targetImageElement = contentDiv.querySelector('.processed-image-canvas');
                         isCanvas = true;
                     } else {
                         targetImageElement = contentDiv.querySelector('.pollinations-generated-image');
                     }

                    if (targetImageElement) {
                        const handleImageState = () => {
                             const successfullyLoaded = (isCanvas && targetImageElement && targetImageElement.width > 1 && targetImageElement.height > 1) || 
                                                     (!isCanvas && targetImageElement.complete && targetImageElement.naturalWidth > 0 && targetImageElement.src !== '' && !targetImageElement.src.startsWith('data:image/gif')); 
                            addMessageActions(messageDiv, textForCopyFromContent, successfullyLoaded ? imageAIData : null);
                        };
                         if ( (isCanvas && imageAIData.processedCanvasDataUrl) || (!isCanvas && targetImageElement.complete) ) { handleImageState(); } 
                        else if (!isCanvas) { targetImageElement.onload = handleImageState; targetImageElement.onerror = handleImageState; }
                    }
                } else if (textForCopyFromContent && textForCopyFromContent.trim() !== "" && (role === 'user' || (role === 'ai' && !(typeof contentOrParts === 'string' && contentOrParts.includes('typing-cursor')))) ) {
                     addMessageActions(messageDiv, textForCopyFromContent, null);
                }
            }


            chatContainer.appendChild(messageDiv);
            requestAnimationFrame(() => scrollToBottom((role === 'user') || (role === 'ai' && !currentAiMessageBubble && !isError) || (role === 'system-info')));
            return contentDiv;
        }

        function extractTextAndArtifactsForCopy(sanitizedHtml, contentDivElement) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = sanitizedHtml;
            let combinedText = "";

            tempDiv.querySelectorAll('.artifact-container').forEach(artifact => {
                const titleElement = artifact.querySelector('.artifact-title');
                let tempTitleHolder = titleElement ? titleElement.cloneNode(true) : null;
                if(tempTitleHolder && tempTitleHolder.querySelector('.artifact-click-hint')) {
                    tempTitleHolder.querySelector('.artifact-click-hint').remove(); 
                }
                const title = tempTitleHolder ? tempTitleHolder.textContent.trim() : "Artifact";

                const contentElement = artifact.querySelector('.artifact-content');
                let contentText = "";

                if (artifact.classList.contains('code-artifact')) {
                    const codeBlock = contentElement.querySelector('pre code');
                    contentText = codeBlock ? codeBlock.textContent : contentElement.textContent;
                } else if (artifact.classList.contains('table-artifact')) {
                     const table = contentElement.querySelector('table');
                     if(table) {
                        let rows = [];
                        table.querySelectorAll('tr').forEach(tr => {
                            let rowCells = [];
                            tr.querySelectorAll('th, td').forEach(cell => {
                                rowCells.push(`"${cell.textContent.replace(/"/g, '""')}"`);
                            });
                            rows.push(rowCells.join(','));
                        });
                        contentText = rows.join('\n');
                     } else {
                        contentText = contentElement.textContent;
                     }
                } else {
                    contentText = contentElement.textContent;
                }
                combinedText += `--- ${title} ---\n${contentText.trim()}\n--- Akhir ${title} ---\n\n`;
                artifact.remove(); 
            });

            combinedText = tempDiv.textContent.trim() + (combinedText ? `\n\n${combinedText}` : "");
            if(contentDivElement) contentDivElement.dataset.textForCopy = combinedText.trim();
            return combinedText.trim();
        }


        async function typeOutHTML(element, htmlString, onComplete) {
            if (!element) { if (onComplete) onComplete(true); return; }
            abortGenerationRequested = false;
            const fragments = (htmlString.match(/<[^>]+>|[^<]+/g) || []);
            let currentContent = '';
            element.innerHTML = DOMPurify.sanitize('<span class="typing-cursor"></span>', domPurifyConfig);
            
            async function typeFragment(index) {
                if (abortGenerationRequested) {
                    if (element && element.querySelector) element.querySelector('.typing-cursor')?.remove();
                    for (let i = index; i < fragments.length; i++) { currentContent += fragments[i]; }
                    element.innerHTML = DOMPurify.sanitize(currentContent, domPurifyConfig);
                    const textForCopy = extractTextAndArtifactsForCopy(currentContent, element);
                    addMessageActions(element.closest('.message'), textForCopy);
                    if (onComplete) onComplete(true); return;
                }
                if (index >= fragments.length) {
                    element.innerHTML = DOMPurify.sanitize(currentContent, domPurifyConfig);
                    const textForCopy = extractTextAndArtifactsForCopy(currentContent, element);
                    addMessageActions(element.closest('.message'), textForCopy);
                    if (onComplete) onComplete(false); return;
                }
                const fragment = fragments[index];
                if (fragment.startsWith('<')) {
                    currentContent += fragment;
                    element.innerHTML = DOMPurify.sanitize(currentContent + '<span class="typing-cursor"></span>', domPurifyConfig);
                    scrollToBottom();
                    requestAnimationFrame(() => typeFragment(index + 1));
                } else {
                    let charIndex = 0; let textBuffer = ''; let charsInBatch = 0;
                    async function typeCharBatch() {
                        if (abortGenerationRequested) {
                            if (element && element.querySelector) element.querySelector('.typing-cursor')?.remove();
                            currentContent += fragment.substring(charIndex);
                            element.innerHTML = DOMPurify.sanitize(currentContent, domPurifyConfig);
                             const textForCopy = extractTextAndArtifactsForCopy(currentContent, element);
                            addMessageActions(element.closest('.message'), textForCopy); 
                            if (onComplete) onComplete(true); return;
                         }
                        while(charIndex < fragment.length && charsInBatch < TYPING_BATCH_CHARS) { textBuffer += fragment[charIndex]; charIndex++; charsInBatch++; }
                        currentContent += textBuffer; textBuffer = ''; charsInBatch = 0;
                        element.innerHTML = DOMPurify.sanitize(currentContent + '<span class="typing-cursor"></span>', domPurifyConfig);
                        scrollToBottom();
                        if (charIndex < fragment.length) { setTimeout(typeCharBatch, TYPING_SPEED_MS_PER_CHAR * TYPING_BATCH_CHARS); }
                        else { typeFragment(index + 1); }
                    }
                    typeCharBatch();
                }
            }
            typeFragment(0);
        }

        async function handleStopProcessingClick() {
            abortGenerationRequested = true;

            if (currentAppMode === 'chatai' && isTypingAnimationActive) {
                if (currentAiMessageBubble) {
                    if (currentAiMessageBubble.querySelector) currentAiMessageBubble.querySelector('.typing-cursor')?.remove();
                    let existingHTML = currentAiMessageBubble.innerHTML;
                    const stoppedText = " <small class='stopped-text'><i>(Dibatalkan oleh pengguna)</i></small>";
                    if (!existingHTML.includes("Dibatalkan oleh pengguna")) currentAiMessageBubble.innerHTML = DOMPurify.sanitize(existingHTML + stoppedText, domPurifyConfig);
                    const textForCopy = extractTextAndArtifactsForCopy(existingHTML + stoppedText, currentAiMessageBubble);
                    addMessageActions(currentAiMessageBubble.closest('.message'), textForCopy);
                }
            } else if (currentAppMode === 'imageai' && (isGeneratingImage || isProcessingImageClientSide) ) {
                 if (temporaryThinkingBubble && temporaryThinkingBubble.closest('.message')) {
                    const imageContainer = temporaryThinkingBubble.querySelector('.pollinations-image-display-container');
                    if (imageContainer) {
                         const statusTextEl = imageContainer.querySelector('.image-process-status-text');
                         const progressBarCont = imageContainer.querySelector('.image-process-progress-bar-container');
                         const thinkingLoader = imageContainer.querySelector('.image-placeholder .thinking-loader');

                         if(statusTextEl) statusTextEl.textContent = "Pembuatan gambar dibatalkan.";
                         if(progressBarCont) progressBarCont.style.display = 'none';
                         if(thinkingLoader) thinkingLoader.style.display = 'none';
                    } else {
                        temporaryThinkingBubble.innerHTML = DOMPurify.sanitize("<p><i>Pembuatan gambar dibatalkan.</i></p>", domPurifyConfig);
                    }
                    addMessageActions(temporaryThinkingBubble.closest('.message'), "Pembuatan gambar dibatalkan.");
                }
            }

            if (temporaryThinkingBubble && temporaryThinkingBubble.closest('.message') && !(currentAppMode === 'imageai' && (isGeneratingImage || isProcessingImageClientSide || abortGenerationRequested)) ) { 
                 temporaryThinkingBubble.closest('.message').remove();
                 temporaryThinkingBubble = null;
            } else if (currentAppMode === 'imageai' && abortGenerationRequested && temporaryThinkingBubble && temporaryThinkingBubble.closest('.message')) {
            }

            isTypingAnimationActive = false;
            isGeneratingImage = false;
            isProcessingImageClientSide = false;
            setButtonStateForProcessing(false); 
        }

        async function getAIResponseAndHandleCommands(promptPartsForAI, isScrapingFollowUp = false) {
            userHasInteractedWithScroll = false;
            abortGenerationRequested = false;
            setButtonStateForProcessing(true); 

            if (!isScrapingFollowUp) {
                if (temporaryThinkingBubble && temporaryThinkingBubble.closest('.message')) {
                    temporaryThinkingBubble.closest('.message').remove();
                }
                temporaryThinkingBubble = addMessageToUI("ai", "");
                if (temporaryThinkingBubble) {
                    temporaryThinkingBubble.innerHTML = DOMPurify.sanitize('<div class="thinking-loader"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div>', domPurifyConfig);
                }
            }
            scrollToBottom(true);

            try {
                if (!genAI) {
                    const geminiReady = await initializeAI();
                    if (!geminiReady) {
                        throw new Error("Layanan Gemini (ChatAI) tidak dapat diinisialisasi.");
                    }
                }

                const generationConfig = {
                    temperature: (isDeepThinking ? 0.45 : 0.75),
                    topP: 0.9,
                    maxOutputTokens: (isDeepThinking ? 16000 : 8000)
                };
                
                const safetySettings = [
                    { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
                    { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
                    { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_LOW_AND_ABOVE }, 
                    { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE }
                ];

                const currentChatModel = genAI.getGenerativeModel({
                    model: currentGeminiModelName,
                    systemInstruction: getSystemInstructionForChatAI(),
                    safetySettings: safetySettings,
                    generationConfig: generationConfig
                });

                let historyForModelContext = isRoleResettedForNextInteraction ? [] : chatHistory.filter(entry => entry.role !== 'model' || (!entry.imageMeta && !entry.isProcessedImage) ) 
                    .map(entry => {
                     let combinedText = "";
                     let geminiImageParts = []; 
                     entry.parts.forEach(part => {
                        if(part.text) combinedText += (combinedText ? " " : "") + part.text;
                        if(part.inlineData && part.inlineData.mimeType.startsWith('image/') && entry.role === 'user') { 
                            geminiImageParts.push({ inlineData: part.inlineData });
                        }
                     });
                     if(entry.attachment && entry.role === 'user') { let attachmentText = `[File ${entry.attachment.name} dilampirkan sebelumnya]`; combinedText += (combinedText ? " " : "") + attachmentText; }

                     const modelParts = [];
                     if (combinedText) modelParts.push({ text: combinedText });
                     modelParts.push(...geminiImageParts);

                     return { role: entry.role, parts: modelParts.length > 0 ? modelParts : [{text: "(empty)"}] };
                });


                const completePromptContents = [...historyForModelContext, { role: 'user', parts: promptPartsForAI }];
                console.log(`Sending to Gemini (${currentGeminiModelName}). History Length:`, historyForModelContext.length, "Current User Msg Parts:", promptPartsForAI.map(p => p.text ? `Text (len ${p.text.length})` : (p.inlineData ? `File (${p.inlineData.mimeType})` : "Unknown Part")));

                const result = await currentChatModel.generateContent({ contents: completePromptContents });
                isRoleResettedForNextInteraction = false;

                const response = result.response;
                let aiResponseParts = [];
                let aiHtmlText = "";

                if (response && response.candidates && response.candidates.length > 0 && response.candidates[0].content && response.candidates[0].content.parts) {
                    aiResponseParts = response.candidates[0].content.parts;
                    const textPart = aiResponseParts.find(p => p.text);
                    if (textPart) aiHtmlText = textPart.text;
                } else {
                    aiHtmlText = "<p><i>Saya tidak dapat memberikan respons saat ini. Coba lagi.</i></p>";
                    if (response && response.promptFeedback && response.promptFeedback.blockReason) {
                         aiHtmlText = `<p><i>Respons diblokir: ${response.promptFeedback.blockReason}.</i></p>`;
                    }
                    aiResponseParts = [{text: aiHtmlText}];
                }


                const scrapeActionRegex = /<p>ACTION_SCRAPE_URL:\s*({.*?})<\/p>/i;
                const scrapeMatch = aiHtmlText.match(scrapeActionRegex);

                if (scrapeMatch && scrapeMatch[1] && !isScrapingFollowUp) {
                    console.log("Gemini requested URL scraping:", scrapeMatch[1]);
                    let scrapeParams;
                    try { scrapeParams = JSON.parse(scrapeMatch[1]); }
                    catch (e) { console.error("Failed to parse scrape params JSON from Gemini:", e); aiHtmlText = "<p><i>Error internal: Gagal memproses permintaan scraping dari AI.</i></p>"; }

                    if (scrapeParams && scrapeParams.url && scrapeParams.original_user_query) {
                        if (temporaryThinkingBubble) { temporaryThinkingBubble.innerHTML = DOMPurify.sanitize(`<p><small class="fetching-text"><i>Mengambil konten dari URL: ${DOMPurify.sanitize(scrapeParams.url)}...</i></small><span class="typing-cursor"></span></p>`, domPurifyConfig); }

                        const scrapeResult = await fetchUrlContent(scrapeParams.url);
                        let newPromptForAIScraped;

                        if (scrapeResult.success) { addMessageToUI("system-info", `<p><i>Konten dari ${DOMPurify.sanitize(scrapeParams.url)} berhasil diambil.</i></p>`); newPromptForAIScraped = `[Scraped content from URL: ${scrapeParams.url}]:\n${scrapeResult.content}\n\n[User's original query regarding this URL and any attachments]:\n${scrapeParams.original_user_query}`; }
                        else { addMessageToUI("system-info", `<p><i>Gagal mengambil konten dari URL: ${DOMPurify.sanitize(scrapeParams.url)}. Error: ${DOMPurify.sanitize(scrapeResult.error)}</i></p>`); newPromptForAIScraped = `[Failed to scrape content from URL: ${scrapeParams.url}. Error: ${scrapeResult.error}]\n\n[User's original query was]:\n${scrapeParams.original_user_query}\n\n[Inform the user about the scraping failure and try to answer based on the original query if possible, or ask for clarification.]`; }

                        const followUpParts = [{ text: newPromptForAIScraped }];
                        if (currentTurnUserIntent.attachmentInfo && currentTurnUserIntent.attachmentInfo.base64Data && currentTurnUserIntent.attachmentInfo.type === 'image') {
                            followUpParts.push({ inlineData: { mimeType: currentTurnUserIntent.attachmentInfo.fileMimeType, data: currentTurnUserIntent.attachmentInfo.base64Data } });
                        } else if (currentTurnUserIntent.attachmentInfo && currentTurnUserIntent.attachmentInfo.base64Data && currentTurnUserIntent.attachmentInfo.type === 'document') {
                            followUpParts.push({ inlineData: { mimeType: currentTurnUserIntent.attachmentInfo.fileMimeType, data: currentTurnUserIntent.attachmentInfo.base64Data } });
                        }
                        await getAIResponseAndHandleCommands(followUpParts, true);
                        return;
                    }
                }


                if (temporaryThinkingBubble && temporaryThinkingBubble.closest('.message')) {
                    temporaryThinkingBubble.closest('.message').remove();
                    temporaryThinkingBubble = null;
                }

                currentAiMessageBubble = addMessageToUI("ai", "");

                if (response.promptFeedback && response.promptFeedback.blockReason) {
                    aiHtmlText = `<p><b>Respons tidak dapat ditampilkan:</b> Konten diblokir. (${response.promptFeedback.blockReason})</p>`;
                    aiResponseParts = [{text: aiHtmlText}];
                    if(currentAiMessageBubble.closest('.message')) currentAiMessageBubble.closest('.message').classList.add("error-message");
                }
                else if (isDeepThinking && !aiHtmlText.toLowerCase().includes("deepthink mode:") && !aiHtmlText.toLowerCase().includes("mode berpikir mendalam:")) {
                    aiHtmlText = `<p><b><i>Mode Berpikir Mendalam:</i></b></p>${aiHtmlText.trim().toLowerCase().startsWith("<p>") || aiHtmlText.trim().toLowerCase().startsWith("<ul") || aiHtmlText.trim().toLowerCase().startsWith("<ol") ? aiHtmlText : `<p>${aiHtmlText}</p>`}`;
                    const textPartIndex = aiResponseParts.findIndex(p => p.text);
                    if (textPartIndex !== -1) aiResponseParts[textPartIndex].text = aiHtmlText;
                    else aiResponseParts.unshift({text: aiHtmlText});
                }

                if (aiHtmlText && aiHtmlText.trim() !== "") {
                    await typeOutHTML(currentAiMessageBubble, aiHtmlText, (wasAborted) => {
                        if (!wasAborted) {
                            addMessageToChatHistory("user", [{ text: currentTurnUserIntent.text }], currentTurnUserIntent.attachmentInfo ? { name: currentTurnUserIntent.attachmentInfo.name, type: currentTurnUserIntent.attachmentInfo.type, previewHTML: currentTurnUserIntent.attachmentInfo.previewHTML, dataUrl: currentTurnUserIntent.attachmentInfo.dataUrl } : null);
                            addMessageToChatHistory("model", aiResponseParts);
                        }
                        currentTurnUserIntent = { text: null, attachmentInfo: null };
                        currentAiMessageBubble = null;
                        if (!wasAborted) { 
                           isTypingAnimationActive = false; 
                           setButtonStateForProcessing(false);
                        }
                    });
                } else {
                     currentAiMessageBubble.innerHTML = DOMPurify.sanitize("<p><i>Respons kosong atau tidak dikenal.</i></p>", domPurifyConfig);
                     addMessageActions(currentAiMessageBubble.closest('.message'), "Respons kosong atau tidak dikenal.");
                     addMessageToChatHistory("user", [{ text: currentTurnUserIntent.text }], currentTurnUserIntent.attachmentInfo ? { name: currentTurnUserIntent.attachmentInfo.name, type: currentTurnUserIntent.attachmentInfo.type, previewHTML: currentTurnUserIntent.attachmentInfo.previewHTML, dataUrl: currentTurnUserIntent.attachmentInfo.dataUrl } : null);
                     addMessageToChatHistory("model", [{text: "Respons kosong atau tidak dikenal."}]);
                     currentTurnUserIntent = { text: null, attachmentInfo: null };
                     isTypingAnimationActive = false; setButtonStateForProcessing(false);
                     currentAiMessageBubble = null;
                }


            } catch (error) {
                console.error("Error in getAIResponseAndHandleCommands (Raw):", error);
                isRoleResettedForNextInteraction = false;
                let userFriendlyErrorMessage = `<p><b>Oops!</b> Terjadi kesalahan: ${error.message}. Coba lagi.</p>`;
                 if (error.message && error.message.toLowerCase().includes("quota") || error.message.toLowerCase().includes("api key not valid")) { userFriendlyErrorMessage = `<p><b>Oops!</b> Terjadi masalah dengan layanan AI. Harap coba lagi nanti.</p>`; }
                 else if (error.message && error.message.toLowerCase().includes("candidate.content.parts is missing")) { userFriendlyErrorMessage = `<p><b>Oops!</b> AI tidak memberikan respons yang valid. Coba sederhanakan pertanyaan Anda.</p>`; }
                 else if (error.message && error.message.toLowerCase().includes("must have a text part") && currentAppMode === 'chatai') { userFriendlyErrorMessage = `<p><b>Oops!</b> Terjadi kesalahan internal saat mengirim data ke AI.</p>`; }
                 else if (error.message && (error.message.toLowerCase().includes("fetcherror") || error.message.toLowerCase().includes("networkerror") || error.message.toLowerCase().includes("failed to fetch"))) { userFriendlyErrorMessage = `<p><b>Oops!</b> Masalah koneksi. Periksa jaringan Anda dan coba lagi.</p>`;}

                if (temporaryThinkingBubble && temporaryThinkingBubble.closest('.message')) { temporaryThinkingBubble.closest('.message').remove(); temporaryThinkingBubble = null; }
                let errorBubbleContent;
                if (currentAiMessageBubble && currentAiMessageBubble.parentElement) {
                    currentAiMessageBubble.innerHTML = DOMPurify.sanitize(userFriendlyErrorMessage, domPurifyConfig);
                    if(currentAiMessageBubble.closest('.message')) currentAiMessageBubble.closest('.message').classList.add("error-message");
                    errorBubbleContent = currentAiMessageBubble;
                } else {
                   errorBubbleContent = addMessageToUI("ai", DOMPurify.sanitize(userFriendlyErrorMessage, domPurifyConfig), true);
                }
                if (errorBubbleContent) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = DOMPurify.sanitize(userFriendlyErrorMessage, domPurifyConfig);
                    addMessageActions(errorBubbleContent.closest('.message'), tempDiv.textContent || tempDiv.innerText || "");
                }

                isTypingAnimationActive = false; setButtonStateForProcessing(false);
                currentAiMessageBubble = null; currentTurnUserIntent = { text: null, attachmentInfo: null };
            }
        }
        
        async function urlToImageData(url, targetBubble) {
            if (targetBubble) {
                const imagePlaceholder = targetBubble.querySelector('.image-placeholder');
                const thinkingLoader = imagePlaceholder?.querySelector('.thinking-loader');
                const statusTextEl = targetBubble.querySelector('.image-process-status-text');
                const progressBarCont = targetBubble.querySelector('.image-process-progress-bar-container');

                if(thinkingLoader) thinkingLoader.style.display = 'flex'; 
                if(statusTextEl) statusTextEl.textContent = "Mengunduh gambar dari Pollinations...";
                if(progressBarCont) progressBarCont.style.display = 'none'; 
            }

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    if (url.includes("pollinations.ai") && SCRAPER_PHP_URL && !SCRAPER_PHP_URL.includes("YOUR_SCRAPERWEB_PHP_URL_HERE")) {
                        console.warn(`Fetch CORS gagal untuk ${url}, mencoba via proxy...`);
                        const proxyUrl = `${SCRAPER_PHP_URL}?scrape_url=${encodeURIComponent(url)}&binary=true`;
                        const proxyResponse = await fetch(proxyUrl);
                         if (!proxyResponse.ok) { throw new Error(`Gagal mengambil gambar via proxy: HTTP ${proxyResponse.status}`);}
                        const blob = await proxyResponse.blob();
                        return blobToImageData(blob, targetBubble);
                    }
                    throw new Error(`Gagal mengambil gambar: HTTP ${response.status}`);
                }
                const blob = await response.blob();
                return blobToImageData(blob, targetBubble);
            } catch (error) {
                console.error("Error fetching image for ImageData conversion:", error);
                if (targetBubble) {
                    const statusTextEl = targetBubble.querySelector('.image-process-status-text');
                    const thinkingLoader = targetBubble.querySelector('.image-placeholder .thinking-loader');
                    if(statusTextEl) statusTextEl.textContent = `Error mengunduh: ${error.message}`;
                    if(thinkingLoader) thinkingLoader.style.display = 'none';
                }
                throw error; 
            }
        }

        async function blobToImageData(blob, targetBubble) {
             if (targetBubble) {
                const statusTextEl = targetBubble.querySelector('.image-process-status-text');
                if(statusTextEl) statusTextEl.textContent = "Mengonversi gambar...";
            }
            return new Promise((resolve, reject) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                img.onload = () => {
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    ctx.drawImage(img, 0, 0);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    URL.revokeObjectURL(img.src); 
                    resolve(imageData);
                };
                img.onerror = (err) => {
                    URL.revokeObjectURL(img.src);
                    reject(new Error("Gagal memuat blob gambar ke Image elemen." + (err.message ? ` Detail: ${err.message}` : '')));
                };
                img.src = URL.createObjectURL(blob);
            });
        }


        async function generatePollinationsImage(prompt) {
            userHasInteractedWithScroll = false;
            abortGenerationRequested = false;
            setButtonStateForProcessing(true); 
            isGeneratingImage = true; 

            if (temporaryThinkingBubble && temporaryThinkingBubble.closest('.message')) {
                temporaryThinkingBubble.closest('.message').remove();
            }

            const originalUserPrompt = prompt;
            const imageAIData = {
                prompt: originalUserPrompt, 
                imageUrl: null, 
                model: currentImageAI_PollinationsModel,
                aspectRatio: currentImageAI_AspectRatio,
                processedCanvasDataUrl: null
            };
            
            temporaryThinkingBubble = addMessageToUI("ai", "", false, null, imageAIData); 

            if (temporaryThinkingBubble) {
                const imageContainer = temporaryThinkingBubble.querySelector('.pollinations-image-display-container');
                if (imageContainer) {
                    const thinkingLoader = imageContainer.querySelector('.image-placeholder .thinking-loader');
                    const statusTextEl = imageContainer.querySelector('.image-process-status-text');
                    const progressBarCont = imageContainer.querySelector('.image-process-progress-bar-container');
                    
                    if(thinkingLoader) thinkingLoader.style.display = 'flex'; 
                    if(statusTextEl) statusTextEl.textContent = "Menghubungi Pollinations...";
                    if(progressBarCont) progressBarCont.style.display = 'none'; 
                }
            }
            scrollToBottom(true);
            
            const selectedRatioConfig = imageAI_AspectRatios_WithCrop[currentImageAI_AspectRatio] || imageAI_AspectRatios_WithCrop["1:1"];
            const originalWidth = selectedRatioConfig.width;
            const originalHeight = selectedRatioConfig.height;
            const upscaleFactor = 2; 
            const upscaledWidth = originalWidth * upscaleFactor;
            const upscaledHeight = originalHeight * upscaleFactor;
            const cropPercent = selectedRatioConfig.cropPercent; 
            const seed = Math.floor(Math.random() * 100000000);

            let pollingationsApiUrl = `${POLLINATIONS_BASE_URL}${encodeURIComponent(originalUserPrompt)}`;
            const queryParams = [];
            queryParams.push(`width=${originalWidth}`); 
            queryParams.push(`height=${originalHeight}`);
            queryParams.push(`seed=${seed}`);
            if (currentImageAI_PollinationsModel && currentImageAI_PollinationsModel !== "default") {
                queryParams.push(`model=${encodeURIComponent(currentImageAI_PollinationsModel)}`);
            }
            if (queryParams.length > 0) pollingationsApiUrl += '?' + queryParams.join('&');
            
            console.log("Pollinations API URL (requesting original size):", pollingationsApiUrl);
            imageAIData.imageUrl = pollingationsApiUrl; 

            if(temporaryThinkingBubble?.closest('.message')) { 
                temporaryThinkingBubble.closest('.message').dataset.imageaidata = JSON.stringify(imageAIData);
            }

            const minFetchDelayPromise = new Promise(resolve => setTimeout(resolve, MIN_IMAGE_LOADING_DISPLAY_MS));
            let imageDataFromPollinations;

            try {
                imageDataFromPollinations = await urlToImageData(pollingationsApiUrl, temporaryThinkingBubble); 
                await minFetchDelayPromise;

                if (abortGenerationRequested) {
                    if (temporaryThinkingBubble && temporaryThinkingBubble.closest('.message')) {
                         const imageContainer = temporaryThinkingBubble.querySelector('.pollinations-image-display-container');
                         if (imageContainer) {
                             const statusTextEl = imageContainer.querySelector('.image-process-status-text');
                             const thinkingLoader = imageContainer.querySelector('.image-placeholder .thinking-loader');
                             if (statusTextEl) statusTextEl.textContent = "Pembuatan gambar dibatalkan.";
                             if (thinkingLoader) thinkingLoader.style.display = 'none';
                         } else {
                            temporaryThinkingBubble.innerHTML = DOMPurify.sanitize("<p><i>Pembuatan gambar dibatalkan.</i></p>", domPurifyConfig);
                         }
                        addMessageActions(temporaryThinkingBubble.closest('.message'), "Pembuatan gambar dibatalkan.");
                    }
                    isGeneratingImage = false;
                    isProcessingImageClientSide = false;
                    setButtonStateForProcessing(false);
                    currentTurnUserIntent = { text: null, attachmentInfo: null };
                    temporaryThinkingBubble = null; 
                    return;
                }

                isGeneratingImage = false; 

                if (imageDataFromPollinations) {
                    isProcessingImageClientSide = true;
                    setButtonStateForProcessing(true); 

                    if (temporaryThinkingBubble) {
                        const imageContainer = temporaryThinkingBubble.querySelector('.pollinations-image-display-container');
                        if (imageContainer) {
                            const thinkingLoader = imageContainer.querySelector('.image-placeholder .thinking-loader');
                            const progressBarCont = imageContainer.querySelector('.image-process-progress-bar-container');
                            const progressBarEl = progressBarCont?.querySelector('.image-process-progress-bar');
                            const statusTextEl = imageContainer.querySelector('.image-process-status-text');
                            const imgElement = imageContainer.querySelector('.pollinations-generated-image');
                            
                            if (imgElement) { // Update image src if successfully downloaded
                                imgElement.src = pollingationsApiUrl; // Show the initially downloaded image
                                imgElement.style.display = 'block';
                            }
                            if(thinkingLoader) thinkingLoader.style.display = 'none'; // Hide dots as image is shown or processing starts
                            if(progressBarCont) progressBarCont.style.display = 'block';
                            if(progressBarEl) { progressBarEl.style.width = '0%'; progressBarEl.textContent = '0%'; } 
                            if(statusTextEl) statusTextEl.textContent = "Memulai pemrosesan gambar (denoise, sharpen, upscale, crop)...";
                        }
                    }
                    
                    const workerParams = {
                        ...imageEnhancementParams,
                        cropPercent: cropPercent 
                    };

                    imageProcessorWorker.postMessage({
                        imageData: imageDataFromPollinations,
                        params: workerParams,
                        newWidth: upscaledWidth, 
                        newHeight: upscaledHeight
                    });
                    
                    addMessageToChatHistory("user", [{ text: originalUserPrompt }]);

                } else { 
                    console.error("Tidak ada ImageData yang diterima dari Pollinations untuk diproses.");
                     if (temporaryThinkingBubble && temporaryThinkingBubble.closest('.message')) {
                        const imageContainer = temporaryThinkingBubble.querySelector('.pollinations-image-display-container');
                         if (imageContainer && !temporaryThinkingBubble.textContent.toLowerCase().includes("error")) { 
                            const statusTextEl = imageContainer.querySelector('.image-process-status-text');
                            const thinkingLoader = imageContainer.querySelector('.image-placeholder .thinking-loader');
                            if (statusTextEl) statusTextEl.textContent = "Gagal mendapatkan data gambar dari Pollinations.";
                            if (thinkingLoader) thinkingLoader.style.display = 'none';
                            temporaryThinkingBubble.closest('.message').classList.add("error-message");
                            addMessageActions(temporaryThinkingBubble.closest('.message'), "Gagal mendapatkan data gambar.");
                         } else if (!imageContainer) { 
                            temporaryThinkingBubble.innerHTML = DOMPurify.sanitize(`<p><i>Gagal mendapatkan data gambar dari Pollinations untuk diproses.</i></p>`, domPurifyConfig);
                            temporaryThinkingBubble.closest('.message').classList.add("error-message");
                            addMessageActions(temporaryThinkingBubble.closest('.message'), "Gagal mendapatkan data gambar.");
                         }
                    }
                    isProcessingImageClientSide = false;
                    setButtonStateForProcessing(false);
                    currentTurnUserIntent = { text: null, attachmentInfo: null };
                    addMessageToChatHistory("user", [{ text: originalUserPrompt }]);
                    addMessageToChatHistory("model", [{ text: "Gagal memuat gambar dari Pollinations untuk diproses." }]);
                    temporaryThinkingBubble = null; 
                }

            } catch (error) { 
                console.error("Error saat generatePollinationsImage (setelah fetch attempt):", error);
                isGeneratingImage = false;
                isProcessingImageClientSide = false;
                
                if (temporaryThinkingBubble && temporaryThinkingBubble.closest('.message')) {
                    const imageContainer = temporaryThinkingBubble.querySelector('.pollinations-image-display-container');
                    if (imageContainer) {
                        const statusTextEl = imageContainer.querySelector('.image-process-status-text');
                        const thinkingLoader = imageContainer.querySelector('.image-placeholder .thinking-loader');
                        if (statusTextEl) statusTextEl.textContent = `Error: ${error.message}`;
                        if (thinkingLoader) thinkingLoader.style.display = 'none';
                    } else {
                        temporaryThinkingBubble.innerHTML = DOMPurify.sanitize(`<p><i>Error: ${error.message}</i></p>`, domPurifyConfig);
                    }
                    temporaryThinkingBubble.closest('.message').classList.add("error-message");
                    addMessageActions(temporaryThinkingBubble.closest('.message'), `Error: ${error.message}`);
                }
                setButtonStateForProcessing(false);
                currentTurnUserIntent = { text: null, attachmentInfo: null };
                addMessageToChatHistory("user", [{ text: originalUserPrompt }]);
                addMessageToChatHistory("model", [{ text: `Error memproses permintaan gambar: ${error.message}` }]);
                temporaryThinkingBubble = null;
            }
        }


        async function prepareAndSendMessage(isManualInput = true) {
            const isProcessing = isTypingAnimationActive || isGeneratingImage || isProcessingImageClientSide;
            if (isProcessing) {
                return; 
            }

            let userMessageText = "";
            if (isManualInput && userInput) { userMessageText = userInput.value.trim(); }
            else { userMessageText = currentTurnUserIntent.text || ""; }

            const canSendChatAI = currentAppMode === 'chatai' && (userMessageText || attachedFile.fileObject);
            const canSendImageAI = currentAppMode === 'imageai' && userMessageText;

            if (isManualInput && !canSendChatAI && !canSendImageAI) {
                currentTurnUserIntent = { text: null, attachmentInfo: null }; return;
            }
            
            currentTurnUserIntent.text = userMessageText;
            currentTurnUserIntent.attachmentInfo = null;
            let attachmentDisplayInfoForUI = null;

            if (isManualInput && attachedFile.fileObject && currentAppMode === 'chatai') {
                const previewInfoSpan = document.getElementById('attached-preview-info');
                const originalPreviewText = previewInfoSpan ? previewInfoSpan.textContent : "";
                if(previewInfoSpan) previewInfoSpan.textContent += ' (memproses...)';
                try {
                    let preparedData;
                    if (attachedFile.type === 'image') {
                        preparedData = { name: attachedFile.name, mimeType: attachedFile.fileMimeType, dataUrl: attachedFile.dataUrl, base64Data: attachedFile.base64Data, extractedText: null, previewHTML: attachedFile.previewHTML };
                    } else { 
                        if (attachedFile.fileObject.type.startsWith('image/')) { 
                             throw new Error("Tipe file gambar tidak diizinkan untuk 'Lampirkan Dokumen'. Gunakan 'Lampirkan Gambar'.");
                        }
                        preparedData = await prepareFileDataForGemini(attachedFile.fileObject);
                        preparedData.previewHTML = attachedFile.previewHTML;
                    }

                    currentTurnUserIntent.attachmentInfo = {
                        type: attachedFile.type, name: preparedData.name, fileMimeType: preparedData.mimeType,
                        base64Data: preparedData.base64Data, extractedText: preparedData.extractedText,
                        dataUrl: preparedData.dataUrl, previewHTML: preparedData.previewHTML
                    };
                    attachmentDisplayInfoForUI = { name: preparedData.name, type: attachedFile.type, previewHTML: preparedData.previewHTML, dataUrl: preparedData.dataUrl };

                } catch (e) {
                    showCustomDialog("Error Memproses Lampiran", `Gagal memproses file ${attachedFile.name || 'lampiran'}: ${e.message}`, "alert");
                    clearAttachment(); 
                    if(previewInfoSpan && originalPreviewText) previewInfoSpan.textContent = originalPreviewText.replace(' (memproses...)', '');
                    if (!currentTurnUserIntent.text) { currentTurnUserIntent = { text: null, attachmentInfo: null }; return; }
                }
                finally { if(previewInfoSpan && previewInfoSpan.textContent.endsWith(' (memproses...)')) { previewInfoSpan.textContent = originalPreviewText; } }
            }


            if (currentAppMode === 'imageai' && currentTurnUserIntent.text) {
                const lowerUserText = currentTurnUserIntent.text.toLowerCase();
                const foundForbiddenWord = forbiddenKeywords.find(keyword => lowerUserText.includes(keyword.toLowerCase()));

                if (foundForbiddenWord) {
                    showCustomDialog(
                        "Konten Tidak Diizinkan",
                        "Maaf, prompt Anda terdeteksi mengandung kata-kata yang tidak pantas atau berbau seksual. Harap ubah prompt Anda dan gunakan kata-kata yang lebih sopan.",
                        "alert"
                    );
                    if (!isManualInput || !userInput) { 
                         currentTurnUserIntent = { text: null, attachmentInfo: null };
                    }
                    return; 
                }
            }

            setButtonStateForProcessing(true); 

            if (isManualInput) {
                addMessageToUI("user", currentTurnUserIntent.text, false, attachmentDisplayInfoForUI);
                if(userInput) {
                    userInput.value = ""; 
                }
                clearAttachment();
                adjustLayout(); 
                updateSendButtonState(); 
                
                if (userInput) {
                    userInput.blur();
                }
            }

            if (currentAppMode === 'chatai') {
                const geminiContentParts = [];
                let combinedTextForAI = currentTurnUserIntent.text || "";

                if (currentTurnUserIntent.attachmentInfo) {
                    if (currentTurnUserIntent.attachmentInfo.type === 'image' && currentTurnUserIntent.attachmentInfo.base64Data) {
                        geminiContentParts.push({ inlineData: { mimeType: currentTurnUserIntent.attachmentInfo.fileMimeType || 'image/jpeg', data: currentTurnUserIntent.attachmentInfo.base64Data } });
                    } else if (currentTurnUserIntent.attachmentInfo.type === 'document') {
                        if (currentTurnUserIntent.attachmentInfo.base64Data && currentTurnUserIntent.attachmentInfo.fileMimeType && !currentTurnUserIntent.attachmentInfo.fileMimeType.startsWith('image/')) {
                            geminiContentParts.push({ inlineData: { mimeType: currentTurnUserIntent.attachmentInfo.fileMimeType, data: currentTurnUserIntent.attachmentInfo.base64Data } });
                        } else if (currentTurnUserIntent.attachmentInfo.extractedText) {
                            combinedTextForAI = `[Konten dari file terlampir: ${currentTurnUserIntent.attachmentInfo.name}]\n${currentTurnUserIntent.attachmentInfo.extractedText}\n[Akhir dari konten file: ${currentTurnUserIntent.attachmentInfo.name}]\n\n${combinedTextForAI}`;
                        }
                    }
                }

                if (combinedTextForAI.trim()) {
                    geminiContentParts.unshift({ text: combinedTextForAI.trim() });
                } else if (geminiContentParts.length > 0 && currentTurnUserIntent.attachmentInfo?.name) {
                    geminiContentParts.unshift({ text: `Tolong proses file terlampir (${currentTurnUserIntent.attachmentInfo.name}).` });
                }

                if (geminiContentParts.length === 0) {
                    console.warn("No content to send to Gemini.");
                    setButtonStateForProcessing(false); 
                    currentTurnUserIntent = { text: null, attachmentInfo: null }; return;
                }
                getAIResponseAndHandleCommands(geminiContentParts);

            } else if (currentAppMode === 'imageai') {
                generatePollinationsImage(currentTurnUserIntent.text);
            }
        }

        async function startApp() {
            updateInputAreaVisibility(); 
            
            temporaryThinkingBubble = addMessageToUI("ai", "");
            let connectingToService = "";
            if (currentAppMode === 'chatai') connectingToService = 'FlabsAI (Chat - Gemini)';
            else connectingToService = 'FlabsAI (ImageAI - Pollinations)';

            if(temporaryThinkingBubble) temporaryThinkingBubble.innerHTML = DOMPurify.sanitize(`<p>Menghubungkan ke ${connectingToService}... <span class="typing-cursor"></span></p>`, domPurifyConfig);

            const aiServiceReady = await initializeAI();

            if(temporaryThinkingBubble && temporaryThinkingBubble.closest('.message')) { temporaryThinkingBubble.closest('.message').remove(); temporaryThinkingBubble = null; }

            if (aiServiceReady || currentAppMode === 'imageai') {
                let welcomeTextCore = "";

                if (currentAppMode === 'chatai') {
                    if (!genAI && ACTUAL_API_KEY && ACTUAL_API_KEY !== "GANTI_DENGAN_API_KEY_ANDA" && ACTUAL_API_KEY.length > 10) {
                         welcomeTextCore = `<p>Halo! Saya <b>FlabsAI (Chat)</b>.</p><p>Ada masalah saat menginisialisasi layanan Gemini. Fitur chat mungkin terbatas. Anda masih bisa mencoba melampirkan file atau menggunakan mode ImageAI.</p>`;
                    } else {
                        welcomeTextCore = `<p>Halo!  Saya <b>FlabsAI (Chat)</b>.</p><p>Ada yang bisa saya bantu hari ini?</p><p> Gunakan <b>Google, Chrome, Dan Firefox <b> agar berjalan lebih baik</p></b><p>follow : @femaandara_</p>`;
                    }
                } else {
                    welcomeTextCore = `<p>Halo!  Saya <b>FlabsAI (ImageAI)</b>.</p><p>Masukkan deskripsi gambar yang ingin Anda buat di kolom input di bawah. Gunakan tombol di bawah untuk memilih aspek rasio dan model (Pollinations).</p><p><small>Gambar yang dihasilkan Pollinations akan diproses (ditingkatkan kualitasnya, di-upscale 2x & di-crop) secara otomatis sebelum ditampilkan.</small></p>`;
                }

                currentAiMessageBubble = addMessageToUI("ai", "");
                if (currentAiMessageBubble) {
                    setButtonStateForProcessing(true);
                    await typeOutHTML(currentAiMessageBubble, welcomeTextCore, (wasAborted) => {
                        if (!wasAborted) {
                             const tempDiv = document.createElement('div');
                             tempDiv.innerHTML = DOMPurify.sanitize(welcomeTextCore, domPurifyConfig);
                             addMessageToChatHistory("model", [{text: tempDiv.textContent || tempDiv.innerText || ""}]);
                        }
                        currentAiMessageBubble = null;
                        isTypingAnimationActive = false; 
                        setButtonStateForProcessing(false);
                    });
                } else {
                    setButtonStateForProcessing(false);
                    currentAiMessageBubble = null;
                }
            } else {
                 disableChat(); 
            }
        }

        function loadDarkModePreference() {
            const darkModeStored = localStorage.getItem('darkMode');
            const htmlEl = document.documentElement;

            if (darkModeStored === 'true' || (darkModeStored === null && htmlEl.classList.contains('dark-mode-loading-init'))) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            updateDarkModeButtonIcon();
        }


        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            updateDarkModeButtonIcon();
        }

        function updateDarkModeButtonIcon() {
            if (!darkModeToggleBtn) return;
            const isDark = document.body.classList.contains('dark-mode');
            const darkIcon = darkModeToggleBtn.querySelector('.icon-dark-mode');
            const lightIcon = darkModeToggleBtn.querySelector('.icon-light-mode');
            if (darkIcon) darkIcon.style.display = isDark ? 'none' : 'inline-block';
            if (lightIcon) lightIcon.style.display = isDark ? 'inline-block' : 'none';
            darkModeToggleBtn.title = isDark ? "Aktifkan Mode Terang" : "Aktifkan Mode Gelap";
        }
        
        
        function handleArtifactAction(action, artifactContainerElement, buttonClicked) {
            if (!artifactContainerElement) return;
            const artifactContentElement = artifactContainerElement.querySelector('.artifact-content');
            const artifactTitleElement = artifactContainerElement.querySelector('.artifact-title');
             let title = "Artifact";
             if(artifactTitleElement) {
                const tempTitleClone = artifactTitleElement.cloneNode(true);
                const hint = tempTitleClone.querySelector('.artifact-click-hint');
                if (hint) hint.remove();
                title = tempTitleClone.textContent.trim();
             }

            const isCodeArtifact = artifactContainerElement.classList.contains('code-artifact');
            const isTableArtifact = artifactContainerElement.classList.contains('table-artifact');

            if (action === 'expand') {
                openArtifactViewer(title, artifactContentElement.innerHTML, isCodeArtifact, isTableArtifact);
            } else if (action === 'copy') {
                let textToCopy = "";
                if (isCodeArtifact) {
                    const codeBlock = artifactContentElement.querySelector('pre code');
                    textToCopy = codeBlock ? codeBlock.textContent : artifactContentElement.textContent;
                } else if (isTableArtifact) {
                    textToCopy = tableToCSV(artifactContentElement.querySelector('table'));
                } else {
                    textToCopy = artifactContentElement.textContent;
                }
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalHTML = buttonClicked.innerHTML;
                    buttonClicked.innerHTML = checkIconSVG;
                    setTimeout(() => { buttonClicked.innerHTML = copyIconSVG; }, 1500);
                }).catch(err => showCustomDialog("Error", "Gagal menyalin artifact.", "alert"));
            } else if (action === 'download') {
                downloadArtifact(title, artifactContentElement, isCodeArtifact, isTableArtifact);
            }
        }
        
        function tableToCSV(tableElement) {
            if (!tableElement) return "";
            let csv = [];
            const rows = tableElement.querySelectorAll("tr");
            for (const row of rows) {
                const cols = row.querySelectorAll("td, th");
                const csvRow = [];
                for (const col of cols) {
                    let data = col.innerText.replace(/"/g, '""'); 
                    if (data.includes(",")) data = `"${data}"`; 
                    csvRow.push(data);
                }
                csv.push(csvRow.join(","));
            }
            return csv.join("\n");
        }
        
        function determineArtifactFileExtension(title, isCode, isTable) {
            if (isTable) return ".csv";
            if (isCode) {
                const lowerTitle = title.toLowerCase();
                if (lowerTitle.includes("python")) return ".py";
                if (lowerTitle.includes("javascript") || lowerTitle.includes("js")) return ".js";
                if (lowerTitle.includes("html")) return ".html";
                if (lowerTitle.includes("css")) return ".css";
                if (lowerTitle.includes("java")) return ".java";
                if (lowerTitle.includes("json")) return ".json";
            }
            return ".txt"; 
        }
        
        function downloadArtifact(title, contentElement, isCode, isTable, fromModal = false) {
            let dataToDownload;
            const fileExtension = determineArtifactFileExtension(title, isCode, isTable);
            let mimeType = "text/plain;charset=utf-8";

            if (isTable) {
                const tableEl = fromModal ? contentElement.querySelector('table') : contentElement.querySelector('.table-artifact-viewer-content table, .artifact-content table');
                dataToDownload = tableToCSV(tableEl);
                mimeType = "text/csv;charset=utf-8";
            } else if (isCode) {
                 const codeBlock = fromModal ? contentElement.querySelector('pre code') : contentElement.querySelector('.code-artifact-viewer-content pre code, .artifact-content pre code');
                dataToDownload = codeBlock ? codeBlock.textContent : contentElement.textContent;
            } else {
                dataToDownload = contentElement.textContent;
            }
            
            const safeFilenameBase = title.substring(0, 50).replace(/[^a-z0-9 _-]/gi, '_').toLowerCase();
            const filename = `${safeFilenameBase || "artifact"}${fileExtension}`;
            
            const blob = new Blob([dataToDownload], { type: mimeType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);

            if (fromModal && artifactViewerDownloadBtn) { 
                const originalBtnContent = artifactViewerDownloadBtn.innerHTML; 
                const checkHTML = `<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></svg> Terunduh`;
                artifactViewerDownloadBtn.innerHTML = DOMPurify.sanitize(checkHTML, domPurifyConfig);
                setTimeout(() => {
                    artifactViewerDownloadBtn.innerHTML = originalBtnContent;
                }, 2000);
            }
        }

        function openArtifactViewer(title, contentHTML, isCode, isTable) {
            if (!artifactViewerModal || !artifactViewerTitle || !artifactViewerModalBody || !artifactViewerCopyBtn || !artifactViewerDownloadBtn || !modalActionsBar) return;
            
            artifactViewerTitle.textContent = title || "Lihat Artifact";
            let displayContent = "";
            if (isCode) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = contentHTML; 
                const codeText = tempDiv.querySelector('pre code') ? tempDiv.querySelector('pre code').textContent : tempDiv.textContent;
                displayContent = `<div class="code-artifact-viewer-content"><pre><code>${DOMPurify.sanitize(codeText, {...domPurifyConfig, ALLOWED_TAGS:[]})}</code></pre></div>`;
            } else if (isTable) {
                displayContent = `<div class="table-artifact-viewer-content">${DOMPurify.sanitize(contentHTML, domPurifyConfig)}</div>`;
            } else {
                displayContent = DOMPurify.sanitize(contentHTML, domPurifyConfig);
            }
            artifactViewerModalBody.innerHTML = displayContent;
            
            artifactViewerCopyBtn.innerHTML = DOMPurify.sanitize(`${copyIconSVG} Salin`, domPurifyConfig);
            artifactViewerDownloadBtn.innerHTML = DOMPurify.sanitize(`${downloadIconSVG} Unduh`, domPurifyConfig);

            artifactViewerCopyBtn.onclick = () => {
                let textToCopy;
                if (isCode) {
                    const codeBlock = artifactViewerModalBody.querySelector('.code-artifact-viewer-content pre code');
                    textToCopy = codeBlock ? codeBlock.textContent : artifactViewerModalBody.textContent;
                } else if (isTable) {
                    textToCopy = tableToCSV(artifactViewerModalBody.querySelector('.table-artifact-viewer-content table'));
                } else {
                    textToCopy = artifactViewerModalBody.textContent;
                }
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalHTML = artifactViewerCopyBtn.innerHTML;
                    const checkHTML = `${checkIconSVG} Tersalin`;
                     artifactViewerCopyBtn.innerHTML = DOMPurify.sanitize(checkHTML, domPurifyConfig);
                    setTimeout(() => { artifactViewerCopyBtn.innerHTML = originalHTML; }, 1500);
                }).catch(err => showCustomDialog("Error", "Gagal menyalin artifact.", "alert"));
            };
            
            artifactViewerDownloadBtn.onclick = () => {
                downloadArtifact(title, artifactViewerModalBody, isCode, isTable, true);
            };
            
            openModal(artifactViewerModal);
        }
        

        async function downloadImageWithFetch(imageUrlOrDataUrl, promptForFilename, isProcessedCanvas = false) {
            const loadingMessageId = `download-loading-${Date.now()}`;
            const tempMsgElement = addMessageToUI("system-info", `<p id="${loadingMessageId}">Mengunduh gambar...</p>`);
            
            try {
                const safeFilenameBase = (promptForFilename || "generated_image").substring(0, 40).replace(/[^a-z0-9]/gi, '_').toLowerCase();
                let blob;

                if (isProcessedCanvas && imageUrlOrDataUrl.startsWith('data:image/')) { 
                    const fetchRes = await fetch(imageUrlOrDataUrl);
                    blob = await fetchRes.blob();
                } else if (!isProcessedCanvas && typeof imageUrlOrDataUrl === 'string' && (imageUrlOrDataUrl.startsWith('http') || imageUrlOrDataUrl.startsWith('//'))) { 
                    let actualUrlToFetch = imageUrlOrDataUrl;
                    if(actualUrlToFetch.startsWith('//')) actualUrlToFetch = 'https:' + actualUrlToFetch;

                    const response = await fetch(actualUrlToFetch, { mode: 'cors' }); 
                    if (!response.ok) {
                        if (actualUrlToFetch.includes("pollinations.ai") && SCRAPER_PHP_URL && !SCRAPER_PHP_URL.includes("YOUR_SCRAPERWEB_PHP_URL_HERE")) {
                            console.warn(`Fetch CORS gagal untuk ${actualUrlToFetch}, mencoba via proxy...`);
                            const proxyUrl = `${SCRAPER_PHP_URL}?scrape_url=${encodeURIComponent(actualUrlToFetch)}&binary=true`;
                            const proxyResponse = await fetch(proxyUrl);
                            if (!proxyResponse.ok) {
                                throw new Error(`Gagal mengambil gambar via proxy: HTTP ${proxyResponse.status}`);
                            }
                            blob = await proxyResponse.blob();
                        } else {
                            throw new Error(`Gagal mengambil gambar: HTTP ${response.status}`);
                        }
                    } else {
                         blob = await response.blob();
                    }
                } else {
                    throw new Error("URL gambar tidak valid atau tipe tidak dikenali.");
                }
                
                processAndDownloadBlob(blob, safeFilenameBase, tempMsgElement);

            } catch (error) {
                console.error("Error downloading image:", error);
                 if (tempMsgElement && tempMsgElement.closest('.message')) {
                    tempMsgElement.innerHTML = DOMPurify.sanitize(`<p>Error mengunduh: ${error.message}.</p>`, domPurifyConfig);
                 }
            }
        }

        function processAndDownloadBlob(blob, safeFilenameBase, tempMsgElement) {
            let extension = 'png'; 
            const type = blob.type;
            if (type && type.startsWith('image/')) {
                const subType = type.split('/')[1];
                if (['jpeg', 'jpg', 'webp', 'gif', 'png'].includes(subType)) {
                    extension = subType === 'jpeg' ? 'jpg' : subType;
                }
            }
            const filename = `${safeFilenameBase}.${extension}`;
            const linkForDownload = document.createElement('a');
            linkForDownload.href = URL.createObjectURL(blob);
            linkForDownload.download = filename;
            document.body.appendChild(linkForDownload);
            linkForDownload.click();
            document.body.removeChild(linkForDownload);
            URL.revokeObjectURL(linkForDownload.href);

            if (tempMsgElement && tempMsgElement.closest('.message')) {
                 tempMsgElement.innerHTML = DOMPurify.sanitize("<p>Unduhan gambar dimulai.</p>", domPurifyConfig);
                 setTimeout(() => {
                    if (tempMsgElement && tempMsgElement.closest('.message')) tempMsgElement.closest('.message').remove();
                }, 3000);
            }
        }

    </script>
</body>
</html>